/*
 * If not stated otherwise in this file or this component's Licenses.txt file the
 * following copyright and licenses apply:
 *
 * Copyright 2015 RDK Management
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

/**********************************************************************
   Copyright [2014] [Cisco Systems, Inc.]
 
   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at
 
       http://www.apache.org/licenses/LICENSE-2.0
 
   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
**********************************************************************/

/**********************************************************************

    MODULE: asn1_pfx.c

        ASN.1 ANSC Code Generated by Cisco Systems, Inc.

    ---------------------------------------------------------------

    DESCRIPTION:

        The ASN.1 objects implemented in this file

        *   ASN1_PFX
        *   ASN1_MACDATA
        *   ASN1_AUTHENTICATEDSAFE
        *   ASN1_SAFECONTENTS
        *   ASN1_SAFEBAG
        *   ASN1_PKCS12ATTRIBUTES
        *   ASN1_PKCS12ATTRIBUTE
        *   ASN1_KEYBAG
        *   ASN1_PKCS8SHROUDEDKEYBAG
        *   ASN1_CERTBAG
        *   ASN1_CERTVALUE
        *   ASN1_CRLBAG
        *   ASN1_CRLVALUE
        *   ASN1_SECRETBAG
        *   ASN1_BAGVALUE

    ---------------------------------------------------------------

    ENVIRONMENT:

        platform independent

    ---------------------------------------------------------------

    AUTHOR:

        ASNMAGIC ANSC CODE GENERATOR 1.0

    ---------------------------------------------------------------

    REVISION HISTORY:

        *   12/13/2002  initial revision

 **********************************************************************/


#include "al_pkcs12_local.h"

/**********************************************************************

 OBJECT -- ASN1_PFX

 PFX ::= Sequence 
     {
                           version Integer 
                          authSafe ContentInfo 
                           macData MacData OPT
     }

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreatePFX
    (
        ANSC_HANDLE                 hReserved
    )
{
    PANSC_ASN1_PFX                  pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    if( hReserved != NULL)
    {
        pThisObject = (PANSC_ASN1_PFX)
            AnscAsn1CreateSequence
                (
                    hReserved
                );
    }
    else
    {
        pThisObject = (PANSC_ASN1_PFX)
            AnscAsn1CreateSequence
                (
                    (ANSC_HANDLE)sizeof(ANSC_ASN1_PFX)
                );
    }

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject,"ANSC_ASN1_PFX");
    pThisObject->SetName(pThisObject,"PFX");

    pThisObject->Create             = AnscAsn1CreatePFX;
    pThisObject->CreateChildAttr    = AnscAsn1PFXCreateChildAttr;
    pThisObject->GetChildName       = AnscAsn1PFXGetChildName;
    pThisObject->CreateChildObject  = AnscAsn1PFXCreateChildObject;
    pThisObject->GetVersion         = AnscAsn1PFXGetVersion;
    pThisObject->GetAuthSafe        = AnscAsn1PFXGetAuthSafe;
    pThisObject->GetMacData         = AnscAsn1PFXGetMacData;
    pThisObject->uTotalChild        = 3;

    pThisObject->HmacAuthenticate   = AnscAsn1PFXHmacAuthenticate;
    pThisObject->DecryptContent     = AnscAsn1PFXDecrypt;
    pThisObject->EncryptAndSign     = AnscAsn1PFXEncryptAndSign;
    pThisObject->AfterDecoding      = AnscAsn1PFXAfterDecoding;

    pThisObject->EnumerateInfo      = AnscAsn1PFXEnumerateInfo;
    pThisObject->AddCertificate     = AnscAsn1PFXAddCertificate;
    pThisObject->AddCertAndKeyInfo  = AnscAsn1PFXAddCertAndKeyInfo;
    pThisObject->LookforKeyInfoBag  = AnscAsn1PFXLookforKeyInfo;

    /*
     * Create all the children
     */
    pThisObject->CreateAllChildren(pThisObject);

    /*
     * Set BasicSize for Kerberoes impementation, please check GetBAOHandle().
     */
    if( hReserved != NULL )
    {
        pThisObject->uBasicSize         = (ULONG)hReserved;
    }
    else
    {
        pThisObject->uBasicSize         = sizeof(ANSC_ASN1_PFX);
    }

    return (ANSC_HANDLE)pThisObject;
}

ANSC_HANDLE
AnscAsn1PFXCreateChildObject
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    PANSC_ASN1_OBJECT               pThisObject      = NULL;
    PANSC_ASN1_SEQUENCE             pParent          = (PANSC_ASN1_SEQUENCE)hThisObject;

    switch( index )
    {

        case 0:

            pThisObject = AnscAsn1CreateInteger(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));

                /* set the default version as 3 */
                ((PANSC_ASN1_INTEGER)pThisObject)->SetIntegerValue(pThisObject, 3);
            }

            break;

        case 1:

            pThisObject = AnscAsn1CreateContentInfo(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

        case 2:

            pThisObject = AnscAsn1CreateMacData(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
                pThisObject->bCanBeOptional = TRUE;
                pThisObject->bOptional      = TRUE;

            }

            break;

    }

    return pThisObject;

}

PANSC_ATTR_OBJECT
AnscAsn1PFXCreateChildAttr
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    UNREFERENCED_PARAMETER(index);
    return NULL;
}

PCHAR
AnscAsn1PFXGetChildName
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    switch ( index )
    {
        case 0:

            return"version";

        case 1:

            return"authSafe";

        case 2:

            return"macData";

    }

    return "";

}

ANSC_HANDLE
AnscAsn1PFXGetVersion
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_SEQUENCE             pParent          = (PANSC_ASN1_SEQUENCE)hThisObject;

    return pParent->GetChildByIndex(pParent, 0);

}

ANSC_HANDLE
AnscAsn1PFXGetAuthSafe
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_SEQUENCE             pParent          = (PANSC_ASN1_SEQUENCE)hThisObject;

    return pParent->GetChildByIndex(pParent, 1);

}

ANSC_HANDLE
AnscAsn1PFXGetMacData
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_SEQUENCE             pParent          = (PANSC_ASN1_SEQUENCE)hThisObject;

    return pParent->GetChildByIndex(pParent, 2);

}

/*
 *  manually added functions;
 */
ANSC_STATUS
AnscAsn1PFXHmacAuthenticate
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hPKCSUtility,
        PCHAR                       pPassword
    )
{
    PANSC_ASN1_PFX                  pThisObject  = (PANSC_ASN1_PFX)hThisObject;
    PPKCS12_UTILITY_INTERFACE       pPKCS12Util  = (PPKCS12_UTILITY_INTERFACE)hPKCSUtility;
    ANSC_CRYPTO_HASH                hash;
    ANSC_STATUS                     status;
    PANSC_ASN1_CONTENTINFO          pContentInfo;
    PANSC_ASN1_CHOICE               pContent;
    PANSC_ASN1_STRING               pString;
    PANSC_ASN1_STRING               pDigestObj;
    PANSC_ASN1_STRING               pSaltObj;
    PANSC_ASN1_INTEGER              pIteration;
    ULONG                           uIteration;
    PANSC_ASN1_SEQUENCE             pMacDataObj;
    PANSC_ASN1_SEQUENCE             pAlgorObj;

    pContentInfo = (PANSC_ASN1_CONTENTINFO)pThisObject->GetChildByIndex(pThisObject, 1);

    if( pContentInfo == NULL || pPKCS12Util == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pContent = (PANSC_ASN1_CHOICE)pContentInfo->GetChildByIndex(pContentInfo,1);

    if( pContent == NULL || CONTENTDATA_MASK_DATA != pContent->lSelect)
    {
        return ANSC_STATUS_FAILURE;
    }

    pString = (PANSC_ASN1_STRING)pContent->hSelection;

    if( pString == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    /* get the salt and iteration */
    pMacDataObj = (PANSC_ASN1_SEQUENCE)pThisObject->GetChildByIndex(pThisObject,2);

    pSaltObj    = (PANSC_ASN1_STRING)pMacDataObj->GetChildByIndex(pMacDataObj,1);
    pIteration  = (PANSC_ASN1_INTEGER)pMacDataObj->GetChildByIndex(pMacDataObj,2);

    if( pIteration->bOptional)
    {
        uIteration = 1;
    }
    else
    {
        uIteration = pIteration->GetIntegerValue(pIteration);
    }

    /* get the HMAC result */
    status = 
        pPKCS12Util->PKCS12GetHMac
        ( 
            pPKCS12Util,
            HASH_SHA1, 
            pPassword,
            pSaltObj->GetValueBuffer(pSaltObj),
            pSaltObj->uLength,
            uIteration,
            pString->GetValueBuffer(pString),
            pString->uLength,
            &hash
        );

    if(ANSC_STATUS_SUCCESS != status)
    {
        return status;
    }


    /* Get the Verified Digest */
    pAlgorObj   = (PANSC_ASN1_SEQUENCE)pMacDataObj->GetChildByIndex(pMacDataObj,0);
    pDigestObj  = (PANSC_ASN1_STRING)pAlgorObj->GetChildByIndex(pAlgorObj,1);

    if( pDigestObj->uLength == hash.Length &&
        AnscEqualMemory(pDigestObj->GetValueBuffer(pDigestObj), hash.Value, hash.Length))
    {
        return ANSC_STATUS_SUCCESS;
    }

    return ANSC_STATUS_FAILURE;
}


static
ANSC_STATUS
encryptAuthSafe
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hPKCSUtility,
        PCHAR                       pPassword
    )
{
    PANSC_ASN1_PFX                  pThisObject  = (PANSC_ASN1_PFX)hThisObject;
    PPKCS12_UTILITY_INTERFACE       pPKCS12Util  = (PPKCS12_UTILITY_INTERFACE)hPKCSUtility;
    ANSC_STATUS                     status       = ANSC_STATUS_SUCCESS;
    PKCS12_CRYPTO_ALGOR             algorType    = ALG_pbeWithSHAAnd40BitRC2_CBC; /* default encryption algor */
    PANSC_ASN1_SEQUENCE             pExtra;
    PUCHAR                          pEncoding, pBack;
    PUCHAR                          pEncrypt     = NULL;
    LONG                            length;
    ULONG                           uLength;
    PANSC_ASN1_CONTENTINFO          pContentInfo;
    PANSC_ASN1_SAFECONTENTS         pSafeContents;
    PANSC_ASN1_ENCRYPTEDDATA        pEncryptData;
    PANSC_ASN1_ENCRYPTEDCONTENTINFO pEncryptInfo;
    PANSC_ASN1_CHOICE               pContentChoice;
    PANSC_ASN1_ALGORITHMIDENTIFIER  pAlgorObj;
    PANSC_ASN1_SEQUENCE             pPKCS12Param;
    PANSC_ASN1_CHOICE               pParams;
    PANSC_ASN1_STRING               pSaltObj;
    PANSC_ASN1_INTEGER              pIteration;
    ULONG                           uIteration;
    PANSC_ASN1_STRING               pContent;
    PANSC_ASN1_DATA                 pData;

    /* to create PKCS12, we only generate one encrypteddata here */
    pExtra = (PANSC_ASN1_SEQUENCE)pThisObject->GetExtraChild(pThisObject);

    if( pExtra == NULL || pExtra->GetChildCount(pExtra) == 0)
    {
        return ANSC_STATUS_SUCCESS;
    }

    pContentInfo = 
        (PANSC_ASN1_CONTENTINFO)pExtra->GetChildByIndex(pExtra, 0);

    /* encode the safecontents */
    pSafeContents = (PANSC_ASN1_SAFECONTENTS)pContentInfo->GetExtraChild(pContentInfo);

    /* The encryption algorithm requires the content is in 8 blocked */
    length = pSafeContents->GetSizeOfEncoded(pSafeContents);

    if( length <= 0)
    {
        AnscTrace("Not readey to encode.\n");

        return ANSC_STATUS_FAILURE;
    }

    length      = (length / 8 + 1) * 8;
    pEncoding   = (PUCHAR)AnscAllocateMemory(length);

    if( pEncoding == NULL)
    {
        return ANSC_STATUS_RESOURCES;
    }

    pBack = pEncoding;

    status = 
        pSafeContents->EncodingData(pSafeContents, (PVOID*)&pBack);

    if( status != ANSC_STATUS_SUCCESS)
    {
        AnscFreeMemory(pEncoding);

        return status;

    }

    /* init the algorithm and salt */
    pContentChoice = 
        (PANSC_ASN1_CHOICE)pContentInfo->GetChildByIndex(pContentInfo, 1);

    pEncryptData = 
        (PANSC_ASN1_ENCRYPTEDDATA)pContentChoice->hSelection;

    pEncryptInfo = 
        (PANSC_ASN1_ENCRYPTEDCONTENTINFO)pEncryptData->GetChildByIndex(pEncryptData, 1);

    pAlgorObj = 
        (PANSC_ASN1_ALGORITHMIDENTIFIER)pEncryptInfo->GetChildByIndex(pEncryptInfo, 1);

    pParams     = (PANSC_ASN1_CHOICE)pAlgorObj->GetChildByIndex(pAlgorObj, 1);
    pPKCS12Param= (PANSC_ASN1_SEQUENCE)pParams->hSelection;

    pSaltObj    = (PANSC_ASN1_STRING)pPKCS12Param->GetChildByIndex(pPKCS12Param,0);
    pIteration  = (PANSC_ASN1_INTEGER)pPKCS12Param->GetChildByIndex(pPKCS12Param,1);

    if(pIteration->bOptional)
    {
        uIteration = 1;
    }
    else
    {
        uIteration = pIteration->GetIntegerValue(pIteration);
    }

    /* allocate memory for the decrypted data */
    uLength  = length;
    pEncrypt = (PUCHAR)AnscAllocateMemory(uLength);

    if( pEncrypt == NULL)
    {
        status = ANSC_STATUS_FAILURE;

        goto EXIT;
    }

    pPKCS12Util->PKCS12Encrypt
        (
            pPKCS12Util,
            algorType,
            pPassword,
            pSaltObj->GetValueBuffer(pSaltObj),
            pSaltObj->uLength,
            uIteration,
            pEncoding,
            length,
            pEncrypt,
            &uLength
        );

    /* set the value to the content object */
    pContent = (PANSC_ASN1_STRING)pEncryptInfo->GetChildByIndex(pEncryptInfo, 2);

    pContent->SetStringValue(pContent, pEncrypt, uLength);

    if( pEncoding != NULL)
    {
        AnscFreeMemory(pEncoding);
    }

    /* encode the whole authsafe and set it in the content */
    pEncoding = pExtra->GetEncodedData(pExtra, (PULONG)&length);

    if( pEncoding == NULL)
    {
        status = ANSC_STATUS_FAILURE;

        goto EXIT;
    }

    pContentInfo = (PANSC_ASN1_CONTENTINFO)pThisObject->GetChildByIndex(pThisObject, 1);
    pData = (PANSC_ASN1_DATA)AnscAsn1CreateData(NULL);
    pData->SetStringValue(pData, pEncoding, length);

    pContentInfo->SetTypeAndData
        (
            pContentInfo,
            CONTENTDATA_MASK_DATA,
            pData
        );

EXIT:

    if( pEncoding != NULL)
    {
        AnscFreeMemory(pEncoding);
    }

    if( pEncrypt != NULL)
    {
        AnscFreeMemory(pEncrypt);
    }

    return status;
}

ANSC_STATUS
AnscAsn1PFXEncryptAndSign
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hPKCSUtility,
        PCHAR                       pPassword
    )
{
    PANSC_ASN1_PFX                  pThisObject  = (PANSC_ASN1_PFX)hThisObject;
    PPKCS12_UTILITY_INTERFACE       pPKCS12Util  = (PPKCS12_UTILITY_INTERFACE)hPKCSUtility;
    ANSC_STATUS                     status       = ANSC_STATUS_SUCCESS;
    ANSC_CRYPTO_HASH                hash;
    PANSC_ASN1_CONTENTINFO          pContentInfo;
    PANSC_ASN1_CHOICE               pContent;
    PANSC_ASN1_STRING               pString;
    PANSC_ASN1_STRING               pDigestObj;
    PANSC_ASN1_STRING               pSaltObj;
    PANSC_ASN1_INTEGER              pIteration;
    ULONG                           uIteration;
    PANSC_ASN1_SEQUENCE             pMacDataObj;
    PANSC_ASN1_ALGORITHMIDENTIFIER  pAlgorObj;
    PANSC_ASN1_SEQUENCE             pDigestAlg;
    PANSC_ASN1_OBJECT               pParam;
    UCHAR                           pSalt[12];

    /* encode the authenticatedsafe */
    status = encryptAuthSafe( pThisObject, hPKCSUtility, pPassword);

    if( status != ANSC_STATUS_SUCCESS)
    {
        return status;
    }

    /* generate the HMAC */
    pContentInfo = (PANSC_ASN1_CONTENTINFO)pThisObject->GetChildByIndex(pThisObject, 1);

    if( pContentInfo == NULL || pPKCS12Util == NULL)
    {
        status = ANSC_STATUS_FAILURE;

        goto EXIT;
    }

    pContent = (PANSC_ASN1_CHOICE)pContentInfo->GetChildByIndex(pContentInfo,1);

    if( pContent == NULL || CONTENTDATA_MASK_DATA != pContent->lSelect)
    {
        status = ANSC_STATUS_FAILURE;

        goto EXIT;
    }

    pString = (PANSC_ASN1_STRING)pContent->hSelection;

    if( pString == NULL || pString->uLength == 0)
    {
        status = ANSC_STATUS_FAILURE;

        goto EXIT;
    }

    /* Set the salt and iteration */
    pMacDataObj = (PANSC_ASN1_SEQUENCE)pThisObject->GetChildByIndex(pThisObject,2);
    pMacDataObj->bOptional = FALSE;

    pSaltObj    = (PANSC_ASN1_STRING)pMacDataObj->GetChildByIndex(pMacDataObj,1);
    pIteration  = (PANSC_ASN1_INTEGER)pMacDataObj->GetChildByIndex(pMacDataObj,2);

    /* set random salt value */    
    AnscWriteUlong((PUCHAR)pSalt, (ULONG)pString->GetValueBuffer(pString));
    AnscWriteUlong((PUCHAR)(pSalt + 4), (ULONG)hThisObject);
    pSaltObj->SetStringValue(pSaltObj, pSalt, 8);

    uIteration  = 2000;
    pIteration->SetIntegerValue(pIteration, uIteration);

    /* get the HMAC result */
    status = 
        pPKCS12Util->PKCS12GetHMac
        ( 
            pPKCS12Util,
            HASH_SHA1, 
            pPassword,
            pSaltObj->GetValueBuffer(pSaltObj),
            pSaltObj->uLength,
            uIteration,
            pString->GetValueBuffer(pString),
            pString->uLength,
            &hash
        );

    if(ANSC_STATUS_SUCCESS != status)
    {
        goto EXIT;
    }

    /* Set the digest */
    pDigestAlg  = (PANSC_ASN1_SEQUENCE)pMacDataObj->GetChildByIndex(pMacDataObj,0);
    pAlgorObj   = (PANSC_ASN1_ALGORITHMIDENTIFIER)pDigestAlg->GetChildByIndex(pDigestAlg,0);
    pDigestObj  = (PANSC_ASN1_STRING)pDigestAlg->GetChildByIndex(pDigestAlg,1);

    /* set sha1 digest */
    pAlgorObj->SetAlgorOIDStringValue(pAlgorObj,"1.3.14.3.2.26");
    pParam = (PANSC_ASN1_OBJECT)pAlgorObj->GetChildByIndex(pAlgorObj, 1);
    pParam->bOptional = FALSE;
    pDigestObj->SetStringValue(pDigestObj, hash.Value, hash.Length);

EXIT:

    return status;
}

ANSC_STATUS
AnscAsn1PFXDecrypt
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hPKCSUtility,
        PCHAR                       pPassword
    )
{
    PANSC_ASN1_PFX                  pThisObject  = (PANSC_ASN1_PFX)hThisObject;
    PPKCS12_UTILITY_INTERFACE       pPKCS12Util  = (PPKCS12_UTILITY_INTERFACE)hPKCSUtility;
    PANSC_ASN1_AUTHENTICATEDSAFE    pAuthSafeObj;

    if( pThisObject == NULL || pPKCS12Util == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pAuthSafeObj = 
        (PANSC_ASN1_AUTHENTICATEDSAFE)pThisObject->GetExtraChild(pThisObject);

    if( pAuthSafeObj == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    return pAuthSafeObj->DecryptContent(pAuthSafeObj, hPKCSUtility, pPassword);
}

ANSC_STATUS
AnscAsn1PFXAfterDecoding
    (
        ANSC_HANDLE                 hThisObject,
        PVOID*                      ppEncoding
    )
{
    UNREFERENCED_PARAMETER(ppEncoding);
    PANSC_ASN1_PFX                  pThisObject  = (PANSC_ASN1_PFX)hThisObject;
    ANSC_STATUS                     status;
    PANSC_ASN1_CONTENTINFO          pContentInfo;
    PANSC_ASN1_CHOICE               pContent;
    PANSC_ASN1_STRING               pString;
    PANSC_ASN1_AUTHENTICATEDSAFE    pAuthSafeObj;
    PUCHAR                          pEncoding;

    pContentInfo = (PANSC_ASN1_CONTENTINFO)pThisObject->GetChildByIndex(pThisObject, 1);

    if( pContentInfo == NULL )
    {
        return ANSC_STATUS_FAILURE;
    }

    pContent = (PANSC_ASN1_CHOICE)pContentInfo->GetChildByIndex(pContentInfo,1);

    if( pContent == NULL || CONTENTDATA_MASK_DATA != pContent->lSelect)
    {
        return ANSC_STATUS_FAILURE;
    }

    pString = (PANSC_ASN1_STRING)pContent->hSelection;

    if( pString == NULL || pString->uLength == 0)
    {
        return ANSC_STATUS_FAILURE;
    }

    pAuthSafeObj = (PANSC_ASN1_AUTHENTICATEDSAFE)
        AnscAsn1CreateAuthenticatedSafe(NULL);

    if( pAuthSafeObj == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pEncoding = (PUCHAR)pString->GetValueBuffer(pString);

    status = pAuthSafeObj->DecodingData(pAuthSafeObj, (PVOID*)&pEncoding);

    if( status != ANSC_STATUS_SUCCESS)
    {
        pAuthSafeObj->AsnFree(pAuthSafeObj);

        return status;
    }

    pThisObject->SetExtraChild(pThisObject, pAuthSafeObj, TRUE);

    return ANSC_STATUS_SUCCESS;

}

ANSC_STATUS
AnscAsn1PFXEnumerateInfo
    (
        ANSC_HANDLE                 hThisObject,
        PFN_ENUM_CERT_KEY_PROC      proc,
        ANSC_HANDLE                 hContext
    )
{
    PANSC_ASN1_PFX                  pThisObject  = (PANSC_ASN1_PFX)hThisObject;
    ANSC_STATUS                     status       = ANSC_STATUS_SUCCESS;
    PANSC_ASN1_SEQUENCEOF           pAuthSafe;
    PANSC_ASN1_SEQUENCE             pContentInfo;
    PANSC_ASN1_SEQUENCEOF           pSafeContents;
    PANSC_ASN1_SAFEBAG              pSafeBag;
    ANSC_HANDLE                     hLocalID;
    PANSC_ASN1_PRIVATEKEYINFO       pKeyInfo;
    ULONG                           i, j;
    PANSC_ASN1_STRING               pCertObj;
    PANSC_ASN1_CERTBAG              pCertBag;
    PUCHAR                          pKeyEncoding = NULL;
    ULONG                           ulKeySize    = 0;

    if( proc == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pAuthSafe = (PANSC_ASN1_SEQUENCEOF)pThisObject->GetExtraChild(pThisObject);

    if( pAuthSafe == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    for( i = 0; i < pAuthSafe->GetChildCount(pAuthSafe); i ++)
    {
        pContentInfo = (PANSC_ASN1_SEQUENCE)pAuthSafe->GetChildByIndex(pAuthSafe, i);

        if( pContentInfo != NULL)
        {
            pSafeContents = 
                (PANSC_ASN1_SEQUENCEOF)pContentInfo->GetExtraChild(pContentInfo);

            if( pSafeContents != NULL)
            {
                for( j = 0;  j < pSafeContents->GetChildCount(pSafeContents); j ++)
                {
                    pSafeBag = 
                        (PANSC_ASN1_SAFEBAG)pSafeContents->GetChildByIndex(pSafeContents, j);

                    if( pSafeBag != NULL && pSafeBag->IsCertBag(pSafeBag))
                    {
                        pCertBag = 
                            (PANSC_ASN1_CERTBAG)pSafeBag->GetValueHandle(pSafeBag);

                        pCertObj = 
                            (PANSC_ASN1_STRING)pCertBag->GetCertObject(pCertBag);

                        /* lookfor the private key info */
                        hLocalID = pSafeBag->GetLocalKeyIDObj(pSafeBag);
                        pKeyInfo = pThisObject->LookforKeyInfoBag(pThisObject, hLocalID);

                        if( pKeyInfo != NULL)
                        {
                            /* enumerate both cert and key info */
                            pKeyEncoding = pKeyInfo->GetEncodedData(pKeyInfo, &ulKeySize);                            
                        }

                        status = 
                            proc
                                (
                                    hContext,
                                    pCertObj->GetValueBuffer(pCertObj),
                                    pCertObj->uLength,
                                    pKeyEncoding,
                                    ulKeySize
                                );

                        if( pKeyEncoding != NULL)
                        {
                            AnscFreeMemory(pKeyEncoding);

                            pKeyEncoding = NULL;
                            ulKeySize    = 0;
                        }

                        if( status != ANSC_STATUS_SUCCESS)
                        {
                            return status;
                        }
                    }
                }
            }
        }
    }

    return status;
}

static
ANSC_HANDLE
createPKCS12ExtraAuthenSafe
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_PFX                  pThisObject  = (PANSC_ASN1_PFX)hThisObject;
    PANSC_ASN1_AUTHENTICATEDSAFE    pAuthSafeObj = NULL;
    PANSC_ASN1_CONTENTINFO          pContentInfo = NULL;
    PANSC_ASN1_ENCRYPTEDDATA        pEncryptData = NULL;
    PANSC_ASN1_ENCRYPTEDCONTENTINFO pEncContInfo = NULL;
    PANSC_ASN1_OIDEN                pOIDObj = NULL;
    PANSC_ASN1_ALGORITHMIDENTIFIER  pAlgorObj = NULL;
    PANSC_ASN1_STRING               pSaltObj = NULL;
    PANSC_ASN1_SEQUENCE             pPKCS12Param = NULL;
    PANSC_ASN1_CHOICE               pParams = NULL;
    PANSC_ASN1_INTEGER              pIteration = NULL;
    UCHAR                           pSalt[12] = {0};

    pAuthSafeObj = (PANSC_ASN1_AUTHENTICATEDSAFE)
        AnscAsn1CreateAuthenticatedSafe(NULL);

    if( pAuthSafeObj == NULL)
    {
        return NULL;
    }

    /* create and add a content info */
    pContentInfo = (PANSC_ASN1_CONTENTINFO)AnscAsn1CreateContentInfo(NULL);

    /* set the content info as encryptedData */
    pEncryptData = 
        (PANSC_ASN1_ENCRYPTEDDATA)AnscAsn1CreateEncryptedData(NULL);

    /*RDKB-6191, CID-24242, null check before use*/
    if( pContentInfo != NULL)
    {
        pAuthSafeObj->AddChild(pAuthSafeObj, pContentInfo);
        pContentInfo->SetTypeAndData
            (
                pContentInfo,
                CONTENTDATA_MASK_ENCRYPTEDDATA,
                pEncryptData
            );
    }
    /* init the encrypted content info */
    pEncContInfo = 
        (PANSC_ASN1_ENCRYPTEDCONTENTINFO)pEncryptData->GetChildByIndex(pEncryptData,1);

    pOIDObj = 
        (PANSC_ASN1_OIDEN)pEncContInfo->GetChildByIndex(pEncContInfo, 0);

    /* set as data */
    pOIDObj->SetStringOIDValue(pOIDObj, "1.2.840.113549.1.7.1");

    /* init the algorithm */
    pAlgorObj = 
        (PANSC_ASN1_ALGORITHMIDENTIFIER)pEncContInfo->GetChildByIndex(pEncContInfo,1);

    /* set algor "ALG_pbeWithSHAAnd40BitRC2_CBC" */
    pAlgorObj->SetAlgorOIDStringValue(pAlgorObj, "1.2.840.113549.1.12.1.6");

    /* init the parameters */
    pParams     = (PANSC_ASN1_CHOICE)pAlgorObj->GetChildByIndex(pAlgorObj, 1);
    pPKCS12Param= (PANSC_ASN1_SEQUENCE)pParams->hSelection;

    pSaltObj    = (PANSC_ASN1_STRING)pPKCS12Param->GetChildByIndex(pPKCS12Param,0);
    pIteration  = (PANSC_ASN1_INTEGER)pPKCS12Param->GetChildByIndex(pPKCS12Param,1);

    /* set iteration as 2000 */
    pIteration->SetIntegerValue(pIteration, 2000);

    /* set random salt value */    
    AnscWriteUlong((PUCHAR)pSalt, (ULONG)pIteration);
    AnscWriteUlong((PUCHAR)(pSalt + 4), (ULONG)hThisObject);
    pSaltObj->SetStringValue(pSaltObj, pSalt, 8);

    pThisObject->SetExtraChild(pThisObject, pAuthSafeObj, TRUE);

    return pAuthSafeObj;
}


ANSC_STATUS
AnscAsn1PFXAddCertificate
    (
        ANSC_HANDLE                 hThisObject,
        PUCHAR                      pEncoding,
        ULONG                       ulSize
    )
{
    PANSC_ASN1_PFX                  pThisObject  = (PANSC_ASN1_PFX)hThisObject;
    PANSC_ASN1_AUTHENTICATEDSAFE    pAuthSafe;
    PANSC_ASN1_CONTENTINFO          pContentInfo;
    PANSC_ASN1_SAFECONTENTS         pSafeContents;
    PANSC_ASN1_SAFEBAG              pSafeBag;
    ANSC_STATUS                     status;

    pAuthSafe = 
        (PANSC_ASN1_AUTHENTICATEDSAFE)pThisObject->GetExtraChild(pThisObject);

    if( pAuthSafe == NULL)
    {
        pAuthSafe = 
            (PANSC_ASN1_AUTHENTICATEDSAFE)createPKCS12ExtraAuthenSafe(pThisObject);
    }

    if( pAuthSafe == NULL)
    {
        AnscTrace("Failed to create the extra child for PKCS12.\n");

        return ANSC_STATUS_FAILURE;
    }

    pContentInfo = 
        (PANSC_ASN1_CONTENTINFO)pAuthSafe->GetChildByIndex(pAuthSafe, 0);

    pSafeContents = 
        (PANSC_ASN1_SAFECONTENTS)pContentInfo->GetExtraChild(pContentInfo);

    if( pSafeContents == NULL)
    {
        pSafeContents = (PANSC_ASN1_SAFECONTENTS)AnscAsn1CreateSafeContents(NULL);

        pContentInfo->SetExtraChild(pContentInfo, pSafeContents, TRUE);
    }

    /* create and add the safe bag */
    pSafeBag = 
        (PANSC_ASN1_SAFEBAG)AnscAsn1CreateSafeBag(NULL);

    status = pSafeBag->SetCertInfo(pSafeBag, pEncoding, ulSize);

    if( ANSC_STATUS_SUCCESS != status)
    {
        pSafeBag->AsnFree(pSafeBag);
    }
    else
    {
        pSafeContents->AddChild(pSafeContents, pSafeBag);
    }

    return status;
}

ANSC_STATUS
AnscAsn1PFXAddCertAndKeyInfo
    (
        ANSC_HANDLE                 hThisObject,
        PUCHAR                      pCertEncoding,
        ULONG                       ulCertSize,
        PUCHAR                      pKeyEncoding,
        ULONG                       ulKeyInfoSize
    )
{
    PANSC_ASN1_PFX                  pThisObject  = (PANSC_ASN1_PFX)hThisObject;
    PANSC_ASN1_AUTHENTICATEDSAFE    pAuthSafe;
    PANSC_ASN1_CONTENTINFO          pContentInfo;
    PANSC_ASN1_SAFECONTENTS         pSafeContents;
    PANSC_ASN1_SAFEBAG              pSafeBag;
    ANSC_STATUS                     status;
    ULONG                           uLocalBase   = 3000;

    pAuthSafe = 
        (PANSC_ASN1_AUTHENTICATEDSAFE)pThisObject->GetExtraChild(pThisObject);

    if( pAuthSafe == NULL)
    {
        pAuthSafe = 
            (PANSC_ASN1_AUTHENTICATEDSAFE)createPKCS12ExtraAuthenSafe(pThisObject);
    }

    if( pAuthSafe == NULL)
    {
        AnscTrace("Failed to create the extra child for PKCS12.\n");

        return ANSC_STATUS_FAILURE;
    }

    pContentInfo = 
        (PANSC_ASN1_CONTENTINFO)pAuthSafe->GetChildByIndex(pAuthSafe, 0);

    pSafeContents = 
        (PANSC_ASN1_SAFECONTENTS)pContentInfo->GetExtraChild(pContentInfo);

    if( pSafeContents == NULL)
    {
        pSafeContents = (PANSC_ASN1_SAFECONTENTS)AnscAsn1CreateSafeContents(NULL);

        pContentInfo->SetExtraChild(pContentInfo, pSafeContents, TRUE);
    }

    uLocalBase += pSafeContents->GetChildCount(pSafeContents);

    /* create and add the cert safe bag */
    pSafeBag = 
        (PANSC_ASN1_SAFEBAG)AnscAsn1CreateSafeBag(NULL);

    status = pSafeBag->SetCertInfo(pSafeBag, pCertEncoding, ulCertSize);

    if( ANSC_STATUS_SUCCESS != status)
    {
        pSafeBag->AsnFree(pSafeBag);

        goto EXIT;
    }
    else
    {
        pSafeContents->AddChild(pSafeContents, pSafeBag);
        pSafeBag->SetLocalKeyID(pSafeBag, uLocalBase);
    }

    /* create and add the key safe bag */
    pSafeBag = 
        (PANSC_ASN1_SAFEBAG)AnscAsn1CreateSafeBag(NULL);

    status = pSafeBag->SetKeyInfo(pSafeBag, pKeyEncoding, ulKeyInfoSize);

    if( ANSC_STATUS_SUCCESS != status)
    {
        pSafeBag->AsnFree(pSafeBag);
    }
    else
    {
        pSafeContents->AddChild(pSafeContents, pSafeBag);
        pSafeBag->SetLocalKeyID(pSafeBag, uLocalBase);
    }

EXIT:

    return status;

}

ANSC_HANDLE
AnscAsn1PFXLookforKeyInfo
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hLocalKeyID
    )
{
    PANSC_ASN1_PFX                  pThisObject  = (PANSC_ASN1_PFX)hThisObject;
    PANSC_ASN1_STRING               pLocalKeyId  = (PANSC_ASN1_STRING)hLocalKeyID;
    ANSC_HANDLE                     hLocalID;
    PANSC_ASN1_SEQUENCEOF           pAuthSafe;
    PANSC_ASN1_SEQUENCE             pContentInfo;
    PANSC_ASN1_SEQUENCEOF           pSafeContents;
    PANSC_ASN1_SAFEBAG              pSafeBag;
    ULONG                           i, j;

    if( hLocalKeyID == NULL)
    {
        return NULL;
    }

    pAuthSafe = (PANSC_ASN1_SEQUENCEOF)pThisObject->GetExtraChild(pThisObject);

    if( pAuthSafe == NULL)
    {
        return NULL;
    }

    for( i = 0; i < pAuthSafe->GetChildCount(pAuthSafe); i ++)
    {
        pContentInfo = (PANSC_ASN1_SEQUENCE)pAuthSafe->GetChildByIndex(pAuthSafe, i);

        if( pContentInfo != NULL)
        {
            pSafeContents = 
                (PANSC_ASN1_SEQUENCEOF)pContentInfo->GetExtraChild(pContentInfo);

            if( pSafeContents != NULL)
            {
                for( j = 0;  j < pSafeContents->GetChildCount(pSafeContents); j ++)
                {
                    pSafeBag = 
                        (PANSC_ASN1_SAFEBAG)pSafeContents->GetChildByIndex(pSafeContents, j);

                    if( pSafeBag != NULL) 
                    {
                        if( pSafeBag->IsKeyInfoBag(pSafeBag, TRUE)  ||
                            pSafeBag->IsKeyInfoBag(pSafeBag, FALSE))
                        {
                            /* check the local id */
                            hLocalID = pSafeBag->GetLocalKeyIDObj(pSafeBag);

                            if( pLocalKeyId->EqualsTo(pLocalKeyId, hLocalID, TRUE))
                            {
                                /* return the private key info */
                                if( pSafeBag->IsKeyInfoBag(pSafeBag, TRUE))
                                {
                                    /* encrypted */
                                    return pSafeBag->GetExtraChild(pSafeBag);
                                }
                                else
                                {
                                    return pSafeBag->GetValueHandle(pSafeBag);
                                }
                            }
                        }
                    }
                }
            }
        }
    }


    return NULL;
}

/**********************************************************************

 OBJECT -- ASN1_MACDATA

 MacData ::= Sequence 
     {
                               mac DigestInfo 
                           macSalt OctetString 
                        iterations Integer DEF
     }

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreateMacData
    (
        ANSC_HANDLE                 hReserved
    )
{
    PANSC_ASN1_MACDATA              pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    if( hReserved != NULL)
    {
        pThisObject = (PANSC_ASN1_MACDATA)
            AnscAsn1CreateSequence
                (
                    hReserved
                );
    }
    else
    {
        pThisObject = (PANSC_ASN1_MACDATA)
            AnscAsn1CreateSequence
                (
                    (ANSC_HANDLE)sizeof(ANSC_ASN1_MACDATA)
                );
    }

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject,"ANSC_ASN1_MACDATA");
    pThisObject->SetName(pThisObject,"MacData");

    pThisObject->Create             = AnscAsn1CreateMacData;
    pThisObject->CreateChildAttr    = AnscAsn1MacDataCreateChildAttr;
    pThisObject->GetChildName       = AnscAsn1MacDataGetChildName;
    pThisObject->CreateChildObject  = AnscAsn1MacDataCreateChildObject;
    pThisObject->uTotalChild        = 3;

    /*
     * Create all the children
     */
    pThisObject->CreateAllChildren(pThisObject);


    /*
     * Set BasicSize for Kerberoes impementation, please check GetBAOHandle().
     */
    if( hReserved != NULL )
    {
        pThisObject->uBasicSize         = (ULONG)hReserved;
    }
    else
    {
        pThisObject->uBasicSize         = sizeof(ANSC_ASN1_MACDATA);
    }

    return (ANSC_HANDLE)pThisObject;
}

ANSC_HANDLE
AnscAsn1MacDataCreateChildObject
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    PANSC_ASN1_OBJECT               pThisObject      = NULL;
    PANSC_ASN1_SEQUENCE             pParent          = (PANSC_ASN1_SEQUENCE)hThisObject;

    switch( index )
    {

        case 0:

            pThisObject = AnscAsn1CreateDigestInfo(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

        case 1:

            pThisObject = AnscAsn1CreateOctetString(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

        case 2:

            pThisObject = AnscAsn1CreateInteger(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
                pThisObject->bCanBeOptional = TRUE;
                pThisObject->bOptional      = TRUE;

                ((PANSC_ASN1_INTEGER)pThisObject)->SetIntegerValue(pThisObject, 1);
            }

            break;

    }

    return pThisObject;

}

PANSC_ATTR_OBJECT
AnscAsn1MacDataCreateChildAttr
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    UNREFERENCED_PARAMETER(index);
    PANSC_ATTR_OBJECT               pAttrObject  = NULL;

    return pAttrObject;

}

PCHAR
AnscAsn1MacDataGetChildName
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    switch ( index )
    {
        case 0:

            return"mac";

        case 1:

            return"macSalt";

        case 2:

            return"iterations";

    }

    return "";

}


/**********************************************************************

 OBJECT -- ASN1_AUTHENTICATEDSAFE

 AuthenticatedSafe ::= SequenceOf ContentInfo  {}

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreateAuthenticatedSafe
    (
        ANSC_HANDLE                 hReserved
    )
{
    PANSC_ASN1_AUTHENTICATEDSAFE    pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    if( hReserved != NULL)
    {
        pThisObject = (PANSC_ASN1_AUTHENTICATEDSAFE)
            AnscAsn1CreateSequenceOf
                (
                    hReserved
                );
    }
    else
    {
        pThisObject = (PANSC_ASN1_AUTHENTICATEDSAFE)
            AnscAsn1CreateSequenceOf
                (
                    (ANSC_HANDLE)sizeof(ANSC_ASN1_AUTHENTICATEDSAFE)
                );
    }

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject,"ANSC_ASN1_AUTHENTICATEDSAFE");
    pThisObject->SetName(pThisObject,"AuthenticatedSafe");

    pThisObject->Create             = AnscAsn1CreateAuthenticatedSafe;
    pThisObject->CreateChild        = AnscAsn1AuthenticatedSafeCreateChild;
    pThisObject->IsChildValid       = AnscAsn1AuthenticatedSafeIsChildValid;
    pThisObject->DecryptContent     = AnscAsn1AuthenticatedSafeDecryptContent;

    /*
     * Set BasicSize for Kerberoes impementation, please check GetBAOHandle().
     */
    if( hReserved != NULL )
    {
        pThisObject->uBasicSize         = (ULONG)hReserved;
    }
    else
    {
        pThisObject->uBasicSize         = sizeof(ANSC_ASN1_AUTHENTICATEDSAFE);
    }

    return (ANSC_HANDLE)pThisObject;
}

ANSC_HANDLE
AnscAsn1AuthenticatedSafeCreateChild
    (
        ANSC_HANDLE                 hThisObject,
        BOOLEAN                     bAddItIn
    )
{
    PANSC_ASN1_SETOF                pParentObj   = (PANSC_ASN1_SETOF)hThisObject;
    PANSC_ASN1_OBJECT               pThisObject  = NULL;

    pThisObject  = AnscAsn1CreateContentInfo(NULL);

    if( pThisObject != NULL && bAddItIn)
    {
        pParentObj->AddChild(pParentObj,pThisObject);
    }

    return pThisObject;
}

ANSC_STATUS
AnscAsn1AuthenticatedSafeIsChildValid
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hChild
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    PANSC_ASN1_OBJECT               pChild    = (PANSC_ASN1_OBJECT)hChild;

    if( pChild == NULL)
    {
        return ANSC_ASN1_NULL_OBJCET;
    }

    if( !AnscEqualString1(pChild->ClassName, "ANSC_ASN1_CONTENTINFO", TRUE))
    {
        return ANSC_ASN1_INVALID_TYPE_IN_SEQOF_OR_SETOF;
    }

    return ANSC_STATUS_SUCCESS;
}

/*
 *  static functions are used to decrypt the info;
 */
static PKCS12_CRYPTO_ALGOR
getPKCS12EncryptAlgor
    (
        PANSC_ASN1_ALGORITHMIDENTIFIER  pAlgor     
    )
{
    PANSC_ASN1_OIDEN                    pOIDObj;
    CHAR                                pOIDString[128] = { 0 };

    pOIDObj = (PANSC_ASN1_OIDEN)pAlgor->GetChildByIndex(pAlgor, 0);

    pOIDObj->GetStringOIDValue( pOIDObj,pOIDString);

    if( AnscEqualString1(pOIDString,"1.2.840.113549.1.12.1.1",FALSE))
    {
        return ALG_pbeWithSHAAnd128BitRC4;
    }
    else if( AnscEqualString1(pOIDString,"1.2.840.113549.1.12.1.2",FALSE))
    {
        return ALG_pbeWithSHAAnd40BitRC4;
    }
    else if( AnscEqualString1(pOIDString,"1.2.840.113549.1.12.1.3",FALSE))
    {
        return ALG_pbeWithSHAAnd3KeyTripleDES_CBC;
    }
    else if( AnscEqualString1(pOIDString,"1.2.840.113549.1.12.1.4",FALSE))
    {
        return ALG_pbeWithSHAAnd2KeyTripleDES_CBC;
    }
    else if( AnscEqualString1(pOIDString,"1.2.840.113549.1.12.1.5",FALSE))
    {
        return ALG_pbeWithSHAAnd128BitRC2_CBC;
    }
    else if( AnscEqualString1(pOIDString,"1.2.840.113549.1.12.1.6",FALSE))
    {
        return ALG_pbeWithSHAAnd40BitRC2_CBC;
    }
    else if( AnscEqualString1(pOIDString,"1.2.840.113549.1.5.1",FALSE))
    {
        return ALG_pbeWithMD2AndDES_CBC;
    }
    else if( AnscEqualString1(pOIDString,"1.2.840.113549.1.5.3",FALSE))
    {
        return ALG_pbeWithMD5AndDES_CBC;
    }
    else if( AnscEqualString1(pOIDString,"1.2.840.113549.1.5.4",FALSE))
    {
        return ALG_pbeWithMD2AndRC2_CBC;
    }
    else if( AnscEqualString1(pOIDString,"1.2.840.113549.1.5.6",FALSE))
    {
        return ALG_pbeWithMD5AndRC2_CBC;
    }
    else if( AnscEqualString1(pOIDString,"1.2.840.113549.1.5.10",FALSE))
    {
        return ALG_pbeWithSHA1AndDES_CBC;
    }
    else if( AnscEqualString1(pOIDString,"1.2.840.113549.1.5.11",FALSE))
    {
        return ALG_pbeWithSHA1AndRC2_CBC;
    }

    return ALG_RESERVED;
}

static ANSC_HANDLE
decryptPrivateKeyInfo
    (
        ANSC_HANDLE                 hEncryptKeyInfo,
        ANSC_HANDLE                 hPKCSUtility,
        PCHAR                       pPassword
    )
{
    PANSC_ASN1_ENCRYPTEDPRIVATEKEYINFO
                                    pEncryptKey; 
    PPKCS12_UTILITY_INTERFACE       pPKCS12Util     = (PPKCS12_UTILITY_INTERFACE)hPKCSUtility;
    PANSC_ASN1_PRIVATEKEYINFO       pKeyInfo        = NULL;
    PUCHAR                          pDecrypt        = NULL;
    ULONG                           uIteration      = 1;
    PUCHAR                          pEncoding;
    PANSC_ASN1_ALGORITHMIDENTIFIER  pAlgorObj;
    ULONG                           uLength;
    PANSC_ASN1_INTEGER              pIteration;
    PANSC_ASN1_STRING               pSaltObj;
    PANSC_ASN1_STRING               pOctetObj;
    PANSC_ASN1_SEQUENCE             pPKCS12Param;
    PANSC_ASN1_CHOICE               pParams;
    ANSC_STATUS                     status;
    PKCS12_CRYPTO_ALGOR             algorType;

    pEncryptKey = (PANSC_ASN1_ENCRYPTEDPRIVATEKEYINFO)hEncryptKeyInfo;

    pAlgorObj = 
        (PANSC_ASN1_ALGORITHMIDENTIFIER)pEncryptKey->GetChildByIndex(pEncryptKey, 0);

    pOctetObj = 
        (PANSC_ASN1_STRING)pEncryptKey->GetChildByIndex(pEncryptKey, 1);

    if( pAlgorObj == NULL || pOctetObj == NULL || pOctetObj->uLength == 0)
    {
        return pKeyInfo;
    }

    algorType = getPKCS12EncryptAlgor(pAlgorObj);

    if( algorType == ALG_RESERVED)
    {
        AnscTrace("Unsupported PKCS12 encryption algorithm.\n");

        return pKeyInfo;
    }

    pParams     = (PANSC_ASN1_CHOICE)pAlgorObj->GetChildByIndex(pAlgorObj, 1);
    pPKCS12Param= (PANSC_ASN1_SEQUENCE)pParams->hSelection;

    if( pPKCS12Param == NULL)
    {
        return pKeyInfo;
    }

    pSaltObj    = (PANSC_ASN1_STRING)pPKCS12Param->GetChildByIndex(pPKCS12Param,0);
    pIteration  = (PANSC_ASN1_INTEGER)pPKCS12Param->GetChildByIndex(pPKCS12Param,1);

    if(!pIteration->bOptional)
    {
        uIteration = pIteration->GetIntegerValue(pIteration);
    }

    /* allocate memory for the decrypted data */
    uLength  = pOctetObj->uLength + 8;
    pDecrypt = (PUCHAR)AnscAllocateMemory(uLength);

    if( pDecrypt == NULL)
    {
        return pKeyInfo;
    }

    pPKCS12Util->PKCS12Decrypt
        (
            pPKCS12Util,
            algorType,
            pPassword,
            pSaltObj->GetValueBuffer(pSaltObj),
            pSaltObj->uLength,
            uIteration,
            pOctetObj->GetValueBuffer(pOctetObj),
            pOctetObj->uLength,
            pDecrypt,
            &uLength
        );

    pEncoding = pDecrypt;

    /* create a privateKeyInfo and decode it */
    pKeyInfo = (PANSC_ASN1_PRIVATEKEYINFO)AnscAsn1CreatePrivateKeyInfo(NULL);

    if( pKeyInfo == NULL)
    {
        goto EXIT;
    }

    status = pKeyInfo->DecodingData(pKeyInfo, (PVOID*)&pEncoding);

    if( status != ANSC_STATUS_SUCCESS)
    {
        pKeyInfo->AsnFree(pKeyInfo);

        pKeyInfo = NULL;

    }

EXIT:

    if( pDecrypt != NULL)
    {
        AnscFreeMemory(pDecrypt);
    }

    return pKeyInfo;
}

static ANSC_STATUS
decryptContentInfo
    (
        PANSC_ASN1_CONTENTINFO      pContentInfo,
        ANSC_HANDLE                 hPKCSUtility,
        PCHAR                       pPassword
    )
{
    PANSC_ASN1_SAFECONTENTS         pSafeContents;
    PANSC_ASN1_SAFEBAG              pSafeBag;
    ANSC_STATUS                     status;
    PUCHAR                          pEncoding;
    PANSC_ASN1_CHOICE               pContent;
    PANSC_ASN1_STRING               pString;
    ULONG                           i;
    PANSC_ASN1_CHOICE               pBagChoice;
    ANSC_HANDLE                     hKeyInfo;

    pContent = (PANSC_ASN1_CHOICE)pContentInfo->GetChildByIndex(pContentInfo, 1);
    pString  = (PANSC_ASN1_STRING)pContent->hSelection;

    if( pString == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    /* it's safe content object, we decode it first */
    pSafeContents = (PANSC_ASN1_SAFECONTENTS)AnscAsn1CreateSafeContents(NULL);

    if( pSafeContents == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pEncoding = pString->GetValueBuffer(pString);

    status = pSafeContents->DecodingData(pSafeContents, (PVOID*)&pEncoding);

    if( status != ANSC_STATUS_SUCCESS)
    {
        pSafeContents->AsnFree(pSafeContents);

        return status;
    }

    pContentInfo->SetExtraChild(pContentInfo, pSafeContents, TRUE);

    /* then decrypt it */
    for( i = 0; i < pSafeContents->GetChildCount(pSafeContents); i ++)
    {
        pSafeBag = (PANSC_ASN1_SAFEBAG)pSafeContents->GetChildByIndex(pSafeContents,  i);

        if( pSafeBag != NULL && TRUE)
        /* only encrypted privatekey info will be decrypted */
        {
            pBagChoice = (PANSC_ASN1_CHOICE)pSafeBag->GetBagValue(pSafeBag);

            if( pBagChoice->lSelect == BAGVALUE_MASK_PKCS8SHROUDEDKEYBAG)
            {
                hKeyInfo = 
                    decryptPrivateKeyInfo
                        (
                            pBagChoice->hSelection,
                            hPKCSUtility,
                            pPassword
                        );

                if( hKeyInfo != NULL)
                {
                    pSafeBag->SetExtraChild(pSafeBag, hKeyInfo, TRUE);
                }
                else
                {
                    return ANSC_STATUS_FAILURE;
                }
            }
        }
    }

    return ANSC_STATUS_SUCCESS;
}

static ANSC_STATUS
decryptEncryptedContentInfo
    (
        PANSC_ASN1_CONTENTINFO      pContentInfo,
        ANSC_HANDLE                 hPKCSUtility,
        PCHAR                       pPassword
    )
{
    PPKCS12_UTILITY_INTERFACE       pPKCS12Util  = (PPKCS12_UTILITY_INTERFACE)hPKCSUtility;
    ANSC_STATUS                     status       = ANSC_STATUS_SUCCESS;
    ULONG                           uIteration   = 1;    /* default as 1 */
    PUCHAR                          pDecrypt     = NULL;
    PANSC_ASN1_SAFECONTENTS         pSafeContents= NULL;
    PUCHAR                          pEncoding;
    PANSC_ASN1_CHOICE               pContent;
    PANSC_ASN1_ENCRYPTEDDATA        pEncryptContent;
    PANSC_ASN1_ENCRYPTEDCONTENTINFO pDataInfo;
    PANSC_ASN1_ALGORITHMIDENTIFIER  pAlgorObj;
    PANSC_ASN1_STRING               pOctetObj;
    PKCS12_CRYPTO_ALGOR             algorType;
    PANSC_ASN1_STRING               pSaltObj;
    PANSC_ASN1_INTEGER              pIteration;
    PANSC_ASN1_SEQUENCE             pPKCS12Param;
    PANSC_ASN1_CHOICE               pParams;
    ULONG                           uLength;

    pContent = (PANSC_ASN1_CHOICE)pContentInfo->GetChildByIndex(pContentInfo, 1);

    pEncryptContent = 
        (PANSC_ASN1_ENCRYPTEDDATA)pContent->hSelection;

    if( pEncryptContent == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pDataInfo = 
        (PANSC_ASN1_ENCRYPTEDCONTENTINFO)pEncryptContent->GetChildByIndex(pEncryptContent, 1);

    pAlgorObj = 
        (PANSC_ASN1_ALGORITHMIDENTIFIER)pDataInfo->GetChildByIndex(pDataInfo, 1);

    pOctetObj = 
        (PANSC_ASN1_STRING)pDataInfo->GetChildByIndex(pDataInfo, 2);

    if( pAlgorObj == NULL || pOctetObj == NULL || pOctetObj->uLength == 0)
    {
        return ANSC_STATUS_FAILURE;
    }

    algorType = getPKCS12EncryptAlgor(pAlgorObj);

    if( algorType == ALG_RESERVED)
    {
        AnscTrace("Unsupported PKCS12 encryption algorithm.\n");

        return ANSC_STATUS_FAILURE;
    }

    pParams     = (PANSC_ASN1_CHOICE)pAlgorObj->GetChildByIndex(pAlgorObj, 1);
    pPKCS12Param= (PANSC_ASN1_SEQUENCE)pParams->hSelection;

    if( pPKCS12Param == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pSaltObj    = (PANSC_ASN1_STRING)pPKCS12Param->GetChildByIndex(pPKCS12Param,0);
    pIteration  = (PANSC_ASN1_INTEGER)pPKCS12Param->GetChildByIndex(pPKCS12Param,1);

    if(!pIteration->bOptional)
    {
        uIteration = pIteration->GetIntegerValue(pIteration);
    }

    /* allocate memory for the decrypted data */
    uLength  = pOctetObj->uLength + 8;
    pDecrypt = (PUCHAR)AnscAllocateMemory(uLength);

    if( pDecrypt == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pPKCS12Util->PKCS12Decrypt
        (
            pPKCS12Util,
            algorType,
            pPassword,
            pSaltObj->GetValueBuffer(pSaltObj),
            pSaltObj->uLength,
            uIteration,
            pOctetObj->GetValueBuffer(pOctetObj),
            pOctetObj->uLength,
            pDecrypt,
            &uLength
        );

    pEncoding = pDecrypt;

    /* create a safebag and decode it */
    pSafeContents = (PANSC_ASN1_SAFECONTENTS)AnscAsn1CreateSafeContents(NULL);

    if( pSafeContents == NULL)
    {
        status = ANSC_STATUS_FAILURE;

        goto EXIT;
    }

    status = pSafeContents->DecodingData(pSafeContents, (PVOID*)&pEncoding);

    if( status != ANSC_STATUS_SUCCESS)
    {
        pSafeContents->AsnFree(pSafeContents);

        goto EXIT;
    }

    pContentInfo->SetExtraChild(pContentInfo, pSafeContents, TRUE);

EXIT:

    if( pDecrypt != NULL)
    {
        AnscFreeMemory(pDecrypt);
    }

    return status;
}

/*
 *  manually added functions;
 */
ANSC_STATUS
AnscAsn1AuthenticatedSafeDecryptContent
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hPKCSUtility,
        PCHAR                       pPassword
    )
{
    PANSC_ASN1_AUTHENTICATEDSAFE    pThisObject  = (PANSC_ASN1_AUTHENTICATEDSAFE)hThisObject;
    ANSC_STATUS                     status       = ANSC_STATUS_SUCCESS;
    PANSC_ASN1_CONTENTINFO          pContentInfo;
    PANSC_ASN1_CHOICE               pContent;
    ULONG                           i;

    for( i = 0; i < pThisObject->GetChildCount(pThisObject); i ++)
    {
        pContentInfo = (PANSC_ASN1_CONTENTINFO)pThisObject->GetChildByIndex(pThisObject, i);

        if( pContentInfo != NULL)
        {
            pContent = (PANSC_ASN1_CHOICE)pContentInfo->GetChildByIndex(pContentInfo,1);

            if( pContent->lSelect == CONTENTDATA_MASK_DATA)
            {
                status = decryptContentInfo(pContentInfo, hPKCSUtility, pPassword);
            }
            else if( pContent->lSelect == CONTENTDATA_MASK_ENCRYPTEDDATA)
            {
                status = decryptEncryptedContentInfo(pContentInfo, hPKCSUtility, pPassword);
            }
            else
            {
                AnscTrace("Unsupported SafeBag.\n");

                return ANSC_STATUS_FAILURE;
            }

            if( status != ANSC_STATUS_SUCCESS)
            {
                return status;
            }
        }
    }

    return ANSC_STATUS_SUCCESS;
}

/**********************************************************************

 OBJECT -- ASN1_SAFECONTENTS

 SafeContents ::= SequenceOf SafeBag  {}

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreateSafeContents
    (
        ANSC_HANDLE                 hReserved
    )
{
    PANSC_ASN1_SAFECONTENTS         pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    if( hReserved != NULL)
    {
        pThisObject = (PANSC_ASN1_SAFECONTENTS)
            AnscAsn1CreateSequenceOf
                (
                    hReserved
                );
    }
    else
    {
        pThisObject = (PANSC_ASN1_SAFECONTENTS)
            AnscAsn1CreateSequenceOf
                (
                    (ANSC_HANDLE)sizeof(ANSC_ASN1_SAFECONTENTS)
                );
    }

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject,"ANSC_ASN1_SAFECONTENTS");
    pThisObject->SetName(pThisObject,"SafeContents");

    pThisObject->Create             = AnscAsn1CreateSafeContents;
    pThisObject->CreateChild        = AnscAsn1SafeContentsCreateChild;
    pThisObject->IsChildValid       = AnscAsn1SafeContentsIsChildValid;

    /*
     * Set BasicSize for Kerberoes impementation, please check GetBAOHandle().
     */
    if( hReserved != NULL )
    {
        pThisObject->uBasicSize         = (ULONG)hReserved;
    }
    else
    {
        pThisObject->uBasicSize         = sizeof(ANSC_ASN1_SAFECONTENTS);
    }


    return (ANSC_HANDLE)pThisObject;
}

ANSC_HANDLE
AnscAsn1SafeContentsCreateChild
    (
        ANSC_HANDLE                 hThisObject,
        BOOLEAN                     bAddItIn
    )
{
    PANSC_ASN1_SETOF                pParentObj   = (PANSC_ASN1_SETOF)hThisObject;
    PANSC_ASN1_OBJECT               pThisObject  = NULL;

    pThisObject  = AnscAsn1CreateSafeBag(NULL);

    if( pThisObject != NULL && bAddItIn)
    {
        pParentObj->AddChild(pParentObj,pThisObject);
    }

    return pThisObject;
}

ANSC_STATUS
AnscAsn1SafeContentsIsChildValid
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hChild
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    PANSC_ASN1_OBJECT               pChild    = (PANSC_ASN1_OBJECT)hChild;

    if( pChild == NULL)
    {
        return ANSC_ASN1_NULL_OBJCET;
    }

    if( !AnscEqualString1(pChild->ClassName, "ANSC_ASN1_SAFEBAG", TRUE))
    {
        return ANSC_ASN1_INVALID_TYPE_IN_SEQOF_OR_SETOF;
    }

    return ANSC_STATUS_SUCCESS;
}

/**********************************************************************

 OBJECT -- ASN1_SAFEBAG

 SafeBag ::= Sequence 
     {
                             bagID OID 
                          bagValue [CON 0] BagValue 
                     bagAttributes PKCS12Attributes OPT
     }

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreateSafeBag
    (
        ANSC_HANDLE                 hReserved
    )
{
    PANSC_ASN1_SAFEBAG              pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    if( hReserved != NULL)
    {
        pThisObject = (PANSC_ASN1_SAFEBAG)
            AnscAsn1CreateSequence
                (
                    hReserved
                );
    }
    else
    {
        pThisObject = (PANSC_ASN1_SAFEBAG)
            AnscAsn1CreateSequence
                (
                    (ANSC_HANDLE)sizeof(ANSC_ASN1_SAFEBAG)
                );
    }

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject,"ANSC_ASN1_SAFEBAG");
    pThisObject->SetName(pThisObject,"SafeBag");

    pThisObject->Create             = AnscAsn1CreateSafeBag;
    pThisObject->CreateChildAttr    = AnscAsn1SafeBagCreateChildAttr;
    pThisObject->GetChildName       = AnscAsn1SafeBagGetChildName;
    pThisObject->CreateChildObject  = AnscAsn1SafeBagCreateChildObject;
    pThisObject->GetBagID           = AnscAsn1SafeBagGetBagID;
    pThisObject->GetBagValue        = AnscAsn1SafeBagGetBagValue;
    pThisObject->GetBagAttributes   = AnscAsn1SafeBagGetBagAttributes;
    pThisObject->uTotalChild        = 3;

    pThisObject->IsCertBag          = AnscAsn1SafeBagIsCertBag;
    pThisObject->IsKeyInfoBag       = AnscAsn1SafeBagIsKeyInfoBag;
    pThisObject->GetLocalKeyIDObj   = AnscAsn1SafeBagGetLocalKeyID;
    pThisObject->GetValueHandle     = AnscAsn1SafeBagGetValueHandle;
    pThisObject->SetLocalKeyID      = AnscAsn1SafeBagSetLocalKeyID;
    pThisObject->SetCertInfo        = AnscAsn1SafeBagSetCertInfo;
    pThisObject->SetKeyInfo         = AnscAsn1SafeBagSetKeyInfo;

    /*
     * Create all the children
     */
    pThisObject->CreateAllChildren(pThisObject);


    /*
     * Set BasicSize for Kerberoes impementation, please check GetBAOHandle().
     */
    if( hReserved != NULL )
    {
        pThisObject->uBasicSize         = (ULONG)hReserved;
    }
    else
    {
        pThisObject->uBasicSize         = sizeof(ANSC_ASN1_SAFEBAG);
    }

    return (ANSC_HANDLE)pThisObject;
}

ANSC_HANDLE
AnscAsn1SafeBagCreateChildObject
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    PANSC_ASN1_OBJECT               pThisObject      = NULL;
    PANSC_ASN1_SEQUENCE             pParent          = (PANSC_ASN1_SEQUENCE)hThisObject;

    switch( index )
    {

        case 0:

            pThisObject = AnscAsn1CreateOID(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

        case 1:

            pThisObject = AnscAsn1CreateBagValue(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

        case 2:

            pThisObject = AnscAsn1CreatePKCS12Attributes(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
                pThisObject->bCanBeOptional = TRUE;
                pThisObject->bOptional      = TRUE;

            }

            break;

    }

    return pThisObject;

}

PANSC_ATTR_OBJECT
AnscAsn1SafeBagCreateChildAttr
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    PANSC_ATTR_OBJECT               pAttrObject  = NULL;

    switch ( index )
    {
        case 0:

                break;

        case 1:

                pAttrObject = (PANSC_ATTR_OBJECT)
                    AnscAsn1AttrCreate
                        (
                          CONTEXT_FORM,
                          0,
                          EXPLICIT_TYPE
                        );

                break;

        case 2:

                break;

    }

    return pAttrObject;

}

PCHAR
AnscAsn1SafeBagGetChildName
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    switch ( index )
    {
        case 0:

            return"bagID";

        case 1:

            return"bagValue";

        case 2:

            return"bagAttributes";

    }

    return "";

}

ANSC_HANDLE
AnscAsn1SafeBagGetBagID
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_SEQUENCE             pParent          = (PANSC_ASN1_SEQUENCE)hThisObject;

    return pParent->GetChildByIndex(pParent, 0);

}

ANSC_HANDLE
AnscAsn1SafeBagGetBagValue
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_SEQUENCE             pParent          = (PANSC_ASN1_SEQUENCE)hThisObject;

    return pParent->GetChildByIndex(pParent, 1);

}

ANSC_HANDLE
AnscAsn1SafeBagGetBagAttributes
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_SEQUENCE             pParent          = (PANSC_ASN1_SEQUENCE)hThisObject;

    return pParent->GetChildByIndex(pParent, 2);

}

/*
 * Manually added functions
 */
BOOLEAN
AnscAsn1SafeBagIsCertBag
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_SAFEBAG              pThisObject  = (PANSC_ASN1_SAFEBAG)hThisObject;
    PANSC_ASN1_CHOICE               pBagValue;

    pBagValue = (PANSC_ASN1_CHOICE)pThisObject->GetChildByIndex(pThisObject, 1);

    return pBagValue->lSelect == BAGVALUE_MASK_CERTBAG;
}

BOOLEAN
AnscAsn1SafeBagIsKeyInfoBag
    (
        ANSC_HANDLE                 hThisObject,
        BOOLEAN                     bEncrypted
    )
{
    PANSC_ASN1_SAFEBAG              pThisObject  = (PANSC_ASN1_SAFEBAG)hThisObject;
    PANSC_ASN1_CHOICE               pBagValue;

    pBagValue = (PANSC_ASN1_CHOICE)pThisObject->GetChildByIndex(pThisObject, 1);

    if( bEncrypted)
    {
        return pBagValue->lSelect == BAGVALUE_MASK_PKCS8SHROUDEDKEYBAG;
    }
    else
    {
        return pBagValue->lSelect == BAGVALUE_MASK_KEYBAG;
    }
}

ANSC_HANDLE
AnscAsn1SafeBagGetLocalKeyID
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_SAFEBAG              pThisObject  = (PANSC_ASN1_SAFEBAG)hThisObject;
    PANSC_ASN1_SETOF                pBagAttrs;
    PANSC_ASN1_OBJECT               pSelection;
    PANSC_ASN1_SEQUENCE             pAttribute;
    PANSC_ASN1_OIDEN                pOID;
    ULONG                           i;
    CHAR                            pOIDValue[256] = { 0 };
    PANSC_ASN1_CHOICE               pValueObj;

    pBagAttrs = (PANSC_ASN1_SETOF)pThisObject->GetChildByIndex(pThisObject, 2);

    if( pBagAttrs == NULL || pBagAttrs->bOptional ||
        pBagAttrs->GetChildCount(pBagAttrs) == 0)
    {
        return NULL;
    }

    for( i = 0; i < pBagAttrs->GetChildCount(pBagAttrs); i ++)
    {
        pAttribute = 
            (PANSC_ASN1_SEQUENCE)pBagAttrs->GetChildByIndex(pBagAttrs, i);

        pOID = 
            (PANSC_ASN1_OIDEN)pAttribute->GetChildByIndex(pAttribute, 0);

        pOID->GetStringOIDValue(pOID, pOIDValue);

        if( strcasecmp( pOIDValue, "1.2.840.113549.1.9.21") == 0 )
        {
            pValueObj = 
                (PANSC_ASN1_CHOICE)pAttribute->GetChildByIndex(pAttribute, 1);

            pSelection = (PANSC_ASN1_OBJECT)pValueObj->hSelection;

            while( pSelection != NULL && pSelection->uType == ASN1_CHOICE_TYPE)
            {
                pSelection = 
                    (PANSC_ASN1_OBJECT)((PANSC_ASN1_CHOICE)pSelection)->hSelection;
            }

            return pSelection;
        }
    }

    return NULL;
}

ANSC_HANDLE
AnscAsn1SafeBagGetValueHandle
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_SAFEBAG              pThisObject  = (PANSC_ASN1_SAFEBAG)hThisObject;
    PANSC_ASN1_CHOICE               pValue;


    pValue  = (PANSC_ASN1_CHOICE)pThisObject->GetBagValue(pThisObject);

    if( pValue == NULL)
    {
        return NULL;
    }

    return pValue->hSelection;
}

ANSC_STATUS
AnscAsn1SafeBagSetLocalKeyID
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       uKeyID
    )
{
    PANSC_ASN1_SAFEBAG              pThisObject  = (PANSC_ASN1_SAFEBAG)hThisObject;
    UCHAR                           pKeyID[8]    = { 0 };
    PANSC_ASN1_SETOF                pAttrSet;
    PANSC_ASN1_PKCS12ATTRIBUTE      pAttr;
    PANSC_ASN1_STRING               pStrObj;
    PANSC_ASN1_OIDEN                pOID;
    PANSC_ASN1_ATTRIBUTEVALUE       pValue;
    PANSC_ASN1_SETOF                pValues;
    ANSC_STATUS                     status;

    pAttrSet =
        (PANSC_ASN1_SETOF)pThisObject->GetChildByIndex(pThisObject, 2);

    pAttr = 
        (PANSC_ASN1_PKCS12ATTRIBUTE)AnscAsn1CreatePKCS12Attribute(NULL);

    if( pAttr == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pAttrSet->AddChild(pAttrSet, pAttr);

    /* init the pAttr */
    pOID = (PANSC_ASN1_OIDEN)pAttr->GetChildByIndex(pAttr, 0);
    pOID->SetStringOIDValue(pOID, "1.2.840.113549.1.9.21");

    /* set the value */
    pValues = (PANSC_ASN1_SETOF)pAttr->GetChildByIndex(pAttr, 1);

    pValue  = (PANSC_ASN1_ATTRIBUTEVALUE)AnscAsn1CreateAttributeValue(NULL);

    pValues->AddChild(pValues, pValue);

    status = 
        pValue->SetAndCreateSelection(pValue, ATTRIBUTEVALUE_MASK_PKCS9LOCALKEYID);

    if( status != ANSC_STATUS_SUCCESS)
    {
        AnscTrace("Failed to create selection 'ATTRIBUTEVALUE_MASK_PKCS9LOCALKEYID'\n");

        return status;
    }   

    pStrObj = (PANSC_ASN1_STRING)pValue->hSelection;

    if( pStrObj == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    AnscWriteUlong(pKeyID, uKeyID);
    pStrObj->SetStringValue(pStrObj, pKeyID, 4);

    return ANSC_STATUS_SUCCESS;
}

ANSC_STATUS
AnscAsn1SafeBagSetCertInfo
    (
        ANSC_HANDLE                 hThisObject,
        PUCHAR                      pEncoding,
        ULONG                       uLength
    )
{
    PANSC_ASN1_SAFEBAG              pThisObject  = (PANSC_ASN1_SAFEBAG)hThisObject;
    PANSC_ASN1_CHOICE               pBagValue;
    PANSC_ASN1_CHOICE               pCertValue;
    PANSC_ASN1_OIDEN                pOID;
    PANSC_ASN1_CERTBAG              pCertBag;
    PANSC_ASN1_STRING               pStrObj;

    /* set the OID type as Certbag */
    pOID = (PANSC_ASN1_OIDEN)pThisObject->GetBagID(pThisObject);
    pOID->SetStringOIDValue(pOID, "1.2.840.113549.1.12.10.1.3");

    /* set the bagvalue */
    pBagValue = (PANSC_ASN1_CHOICE)pThisObject->GetBagValue(pThisObject);
    pBagValue->SetAndCreateSelection(pBagValue, BAGVALUE_MASK_CERTBAG);

    /* init the cert bag value */
    pCertBag = (PANSC_ASN1_CERTBAG)pBagValue->hSelection;

    if( pCertBag == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pOID = (PANSC_ASN1_OIDEN)pCertBag->GetChildByIndex(pCertBag,0);
    pOID->SetStringOIDValue(pOID, "1.2.840.113549.1.9.22.1");

    pCertValue = (PANSC_ASN1_CHOICE)pCertBag->GetChildByIndex(pCertBag,1);
    pCertValue->SetAndCreateSelection(pCertValue, CERTVALUE_MASK_CERT);

    pStrObj = (PANSC_ASN1_STRING)pCertValue->hSelection;

    if( pStrObj == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pStrObj->SetStringValue(pStrObj, pEncoding, uLength);

    return ANSC_STATUS_SUCCESS;
}


ANSC_STATUS
AnscAsn1SafeBagSetKeyInfo
    (
        ANSC_HANDLE                 hThisObject,
        PUCHAR                      pEncoding,
        ULONG                       uLength
    )
{
    UNREFERENCED_PARAMETER(uLength);
    PANSC_ASN1_SAFEBAG              pThisObject  = (PANSC_ASN1_SAFEBAG)hThisObject;
    PANSC_ASN1_CHOICE               pBagValue;
    PANSC_ASN1_OIDEN                pOID;
    PANSC_ASN1_KEYBAG               pKeyBag;
    PUCHAR                          pBack;

    /* set the OID type as keybag */
    pOID = (PANSC_ASN1_OIDEN)pThisObject->GetBagID(pThisObject);
    pOID->SetStringOIDValue(pOID, "1.2.840.113549.1.12.10.1.1");

    /* set the bagvalue */
    pBagValue = (PANSC_ASN1_CHOICE)pThisObject->GetBagValue(pThisObject);
    pBagValue->SetAndCreateSelection(pBagValue, BAGVALUE_MASK_KEYBAG);

    /* init the key bag value */
    pKeyBag = (PANSC_ASN1_KEYBAG)pBagValue->hSelection;

    if( pKeyBag == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pBack = pEncoding;

    return pKeyBag->DecodingData(pKeyBag, (PVOID*)&pBack);
}

/**********************************************************************

 OBJECT -- ASN1_PKCS12ATTRIBUTES

 PKCS12Attributes ::= SetOf PKCS12Attribute  {}

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreatePKCS12Attributes
    (
        ANSC_HANDLE                 hReserved
    )
{
    PANSC_ASN1_PKCS12ATTRIBUTES     pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    if( hReserved != NULL)
    {
        pThisObject = (PANSC_ASN1_PKCS12ATTRIBUTES)
            AnscAsn1CreateSetOf
                (
                    hReserved
                );
    }
    else
    {
        pThisObject = (PANSC_ASN1_PKCS12ATTRIBUTES)
            AnscAsn1CreateSetOf
                (
                    (ANSC_HANDLE)sizeof(ANSC_ASN1_PKCS12ATTRIBUTES)
                );
    }

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject,"ANSC_ASN1_PKCS12ATTRIBUTES");
    pThisObject->SetName(pThisObject,"PKCS12Attributes");

    pThisObject->Create             = AnscAsn1CreatePKCS12Attributes;
    pThisObject->CreateChild        = AnscAsn1PKCS12AttributesCreateChild;
    pThisObject->IsChildValid       = AnscAsn1PKCS12AttributesIsChildValid;

    /*
     * Set BasicSize for Kerberoes impementation, please check GetBAOHandle().
     */
    if( hReserved != NULL )
    {
        pThisObject->uBasicSize         = (ULONG)hReserved;
    }
    else
    {
        pThisObject->uBasicSize         = sizeof(ANSC_ASN1_PKCS12ATTRIBUTES);
    }

    return (ANSC_HANDLE)pThisObject;
}

ANSC_HANDLE
AnscAsn1PKCS12AttributesCreateChild
    (
        ANSC_HANDLE                 hThisObject,
        BOOLEAN                     bAddItIn
    )
{
    PANSC_ASN1_SETOF                pParentObj   = (PANSC_ASN1_SETOF)hThisObject;
    PANSC_ASN1_OBJECT               pThisObject  = NULL;

    pThisObject  = AnscAsn1CreatePKCS12Attribute(NULL);

    if( pThisObject != NULL && bAddItIn)
    {
        pParentObj->AddChild(pParentObj,pThisObject);
    }

    return pThisObject;
}

ANSC_STATUS
AnscAsn1PKCS12AttributesIsChildValid
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hChild
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    PANSC_ASN1_OBJECT               pChild    = (PANSC_ASN1_OBJECT)hChild;

    if( pChild == NULL)
    {
        return ANSC_ASN1_NULL_OBJCET;
    }

    if( !AnscEqualString1(pChild->ClassName, "ANSC_ASN1_PKCS12ATTRIBUTE", TRUE))
    {
        return ANSC_ASN1_INVALID_TYPE_IN_SEQOF_OR_SETOF;
    }

    return ANSC_STATUS_SUCCESS;
}

/**********************************************************************

 OBJECT -- ASN1_PKCS12ATTRIBUTE

 PKCS12Attribute ::= Attribute 

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreatePKCS12Attribute
    (
        ANSC_HANDLE                 hReserved
    )
{
    PANSC_ASN1_PKCS12ATTRIBUTE      pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    if( hReserved != NULL)
    {
        pThisObject = (PANSC_ASN1_PKCS12ATTRIBUTE)
            AnscAsn1CreateAttribute
                (
                    hReserved
                );
    }
    else
    {
        pThisObject = (PANSC_ASN1_PKCS12ATTRIBUTE)
            AnscAsn1CreateAttribute
                (
                    (ANSC_HANDLE)sizeof(ANSC_ASN1_PKCS12ATTRIBUTE)
                );
    }

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject,"ANSC_ASN1_PKCS12ATTRIBUTE");
    pThisObject->SetName(pThisObject,"PKCS12Attribute");

    pThisObject->Create             = AnscAsn1CreatePKCS12Attribute;

    /*
     * Set BasicSize for Kerberoes impementation, please check GetBAOHandle().
     */
    if( hReserved != NULL )
    {
        pThisObject->uBasicSize         = (ULONG)hReserved;
    }
    else
    {
        pThisObject->uBasicSize         = sizeof(ANSC_ASN1_PKCS12ATTRIBUTE);
    }

    return (ANSC_HANDLE)pThisObject;
}

/**********************************************************************

 OBJECT -- ASN1_KEYBAG

 KeyBag ::= PrivateKeyInfo 

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreateKeyBag
    (
        ANSC_HANDLE                 hReserved
    )
{
    PANSC_ASN1_KEYBAG               pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    if( hReserved != NULL)
    {
        pThisObject = (PANSC_ASN1_KEYBAG)
            AnscAsn1CreatePrivateKeyInfo
                (
                    hReserved
                );
    }
    else
    {
        pThisObject = (PANSC_ASN1_KEYBAG)
            AnscAsn1CreatePrivateKeyInfo
                (
                    (ANSC_HANDLE)sizeof(ANSC_ASN1_KEYBAG)
                );
    }

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject,"ANSC_ASN1_KEYBAG");
    pThisObject->SetName(pThisObject,"KeyBag");

    pThisObject->Create             = AnscAsn1CreateKeyBag;

    /*
     * Set BasicSize for Kerberoes impementation, please check GetBAOHandle().
     */
    if( hReserved != NULL )
    {
        pThisObject->uBasicSize         = (ULONG)hReserved;
    }
    else
    {
        pThisObject->uBasicSize         = sizeof(ANSC_ASN1_KEYBAG);
    }


    return (ANSC_HANDLE)pThisObject;
}

/**********************************************************************

 OBJECT -- ASN1_PKCS8SHROUDEDKEYBAG

 PKCS8ShroudedKeyBag ::= EncryptedPrivateKeyInfo 

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreatePKCS8ShroudedKeyBag
    (
        ANSC_HANDLE                 hReserved
    )
{
    PANSC_ASN1_PKCS8SHROUDEDKEYBAG  pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    if( hReserved != NULL)
    {
        pThisObject = (PANSC_ASN1_PKCS8SHROUDEDKEYBAG)
            AnscAsn1CreateEncryptedPrivateKeyInfo
                (
                    hReserved
                );
    }
    else
    {
        pThisObject = (PANSC_ASN1_PKCS8SHROUDEDKEYBAG)
            AnscAsn1CreateEncryptedPrivateKeyInfo
                (
                    (ANSC_HANDLE)sizeof(ANSC_ASN1_PKCS8SHROUDEDKEYBAG)
                );
    }

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject,"ANSC_ASN1_PKCS8SHROUDEDKEYBAG");
    pThisObject->SetName(pThisObject,"PKCS8ShroudedKeyBag");

    pThisObject->Create             = AnscAsn1CreatePKCS8ShroudedKeyBag;

    /*
     * Set BasicSize for Kerberoes impementation, please check GetBAOHandle().
     */
    pThisObject->uBasicSize         = sizeof(ANSC_ASN1_PKCS8SHROUDEDKEYBAG);

    return (ANSC_HANDLE)pThisObject;
}

/**********************************************************************

 OBJECT -- ASN1_CERTBAG

 CertBag ::= Sequence 
     {
                         certTypes OID 
                         certValue [CON 0] CertValue 
     }

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreateCertBag
    (
        ANSC_HANDLE                 hReserved
    )
{
    PANSC_ASN1_CERTBAG              pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    if( hReserved != NULL)
    {
        pThisObject = (PANSC_ASN1_CERTBAG)
            AnscAsn1CreateSequence
                (
                    hReserved
                );
    }
    else
    {
        pThisObject = (PANSC_ASN1_CERTBAG)
            AnscAsn1CreateSequence
                (
                    (ANSC_HANDLE)sizeof(ANSC_ASN1_CERTBAG)
                );
    }

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject,"ANSC_ASN1_CERTBAG");
    pThisObject->SetName(pThisObject,"CertBag");

    pThisObject->Create             = AnscAsn1CreateCertBag;
    pThisObject->CreateChildAttr    = AnscAsn1CertBagCreateChildAttr;
    pThisObject->GetChildName       = AnscAsn1CertBagGetChildName;
    pThisObject->CreateChildObject  = AnscAsn1CertBagCreateChildObject;
    pThisObject->uTotalChild        = 2;

    pThisObject->GetCertObject      = AnscAsn1CertBagGetCertObject;
    /*
     * Create all the children
     */
    pThisObject->CreateAllChildren(pThisObject);


    /*
     * Set BasicSize for Kerberoes impementation, please check GetBAOHandle().
     */
    if( hReserved != NULL )
    {
        pThisObject->uBasicSize         = (ULONG)hReserved;
    }
    else
    {
        pThisObject->uBasicSize         = sizeof(ANSC_ASN1_CERTBAG);
    }

    return (ANSC_HANDLE)pThisObject;
}

ANSC_HANDLE
AnscAsn1CertBagCreateChildObject
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    PANSC_ASN1_OBJECT               pThisObject      = NULL;
    PANSC_ASN1_SEQUENCE             pParent          = (PANSC_ASN1_SEQUENCE)hThisObject;

    switch( index )
    {

        case 0:

            pThisObject = AnscAsn1CreateOID(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

        case 1:

            pThisObject = AnscAsn1CreateCertValue(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

    }

    return pThisObject;

}

PANSC_ATTR_OBJECT
AnscAsn1CertBagCreateChildAttr
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    PANSC_ATTR_OBJECT               pAttrObject  = NULL;

    switch ( index )
    {
        case 0:

                break;

        case 1:

                pAttrObject = (PANSC_ATTR_OBJECT)
                    AnscAsn1AttrCreate
                        (
                          CONTEXT_FORM,
                          0,
                          EXPLICIT_TYPE
                        );

                break;

    }

    return pAttrObject;

}

PCHAR
AnscAsn1CertBagGetChildName
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    switch ( index )
    {
        case 0:

            return"certTypes";

        case 1:

            return"certValue";

    }

    return "";

}


/*
 * Manually added functions
 */
ANSC_HANDLE
AnscAsn1CertBagGetCertObject
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_CERTBAG              pThisObject  = (PANSC_ASN1_CERTBAG)hThisObject;
    PANSC_ASN1_CHOICE               pCertValue;

    pCertValue = (PANSC_ASN1_CHOICE)pThisObject->GetChildByIndex(pThisObject,1);

    if( pCertValue == NULL)
    {
        return NULL;
    }

    return pCertValue->hSelection;
}

/**********************************************************************

 OBJECT -- ASN1_CERTVALUE

 CertValue ::= Choice 
     {
                        base64Cert IA5String 
                              cert OctetString 
     }

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreateCertValue
    (
        ANSC_HANDLE                 hReserved
    )
{
    PANSC_ASN1_CERTVALUE            pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    if( hReserved != NULL)
    {
        pThisObject = (PANSC_ASN1_CERTVALUE)
            AnscAsn1CreateChoice
                (
                    hReserved
                );
    }
    else
    {
        pThisObject = (PANSC_ASN1_CERTVALUE)
            AnscAsn1CreateChoice
                (
                    (ANSC_HANDLE)sizeof(ANSC_ASN1_CERTVALUE)
                );
    }

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject,"ANSC_ASN1_CERTVALUE");
    pThisObject->SetName(pThisObject,"CertValue");

    pThisObject->Create             = AnscAsn1CreateCertValue;
    pThisObject->CreateSelection    = AnscAsn1CertValueCreateSelection;
    pThisObject->GetSelectionName   = AnscAsn1CertValueGetSelectionName;
    pThisObject->CreateSelectionAttr= AnscAsn1CertValueCreateSelectionAttr;
    pThisObject->GetChoiceFromOID   = AnscAsn1CertValueGetChoiceByOID;
    pThisObject->GetOIDValueByMask  = AnscAsn1CertValueGetOIDValueByMask;
    pThisObject->uTotalChoice       = CERTVALUE_MAXI_MASK + 1;
    pThisObject->bChoiceByOID       = TRUE;

    /*
     * Set BasicSize for Kerberoes impementation, please check GetBAOHandle().
     */
    if( hReserved != NULL )
    {
        pThisObject->uBasicSize         = (ULONG)hReserved;
    }
    else
    {
        pThisObject->uBasicSize         = sizeof(ANSC_ASN1_CERTVALUE);
    }

    return (ANSC_HANDLE)pThisObject;
}

ANSC_HANDLE
AnscAsn1CertValueCreateSelection
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    PANSC_ASN1_OBJECT               pThisObject      = NULL;
    PANSC_ASN1_CHOICE               pParent         = (PANSC_ASN1_CHOICE)hThisObject;

    switch( index )
    {

        case CERTVALUE_MASK_BASE64CERT:

            pThisObject = AnscAsn1CreateIA5String(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateSelectionAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetSelectionName(pParent,index));
            }

            break;

        case CERTVALUE_MASK_CERT:

            pThisObject = AnscAsn1CreateOctetString(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateSelectionAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetSelectionName(pParent,index));
            }

            break;

    }

    return pThisObject;

}

PCHAR
AnscAsn1CertValueGetSelectionName
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       selType
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    switch ( selType )
    {
        case CERTVALUE_MASK_BASE64CERT:

            return"base64Cert";

        case CERTVALUE_MASK_CERT:

            return"cert";

    }

    return "";

}

PANSC_ATTR_OBJECT
AnscAsn1CertValueCreateSelectionAttr
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       selType
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    PANSC_ATTR_OBJECT               pAttrObject  = NULL;

    switch ( selType )
    {
        case CERTVALUE_MASK_BASE64CERT:

                break;

        case CERTVALUE_MASK_CERT:

                break;

    }

    return pAttrObject;

}

LONG
AnscAsn1CertValueGetChoiceByOID
    (
        ANSC_HANDLE                 hThisObject,
        PCHAR                       pOIDString
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    if( pOIDString == NULL)         return -1;

    if( AnscEqualString1(pOIDString,"1.2.840.113549.1.9.22.1",FALSE))
    {
        return CERTVALUE_MASK_CERT;
    }
    else if( AnscEqualString1(pOIDString,"1.2.840.113549.1.9.22.2",FALSE))
    {
        return CERTVALUE_MASK_BASE64CERT;
    }

    return -1;

}

PCHAR
AnscAsn1CertValueGetOIDValueByMask
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       selType
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    switch ( selType )
    {
        case CERTVALUE_MASK_CERT:

             return "1.2.840.113549.1.9.22.1";

        case CERTVALUE_MASK_BASE64CERT:

             return "1.2.840.113549.1.9.22.2";

    }

    return NULL;

}

/**********************************************************************

 OBJECT -- ASN1_CRLBAG

 CRLBag ::= Sequence 
     {
                           crlType OID 
                          crlValue [CON 0] CRLValue 
     }

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreateCRLBag
    (
        ANSC_HANDLE                 hReserved
    )
{
    PANSC_ASN1_CRLBAG               pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    if( hReserved != NULL)
    {
        pThisObject = (PANSC_ASN1_CRLBAG)
            AnscAsn1CreateSequence
                (
                    hReserved
                );
    }
    else
    {
        pThisObject = (PANSC_ASN1_CRLBAG)
            AnscAsn1CreateSequence
                (
                    (ANSC_HANDLE)sizeof(ANSC_ASN1_CRLBAG)
                );
    }

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject,"ANSC_ASN1_CRLBAG");
    pThisObject->SetName(pThisObject,"CrlBag");

    pThisObject->Create             = AnscAsn1CreateCRLBag;
    pThisObject->CreateChildAttr    = AnscAsn1CRLBagCreateChildAttr;
    pThisObject->GetChildName       = AnscAsn1CRLBagGetChildName;
    pThisObject->CreateChildObject  = AnscAsn1CRLBagCreateChildObject;
    pThisObject->uTotalChild        = 2;

    /*
     * Create all the children
     */
    pThisObject->CreateAllChildren(pThisObject);


    /*
     * Set BasicSize for Kerberoes impementation, please check GetBAOHandle().
     */
    if( hReserved != NULL )
    {
        pThisObject->uBasicSize         = (ULONG)hReserved;
    }
    else
    {
        pThisObject->uBasicSize         = sizeof(ANSC_ASN1_CRLBAG);
    }

    return (ANSC_HANDLE)pThisObject;
}

ANSC_HANDLE
AnscAsn1CRLBagCreateChildObject
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    PANSC_ASN1_OBJECT               pThisObject      = NULL;
    PANSC_ASN1_SEQUENCE             pParent          = (PANSC_ASN1_SEQUENCE)hThisObject;

    switch( index )
    {

        case 0:

            pThisObject = AnscAsn1CreateOID(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

        case 1:

            pThisObject = AnscAsn1CreateCRLValue(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

    }

    return pThisObject;

}

PANSC_ATTR_OBJECT
AnscAsn1CRLBagCreateChildAttr
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    PANSC_ATTR_OBJECT               pAttrObject  = NULL;

    switch ( index )
    {
        case 0:

                break;

        case 1:

                pAttrObject = (PANSC_ATTR_OBJECT)
                    AnscAsn1AttrCreate
                        (
                          CONTEXT_FORM,
                          0,
                          EXPLICIT_TYPE
                        );

                break;

    }

    return pAttrObject;

}

PCHAR
AnscAsn1CRLBagGetChildName
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    switch ( index )
    {
        case 0:

            return"crlType";

        case 1:

            return"crlValue";

    }

    return "";

}


/**********************************************************************

 OBJECT -- ASN1_CRLVALUE

 CRLValue ::= OctetString 

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreateCRLValue
    (
        ANSC_HANDLE                 hReserved
    )
{
    PANSC_ASN1_CRLVALUE             pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    if( hReserved != NULL)
    {
        pThisObject = (PANSC_ASN1_CRLVALUE)
            AnscAsn1CreateOctetString
                (
                    hReserved
                );
    }
    else
    {
        pThisObject = (PANSC_ASN1_CRLVALUE)
            AnscAsn1CreateOctetString
                (
                    (ANSC_HANDLE)sizeof(ANSC_ASN1_CRLVALUE)
                );
    }

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject,"ANSC_ASN1_CRLVALUE");
    pThisObject->SetName(pThisObject,"CrlValue");

    pThisObject->Create             = AnscAsn1CreateCRLValue;

    /*
     * Set BasicSize for Kerberoes impementation, please check GetBAOHandle().
     */
    if( hReserved != NULL )
    {
        pThisObject->uBasicSize         = (ULONG)hReserved;
    }
    else
    {
        pThisObject->uBasicSize         = sizeof(ANSC_ASN1_CRLVALUE);
    }

    return (ANSC_HANDLE)pThisObject;
}

/**********************************************************************

 OBJECT -- ASN1_SECRETBAG

 SecretBag ::= Sequence 
     {
                        secretType OID 
                       secretValue OctetString 
     }

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreateSecretBag
    (
        ANSC_HANDLE                 hReserved
    )
{
    PANSC_ASN1_SECRETBAG            pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    if( hReserved != NULL)
    {
        pThisObject = (PANSC_ASN1_SECRETBAG)
            AnscAsn1CreateSequence
                (
                    hReserved
                );
    }
    else
    {
        pThisObject = (PANSC_ASN1_SECRETBAG)
            AnscAsn1CreateSequence
                (
                    (ANSC_HANDLE)sizeof(ANSC_ASN1_SECRETBAG)
                );
    }

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject,"ANSC_ASN1_SECRETBAG");
    pThisObject->SetName(pThisObject,"SecretBag");

    pThisObject->Create             = AnscAsn1CreateSecretBag;
    pThisObject->CreateChildAttr    = AnscAsn1SecretBagCreateChildAttr;
    pThisObject->GetChildName       = AnscAsn1SecretBagGetChildName;
    pThisObject->CreateChildObject  = AnscAsn1SecretBagCreateChildObject;
    pThisObject->uTotalChild        = 2;

    /*
     * Create all the children
     */
    pThisObject->CreateAllChildren(pThisObject);


    /*
     * Set BasicSize for Kerberoes impementation, please check GetBAOHandle().
     */
    if( hReserved != NULL )
    {
        pThisObject->uBasicSize         = (ULONG)hReserved;
    }
    else
    {
        pThisObject->uBasicSize         = sizeof(ANSC_ASN1_SECRETBAG);
    }

    return (ANSC_HANDLE)pThisObject;
}

ANSC_HANDLE
AnscAsn1SecretBagCreateChildObject
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    PANSC_ASN1_OBJECT               pThisObject      = NULL;
    PANSC_ASN1_SEQUENCE             pParent          = (PANSC_ASN1_SEQUENCE)hThisObject;

    switch( index )
    {

        case 0:

            pThisObject = AnscAsn1CreateOID(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

        case 1:

            pThisObject = AnscAsn1CreateOctetString(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

    }

    return pThisObject;

}

PANSC_ATTR_OBJECT
AnscAsn1SecretBagCreateChildAttr
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    PANSC_ATTR_OBJECT               pAttrObject  = NULL;

    switch ( index )
    {
        case 0:

                break;

        case 1:

                break;

    }

    return pAttrObject;

}

PCHAR
AnscAsn1SecretBagGetChildName
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    switch ( index )
    {
        case 0:

            return"secretType";

        case 1:

            return"secretValue";

    }

    return "";

}

/**********************************************************************

 OBJECT -- ASN1_BAGVALUE

 BagValue ::= Choice 
     {
                            keyBag KeyBag 
               pkcs8ShroudedKeyBag PKCS8ShroudedKeyBag 
                           certBag CertBag 
                            crlBag CRLBag 
                         secretBag SecretBag 
                       safeContent SafeContents 
     }

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreateBagValue
    (
        ANSC_HANDLE                 hReserved
    )
{
    PANSC_ASN1_BAGVALUE             pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    if( hReserved != NULL)
    {
        pThisObject = (PANSC_ASN1_BAGVALUE)
            AnscAsn1CreateChoice
                (
                    hReserved
                );
    }
    else
    {
        pThisObject = (PANSC_ASN1_BAGVALUE)
            AnscAsn1CreateChoice
                (
                    (ANSC_HANDLE)sizeof(ANSC_ASN1_BAGVALUE)
                );
    }

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject,"ANSC_ASN1_BAGVALUE");
    pThisObject->SetName(pThisObject,"BagValue");

    pThisObject->Create             = AnscAsn1CreateBagValue;
    pThisObject->CreateSelection    = AnscAsn1BagValueCreateSelection;
    pThisObject->GetSelectionName   = AnscAsn1BagValueGetSelectionName;
    pThisObject->CreateSelectionAttr= AnscAsn1BagValueCreateSelectionAttr;
    pThisObject->GetChoiceFromOID   = AnscAsn1BagValueGetChoiceByOID;
    pThisObject->GetOIDValueByMask  = AnscAsn1BagValueGetOIDValueByMask;
    pThisObject->uTotalChoice       = BAGVALUE_MAXI_MASK + 1;
    pThisObject->bChoiceByOID       = TRUE;

    /*
     * Set BasicSize for Kerberoes impementation, please check GetBAOHandle().
     */
    if( hReserved != NULL )
    {
        pThisObject->uBasicSize         = (ULONG)hReserved;
    }
    else
    {
        pThisObject->uBasicSize         = sizeof(ANSC_ASN1_BAGVALUE);
    }

    return (ANSC_HANDLE)pThisObject;
}

ANSC_HANDLE
AnscAsn1BagValueCreateSelection
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    PANSC_ASN1_OBJECT               pThisObject      = NULL;
    PANSC_ASN1_CHOICE               pParent         = (PANSC_ASN1_CHOICE)hThisObject;

    switch( index )
    {

        case BAGVALUE_MASK_KEYBAG:

            pThisObject = AnscAsn1CreateKeyBag(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateSelectionAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetSelectionName(pParent,index));
            }

            break;

        case BAGVALUE_MASK_PKCS8SHROUDEDKEYBAG:

            pThisObject = AnscAsn1CreatePKCS8ShroudedKeyBag(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateSelectionAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetSelectionName(pParent,index));
            }

            break;

        case BAGVALUE_MASK_CERTBAG:

            pThisObject = AnscAsn1CreateCertBag(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateSelectionAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetSelectionName(pParent,index));
            }

            break;

        case BAGVALUE_MASK_CRLBAG:

            pThisObject = AnscAsn1CreateCRLBag(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateSelectionAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetSelectionName(pParent,index));
            }

            break;

        case BAGVALUE_MASK_SECRETBAG:

            pThisObject = AnscAsn1CreateSecretBag(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateSelectionAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetSelectionName(pParent,index));
            }

            break;

        case BAGVALUE_MASK_SAFECONTENT:

            pThisObject = AnscAsn1CreateSafeContents(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateSelectionAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetSelectionName(pParent,index));
            }

            break;

    }

    return pThisObject;

}

PCHAR
AnscAsn1BagValueGetSelectionName
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       selType
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    switch ( selType )
    {
        case BAGVALUE_MASK_KEYBAG:

            return"keyBag";

        case BAGVALUE_MASK_PKCS8SHROUDEDKEYBAG:

            return"pkcs8ShroudedKeyBag";

        case BAGVALUE_MASK_CERTBAG:

            return"certBag";

        case BAGVALUE_MASK_CRLBAG:

            return"crlBag";

        case BAGVALUE_MASK_SECRETBAG:

            return"secretBag";

        case BAGVALUE_MASK_SAFECONTENT:

            return"safeContent";

    }

    return "";

}

PANSC_ATTR_OBJECT
AnscAsn1BagValueCreateSelectionAttr
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       selType
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    PANSC_ATTR_OBJECT               pAttrObject  = NULL;

    switch ( selType )
    {
        case BAGVALUE_MASK_KEYBAG:

                break;

        case BAGVALUE_MASK_PKCS8SHROUDEDKEYBAG:

                break;

        case BAGVALUE_MASK_CERTBAG:

                break;

        case BAGVALUE_MASK_CRLBAG:

                break;

        case BAGVALUE_MASK_SECRETBAG:

                break;

        case BAGVALUE_MASK_SAFECONTENT:

                break;

    }

    return pAttrObject;

}

LONG
AnscAsn1BagValueGetChoiceByOID
    (
        ANSC_HANDLE                 hThisObject,
        PCHAR                       pOIDString
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    if( pOIDString == NULL)         return -1;

    if( AnscEqualString1(pOIDString,"1.2.840.113549.1.12.10.1.1",FALSE))
    {
        return BAGVALUE_MASK_KEYBAG;
    }
    else if( AnscEqualString1(pOIDString,"1.2.840.113549.1.12.10.1.2",FALSE))
    {
        return BAGVALUE_MASK_PKCS8SHROUDEDKEYBAG;
    }
    else if( AnscEqualString1(pOIDString,"1.2.840.113549.1.12.10.1.3",FALSE))
    {
        return BAGVALUE_MASK_CERTBAG;
    }
    else if( AnscEqualString1(pOIDString,"1.2.840.113549.1.12.10.1.4",FALSE))
    {
        return BAGVALUE_MASK_CRLBAG;
    }
    else if( AnscEqualString1(pOIDString,"1.2.840.113549.1.12.10.1.5",FALSE))
    {
        return BAGVALUE_MASK_SECRETBAG;
    }
    else if( AnscEqualString1(pOIDString,"1.2.840.113549.1.12.10.1.6",FALSE))
    {
        return BAGVALUE_MASK_SAFECONTENT;
    }

    return -1;

}

PCHAR
AnscAsn1BagValueGetOIDValueByMask
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       selType
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    switch ( selType )
    {
        case BAGVALUE_MASK_KEYBAG:

             return "1.2.840.113549.1.12.10.1.1";

        case BAGVALUE_MASK_PKCS8SHROUDEDKEYBAG:

             return "1.2.840.113549.1.12.10.1.2";

        case BAGVALUE_MASK_CERTBAG:

             return "1.2.840.113549.1.12.10.1.3";

        case BAGVALUE_MASK_CRLBAG:

             return "1.2.840.113549.1.12.10.1.4";

        case BAGVALUE_MASK_SECRETBAG:

             return "1.2.840.113549.1.12.10.1.5";

        case BAGVALUE_MASK_SAFECONTENT:

             return "1.2.840.113549.1.12.10.1.6";

    }

    return NULL;

}


