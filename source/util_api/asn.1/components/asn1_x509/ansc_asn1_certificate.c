/*
 * If not stated otherwise in this file or this component's Licenses.txt file the
 * following copyright and licenses apply:
 *
 * Copyright 2015 RDK Management
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

/**********************************************************************
   Copyright [2014] [Cisco Systems, Inc.]
 
   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at
 
       http://www.apache.org/licenses/LICENSE-2.0
 
   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
**********************************************************************/

/**********************************************************************

    MODULE: ansc_asn1_Certificate.c

        ASN.1 ANSC Code Generated by Cisco Systems, Inc.

    ---------------------------------------------------------------

    DESCRIPTION:

        The ASN.1 objects implemented in this file

        *   ANSC_ASN1_CERTIFICATE
        *   ANSC_ASN1_TBSCERTIFICATE
        *   ANSC_ASN1_CERTIFICATESERIALNUMBER
        *   ANSC_ASN1_VALIDITY
        *   ANSC_ASN1_TIME
        *   ANSC_ASN1_UNIQUEIDENTIFIER
        *   ANSC_ASN1_SUBJECTPUBLICKEYINFO
        *   ANSC_ASN1_DSASIGNATURE
        *   ANSC_ASN1_ALSTRING
        *   ANSC_ASN1_ATTRIBUTES


    ---------------------------------------------------------------

    ENVIRONMENT:

        platform independent

    ---------------------------------------------------------------

    AUTHOR:

        ASNMAGIC ANSC CODE GENERATOR 1.0

    ---------------------------------------------------------------

    REVISION HISTORY:

        *   05/07/2002  initial revision
        *   05/09/2002  more functions are added for Certificate object.
        *   11/25/2003  add function to check the cert expired, in the
                        future or valid now.

 **********************************************************************/

#include "ansc_asn1_advanced_local.h"
#include "ansc_string_util.h"

/**********************************************************************

 OBJECT -- ANSC_ASN1_CERTIFICATE

 Certificate ::= Sequence 
     {
                    tbsCertificate TBSCertificate 
                signatureAlgorithm SignatureAlgorithmIdentifier 
                    signatureValue BitString 
     }

 **********************************************************************/
ANSC_HANDLE
AnscAsn1GenSelfSignedCertificateWithCryptoAPI
    (
        ANSC_HANDLE                 hReserved,
        PALCERTIFICATE_ATTRIBUTE    pAttrObject,
        ANSC_HANDLE                 hCryptAPI,
        BOOLEAN                     bAddSubKeyIdenExtension
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject  = NULL;
    PANSC_ASN1_NAME                 pNameObject;
    PANSC_ASN1_TBSCERTIFICATE       pTBSCert;
    PANSC_ASN1_TIME                 pTimeHandle;
    PANSC_ASN1_VALIDITY             pValidity;
    ANSC_UNIVERSAL_TIME             curTime;
    PANSC_ASN1_SUBJECTPUBLICKEYINFO pPublicKeyInfo;
    PANSC_ASN1_OBJECT               pKeyObject;
    PANSC_ASN1_INTEGER              pInteger;
    PCRYPT_API_STRUCT               pCryptAPI  = (PCRYPT_API_STRUCT)hCryptAPI;
    ANSC_CRYPTO_PUB_KEY_GEN_PARAMS  genParams;
    PKI_KEY_TYPE                    keyType;
    ANSC_CRYPTO_HASH                hash;

    if( pAttrObject == NULL || hCryptAPI == NULL)
    {
        return NULL;
    }

    if( pCryptAPI->pGetPublicKey == NULL || pCryptAPI->pSignData == NULL)
    {
        AnscTrace("Invalid Smartcard APIs.\n");
        return NULL;
    }

    pThisObject = 
        (PANSC_ASN1_CERTIFICATE)
        AnscAsn1CreateCertificate
            (
                hReserved

            );

    if( pThisObject == NULL)
    {
        return NULL;
    }

    /* init the name */
    pNameObject = (PANSC_ASN1_NAME)pThisObject->GetIssuerHandle(pThisObject);
    pNameObject->InitAttribute(pNameObject, pAttrObject);

    pNameObject = (PANSC_ASN1_NAME)pThisObject->GetSubjectHandle(pThisObject);
    pNameObject->InitAttribute(pNameObject, pAttrObject);

    /* init other information */
    pTBSCert = (PANSC_ASN1_TBSCERTIFICATE)pThisObject->GetTbsCertificate(pThisObject);

    AnscAsn1GetCurrentTime((ANSC_HANDLE)&curTime);

    pValidity = (PANSC_ASN1_VALIDITY)pTBSCert->GetChildByIndex(pTBSCert,4);

    /* not before */
    pTimeHandle = (PANSC_ASN1_TIME)pValidity->GetChildByIndex(pValidity,0);
    pTimeHandle->SetTime(pTimeHandle, curTime);

    curTime.Year += 30;
    pTimeHandle = (PANSC_ASN1_TIME)pValidity->GetChildByIndex(pValidity,1);
    pTimeHandle->SetTime(pTimeHandle, curTime);

    /*
     *  Set other information such as Signature type  and public key 
     */
    pThisObject->SetSignatureType(pThisObject, pAttrObject->SignAlgor);

    /*
     *  set public key
     */
    pCryptAPI->pGetPublicKey(pCryptAPI,&keyType, &genParams);
    pPublicKeyInfo = (PANSC_ASN1_SUBJECTPUBLICKEYINFO)pThisObject->GetPublicKeyInfo(pThisObject);

    if( pPublicKeyInfo != NULL)
    {
        pPublicKeyInfo->GenerateKey
            (
                pPublicKeyInfo,
                keyType,
                &genParams
            );
    }

    /*
     *  set the serial number, it supposed to be the MD5 fingerprint of public key 
     */
    pInteger       = (PANSC_ASN1_INTEGER)pThisObject->GetSerialNumber(pThisObject);
    pKeyObject     = (PANSC_ASN1_OBJECT)pPublicKeyInfo->GetExtraChild(pPublicKeyInfo);

    if( pKeyObject != NULL)
    {
        if( ANSC_STATUS_SUCCESS == 
                AnscAsn1GetMD5FingerPrint(pKeyObject, &hash))
        {
            /* make it as an unnegative value */
            if( hash.Value[0] > 0x80)
            {
               hash.Value[0] -= 0x80;
            }

            pInteger->SetStringValue
                (
                    pInteger,
                    hash.Value,
                    hash.Length
                );
        }
    }
    
    /*
     *  If subKeyIden extension is required;
     */
    if(bAddSubKeyIdenExtension)
    {
        pThisObject->AddSubjectKeyIdentifier(pThisObject);
    }

    /* set key usage as CertSign and CRLSign */
    pThisObject->AddKeyUsage
        (
            pThisObject, 
            0xF6
            /* KEY_USAGE_DIGITALSIGNATURE_MASK | KEY_USAGE_KEYCERTSIGN_MASK |
               KEY_USAGE_NONREPUDIATION_MASK   |KEY_USAGE_CRLSIGN_MASK */
        );

    /* add basic constraint */
    pThisObject->AddBasicConstraint(pThisObject, TRUE,  -1);

    /*
     *  Sign the certificate with the CryptoAPI;
     */
    pThisObject->SignWithCryptAPI(pThisObject, pCryptAPI);

    return pThisObject;
}

ANSC_HANDLE
AnscAsn1GenerateSelfSignedCertificate
    (
        ANSC_HANDLE                 hReserved,
        PALCERTIFICATE_ATTRIBUTE    pAttrObject,
        ANSC_HANDLE                 hKeyPairHandle,
        BOOLEAN                     bAddSubKeyIdenExtension
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject  = NULL;
    PANSC_ASN1_NAME                 pNameObject;
    PANSC_ASN1_TBSCERTIFICATE       pTBSCert;
    PANSC_ASN1_TIME                 pTimeHandle;
    PANSC_ASN1_VALIDITY             pValidity;
    ANSC_UNIVERSAL_TIME             curTime;
    PANSC_ASN1_SUBJECTPUBLICKEYINFO pPublicKeyInfo;
    ANSC_CRYPTO_HASH                hash;
    PANSC_ASN1_OBJECT               pKeyObject;
    PANSC_ASN1_INTEGER              pInteger;

    pThisObject = 
        (PANSC_ASN1_CERTIFICATE)
        AnscAsn1CreateCertificate
            (
                hReserved

            );

    if( pThisObject == NULL)
    {
        return NULL;
    }

    /* init the name */
    pNameObject = (PANSC_ASN1_NAME)pThisObject->GetIssuerHandle(pThisObject);
    pNameObject->InitAttribute(pNameObject, pAttrObject);

    pNameObject = (PANSC_ASN1_NAME)pThisObject->GetSubjectHandle(pThisObject);
    pNameObject->InitAttribute(pNameObject, pAttrObject);

    /* init other information */
    pTBSCert = (PANSC_ASN1_TBSCERTIFICATE)pThisObject->GetTbsCertificate(pThisObject);

    AnscAsn1GetCurrentTime((ANSC_HANDLE)&curTime);

    pValidity = (PANSC_ASN1_VALIDITY)pTBSCert->GetChildByIndex(pTBSCert,4);

    /* not before */
    pTimeHandle = (PANSC_ASN1_TIME)pValidity->GetChildByIndex(pValidity,0);
    pTimeHandle->SetTime(pTimeHandle, curTime);

    curTime.Year += 20;
    pTimeHandle = (PANSC_ASN1_TIME)pValidity->GetChildByIndex(pValidity,1);
    pTimeHandle->SetTime(pTimeHandle, curTime);

    /*
     *  Set other information such as Signature type  and public key 
     */
    pThisObject->SetSignatureType(pThisObject, pAttrObject->SignAlgor);

    /*
     *  set public key and sign it
     */
    pPublicKeyInfo = (PANSC_ASN1_SUBJECTPUBLICKEYINFO)pThisObject->GetPublicKeyInfo(pThisObject);

    if( pPublicKeyInfo != NULL)
    {
        pPublicKeyInfo->GenerateKey
            (
                pPublicKeyInfo,
                pAttrObject->KeyType,
                hKeyPairHandle
            );
    }

    /*
     *  set the serial number, it supposed to be the MD5 fingerprint of public key 
     */
    pInteger       = (PANSC_ASN1_INTEGER)pThisObject->GetSerialNumber(pThisObject);
    pKeyObject     = (PANSC_ASN1_OBJECT)pPublicKeyInfo->GetExtraChild(pPublicKeyInfo);

    if( pKeyObject != NULL)
    {
        if( ANSC_STATUS_SUCCESS == 
                AnscAsn1GetMD5FingerPrint(pKeyObject, &hash))
        {
            /* make it as an unnegative value */
            if( hash.Value[0] > 0x80)
            {
               hash.Value[0] -= 0x80;
            }

            pInteger->SetStringValue
                (
                    pInteger,
                    hash.Value,
                    hash.Length
                );
        }
    }
    
    /*
     *  If subKeyIden extension is required;
     */
    if(bAddSubKeyIdenExtension)
    {
        pThisObject->AddSubjectKeyIdentifier(pThisObject);
    }

    /* set key usage as CertSign and CRLSign */
    pThisObject->AddKeyUsage
        (
            pThisObject, 
            0xF6
            /* KEY_USAGE_DIGITALSIGNATURE_MASK | KEY_USAGE_KEYCERTSIGN_MASK |
               KEY_USAGE_NONREPUDIATION_MASK   |KEY_USAGE_CRLSIGN_MASK */
        );

    /* add basic constraint */
    pThisObject->AddBasicConstraint(pThisObject, TRUE,  -1);

    /*
     *  Sign the certificate;
     */
    pThisObject->SignWithKeyParam
        (
            pThisObject,
            pAttrObject->KeyType,
            hKeyPairHandle
        );

    return pThisObject;
}


ANSC_HANDLE 
AnscAsn1CreateCertificate
    (
        ANSC_HANDLE                 hReserved
    )
{
    UNREFERENCED_PARAMETER(hReserved);
    PANSC_ASN1_CERTIFICATE          pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    pThisObject = (PANSC_ASN1_CERTIFICATE)
        AnscAsn1CreateSequence
            (
                (ANSC_HANDLE)sizeof(ANSC_ASN1_CERTIFICATE)
            );

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject, "ANSC_ASN1_CERTIFICATE");
    pThisObject->SetName(pThisObject, "Certificate");

    pThisObject->Create             = AnscAsn1CreateCertificate;
    pThisObject->AsnFree            = AnscAsn1CertificateFree;
    pThisObject->CreateChildAttr    = AnscAsn1CertificateCreateChildAttr;
    pThisObject->GetChildName       = AnscAsn1CertificateGetChildName;
    pThisObject->CreateChildObject  = AnscAsn1CertificateCreateChildObject;
    pThisObject->GetTbsCertificate  = AnscAsn1CertificateGetTbsCertificate;
    pThisObject->GetSignatureAlgorithm
                                    = AnscAsn1CertificateGetSignatureAlgorithm;
    pThisObject->GetSignatureValue  = AnscAsn1CertificateGetSignatureValue;

    /* more functions are added manually */
    pThisObject->GetIssuerHandle    = AnscAsn1CertGetIssuerHandle;
    pThisObject->GetSubjectHandle   = AnscAsn1CertGetSubjectHandle;
    pThisObject->GetExtensionsHandle= AnscAsn1CertGetExtensionsHandle;
    pThisObject->GetSerialNumber    = AnscAsn1CertGetSerialNumber;
    pThisObject->GetPublicKeyInfo   = AnscAsn1CertGetPublicKeyInfo;
    pThisObject->CheckValidity      = AnscAsn1CertCheckValidity;
    pThisObject->IsSelfSigned       = AnscAsn1CertIsSelfSigned;
    pThisObject->IsTimeValid        = AnscAsn1CertIsTimeValid;
    pThisObject->IsValidNow         = AnscAsn1CertIsValidNow;
    pThisObject->CheckTime          = AnscAsn1CertCheckTime;
    pThisObject->GetExpirationTime  = AnscAsn1CertGetExpirationTime;
    pThisObject->GetNotBeforeTime   = AnscAsn1CertGetNotBeforeTime;
    pThisObject->GetKeyType         = AnscAsn1CertGetKeyType;
    pThisObject->GetSignatureType   = AnscAsn1CertGetSignatureType;
    pThisObject->SetPublicKeyInfo   = AnscAsn1CertSetPublicKeyInfo;
    pThisObject->SetSignatureType   = AnscAsn1CertSetSignatureType;
    pThisObject->VerifySignature    = AnscAsn1CertVerify;
    pThisObject->VerifyChildCert    = AnscAsn1CertVerifyChildCert;

    pThisObject->BeforeDecodingChild
                                    = AnscAsn1CertBeforeDecodingChild;
    pThisObject->AfterDecodingChild = AnscAsn1CertAfterDecodingChild;
    pThisObject->AfterDecoding      = AnscAsn1CertAfterDecoding;

    pThisObject->pSignedData        = NULL;
    pThisObject->uSignedLength      = 0;

    pThisObject->uTotalChild        = 3;

    /*
     *  New added APIs;
     */
    pThisObject->IsThisTheIssuer    = AnscAsn1CertIsThisTheIssuer;
    pThisObject->FindExtensionWithOID
                                    = AnscAsn1CertFindExtensionWithOID;
    pThisObject->FindExtensionWithType
                                    = AnscAsn1CertFindExtensionWithType;
    pThisObject->GetBasicConstraint = AnscAsn1CertGetBasicConstraint;
    pThisObject->GetSubjectKeyIdentifier
                                    = AnscAsn1CertGetSubjectKeyIdentifier;
    pThisObject->GetAuthorityIdentifier
                                    = AnscAsn1CertGetAuthorityIdentifier;
    pThisObject->GetSubjectAltName  = AnscAsn1CertGetSubjectAltName;        
    pThisObject->GetKeyUsage        = AnscAsn1CertGetKeyUsage;
    pThisObject->GetKeyBits         = AnscAsn1CertGetKeyBits;

#ifndef _PKI_KERNEL

    pThisObject->SignWithCryptAPI   = AnscAsn1CertSignWithCryptAPI;
    pThisObject->SignWithPrivateKeyInfo
                                    = AnscAsn1CertSignWithPrivateKeyInfo;
    pThisObject->SignWithKeyParam   = AnscAsn1CertSignWithKeyParam;

    pThisObject->AddExtension       = AnscAsn1CertAddExtension;
    pThisObject->AddSubjectKeyIdentifier
                                    = AnscAsn1CertAddSubjectkeyIdentifier;
    pThisObject->AddKeyUsage        = AnscAsn1CertAddKeyUsage;
    pThisObject->AddAuthorityIdentifier
                                    = AnscAsn1CertAddAuthorityIdentifier;
    pThisObject->AddBasicConstraint = AnscAsn1CertAddBasicConstraint;
    pThisObject->AddSubjectAltName  = AnscAsn1CertAddSubjectAltName;
    pThisObject->AddKerberosSubAltName
                                    = AnscAsn1CertAddKerberosSubAltName;

#endif

    pThisObject->GetCDPString       = AnscAsn1CertGetCDPString;
    pThisObject->IsExtKeyusageIncluded
                                    = AnscAsn1CertIsExtKeyusageIncluded;
    pThisObject->IsKeyMatching      = AnscAsn1CertIsKeyMatching;
    pThisObject->ExportPublicKey    = AnscAsn1CertExportPublicKey;
    pThisObject->GetCommonName      = AnscAsn1CertGetCommonName;
    pThisObject->GetSubjectNameByOID= AnscAsn1CertGetNameByOID;
    pThisObject->GetNameEncoding    = AnscAsn1CertGetNameEncoding;
    pThisObject->IsRDNNameEmpty     = AnscAsn1CertIsRDNNameEmpty;
    pThisObject->IsPathLengthValid  = AnscAsn1CertIsPathValid;


    /*
     * Create all the children
     */
    pThisObject->CreateAllChildren(pThisObject);

    return (ANSC_HANDLE)pThisObject;
}

ANSC_STATUS
AnscAsn1CertificateFree
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_CERTIFICATE         pBaseObject  = (PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_OBJECT              pChild;

    if( pBaseObject != NULL)
    {
        /* free the signed data part */
        if( pBaseObject->pSignedData != NULL && pBaseObject->uSignedLength > 0)
        {
            AnscFreeMemory(pBaseObject->pSignedData);
        }

        /*
         *  Remove the children here, from the end;
         */
        pBaseObject->RemoveAllChildren(pBaseObject,TRUE);

        /*
         *  Remove the extra child;
         */
        pChild = pBaseObject->pExtraChild;

        if( pChild != NULL)
        {
            pChild->AsnFree(pChild);
        }

        if( pBaseObject->Name != NULL)
        {
            AnscFreeMemory(pBaseObject->Name);
        }

        if( pBaseObject->ClassName != NULL)
        {
            AnscFreeMemory(pBaseObject->ClassName);
        }

        AttrListRemoveAllAttributes(&pBaseObject->sAttrList);
        AnscFreeMemory(pBaseObject);
    }

    return  ANSC_STATUS_SUCCESS;
}


ANSC_HANDLE
AnscAsn1CertificateCreateChildObject
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    PANSC_ASN1_OBJECT               pThisObject      = NULL;
    PANSC_ASN1_SEQUENCE             pParent          = (PANSC_ASN1_SEQUENCE)hThisObject;

    switch( index )
    {

        case 0:

            pThisObject = AnscAsn1CreateTBSCertificate(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

        case 1:

            pThisObject = AnscAsn1CreateSignatureAlgorithmIdentifier(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

        case 2:

            pThisObject = AnscAsn1CreateBitString(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

    }

    return pThisObject;

}

PANSC_ATTR_OBJECT
AnscAsn1CertificateCreateChildAttr
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    UNREFERENCED_PARAMETER(index);
    PANSC_ATTR_OBJECT               pAttrObject  = NULL;

    return pAttrObject;

}

PCHAR
AnscAsn1CertificateGetChildName
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    switch ( index )
    {
        case 0:

            return"tbsCertificate";

        case 1:

            return"signatureAlgorithm";

        case 2:

            return"signatureValue";

    }

    return "";

}

ANSC_HANDLE
AnscAsn1CertificateGetTbsCertificate
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_SEQUENCE             pParent          = (PANSC_ASN1_SEQUENCE)hThisObject;

    return pParent->GetChildByIndex(pParent, 0);

}

ANSC_HANDLE
AnscAsn1CertificateGetSignatureAlgorithm
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_SEQUENCE             pParent          = (PANSC_ASN1_SEQUENCE)hThisObject;

    return pParent->GetChildByIndex(pParent, 1);

}

ANSC_HANDLE
AnscAsn1CertificateGetSignatureValue
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_SEQUENCE             pParent          = (PANSC_ASN1_SEQUENCE)hThisObject;

    return pParent->GetChildByIndex(pParent, 2);

}

/*
 *  Manually added functions;
 */
ANSC_STATUS
AnscAsn1CertCheckValidity
    (
        ANSC_HANDLE                 hThisObject,
        BOOLEAN                     bCheckTime
    )
{
    ANSC_STATUS                     returnStatus    = ANSC_STATUS_SUCCESS;
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_TBSCERTIFICATE       pTBSCert;
    PANSC_ASN1_EXTENSIONS           pExtensions;
    
    if( pThisObject == NULL)
    {
        return returnStatus;
    }

    if( pThisObject->IsSelfSigned(pThisObject))
    {
        AnscTrace("This's a selfsigned certificate.\n");

        /* verify it */
    }

    /* check expired or not */
    if( bCheckTime)
    {
        if( !pThisObject->IsValidNow(pThisObject))
        {
            AnscTrace("Time is invalid.\n");

            return ANSC_ASN1_INVALID_TIME;
        }
    }


    pTBSCert    = (PANSC_ASN1_TBSCERTIFICATE)pThisObject->GetTbsCertificate(pThisObject);

    if( pTBSCert == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pExtensions = (PANSC_ASN1_EXTENSIONS)pTBSCert->GetChildByIndex(pTBSCert,9);

    if( pExtensions != NULL)
    {
        if( !pExtensions->bOptional && !PKIIsExtensionsObjectValid((ANSC_HANDLE)pExtensions))
        {
            AnscTrace("Invalid extensions. More than one extension has the same type.\n");
        }
    }

    return returnStatus;
}

BOOLEAN
AnscAsn1CertIsSelfSigned
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_TBSCERTIFICATE       pTBSCert;
    PANSC_ASN1_NAME                 pIssuerName, pSubjectName;
    PANSC_ASN1_EXTENSION            pIssuerExt, pSubjectExt;

    if( hThisObject == NULL)
    {
        return FALSE;
    }

    /*
     *  If DN is included in Subject name, check the Subject Name and IssuerName;
     */
    pTBSCert = (PANSC_ASN1_TBSCERTIFICATE)pThisObject->GetTbsCertificate(pThisObject);

    pIssuerName  = (PANSC_ASN1_NAME)pTBSCert->GetChildByIndex(pTBSCert,3);
    pSubjectName = (PANSC_ASN1_NAME)pTBSCert->GetChildByIndex(pTBSCert,5);

    if( pIssuerName != NULL && pIssuerName->hSelection != NULL &&
        ((PANSC_ASN1_RDNSEQUENCE)pIssuerName->hSelection)->GetChildCount(pIssuerName->hSelection) > 0)
    {
        return pIssuerName->EqualsTo(pIssuerName, pSubjectName,TRUE);
    }

    if( pSubjectName != NULL && pSubjectName->hSelection != NULL &&
        ((PANSC_ASN1_RDNSEQUENCE)pSubjectName->hSelection)->GetChildCount(pSubjectName->hSelection) > 0)
    {
        return FALSE;
    }

    /*
     * issuer's name and subject's name are empty in certificate, 
     * we should examine the alternative names instead
     */
    pIssuerExt     =  pThisObject->FindExtensionWithType(pThisObject, EXTENSIONVALUE_MASK_ISSERALTNAME, FALSE);
    pSubjectExt    =  pThisObject->FindExtensionWithType(pThisObject, EXTENSIONVALUE_MASK_SUBJECTALTNAME, FALSE);

    if( pIssuerExt == NULL || pSubjectExt == NULL)
    {
        return FALSE;
    }

    return ((PANSC_ASN1_OBJECT)pIssuerExt->GetChildByIndex(pIssuerExt,2))->EqualsTo
                (
                    pIssuerExt->GetChildByIndex(pIssuerExt,2),
                    pSubjectExt->GetChildByIndex(pSubjectExt,2),
                    FALSE
                );
}

BOOLEAN
AnscAsn1CertIsValidNow
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    
    ANSC_UNIVERSAL_TIME             clockTime;

    if( pThisObject == NULL)
    {
        return FALSE;
    }

    AnscAsn1GetCurrentTime((ANSC_HANDLE)&clockTime);

    return pThisObject->IsTimeValid
                (
                    pThisObject,
                    clockTime.Year,
                    clockTime.Month,
                    clockTime.DayOfMonth,
                    clockTime.Hour,
                    clockTime.Minute,
                    clockTime.Second
                );
}

ULONG
AnscAsn1CertCheckTime
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_TBSCERTIFICATE       pTBSCert;
    PANSC_ASN1_VALIDITY             pValidity;
    PANSC_ASN1_TIME                 pNotBefore, pNotAfter;
    PANSC_ASN1_ALTIME               pTimeObject;
    
    ANSC_UNIVERSAL_TIME             clockTime;

    if( pThisObject == NULL)
    {
        return CERT_EXPIRED;
    }

    AnscAsn1GetCurrentTime((ANSC_HANDLE)&clockTime);

    pTBSCert    = (PANSC_ASN1_TBSCERTIFICATE)pThisObject->GetTbsCertificate(pThisObject);
    pValidity   = (PANSC_ASN1_VALIDITY)pTBSCert->GetChildByIndex(pTBSCert,4);

    /*
     *  Check notbefore;
     */
    pNotBefore  = (PANSC_ASN1_TIME)pValidity->GetChildByIndex(pValidity,0);
    pTimeObject = (PANSC_ASN1_ALTIME)pNotBefore->hSelection;

    if( pTimeObject != NULL)
    {
        if(pTimeObject->IsAfter
            (
                pTimeObject,
                clockTime.Year,
                clockTime.Month,
                clockTime.DayOfMonth,
                clockTime.Hour,
                clockTime.Minute,
                clockTime.Second
            ))
        {
            return CERT_IN_FUTURE;
        }
    }

    /*
     *  Check notafter;
     */
    pNotAfter   = (PANSC_ASN1_TIME)pValidity->GetChildByIndex(pValidity,1);
    pTimeObject = (PANSC_ASN1_ALTIME)pNotAfter->hSelection;

    if( pTimeObject != NULL)
    {
        if(pTimeObject->IsBefore
            (
                pTimeObject,
                clockTime.Year,
                clockTime.Month,
                clockTime.DayOfMonth,
                clockTime.Hour,
                clockTime.Minute,
                clockTime.Second
            ))
        {
            return CERT_EXPIRED;
        }
    }

    return CERT_VALID;
}

ANSC_STATUS
AnscAsn1CertGetExpirationTime
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hTime
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_UNIVERSAL_TIME            pTime           = (PANSC_UNIVERSAL_TIME)hTime;
    PANSC_ASN1_TBSCERTIFICATE       pTBSCert;
    PANSC_ASN1_VALIDITY             pValidity;
    PANSC_ASN1_TIME                 pNotAfter;
    PANSC_ASN1_ALTIME               pTimeObject;
    ULONG                           year, month, day, hour, minute, second;

    if( pThisObject == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }


    pTBSCert    = (PANSC_ASN1_TBSCERTIFICATE)pThisObject->GetTbsCertificate(pThisObject);
    pValidity   = (PANSC_ASN1_VALIDITY)pTBSCert->GetChildByIndex(pTBSCert,4);

    /*
     *  Check notafter;
     */
    pNotAfter   = (PANSC_ASN1_TIME)pValidity->GetChildByIndex(pValidity,1);
    pTimeObject = (PANSC_ASN1_ALTIME)pNotAfter->hSelection;

    if( pTimeObject != NULL)
    {
        pTimeObject->GetTimeValue
            (
                pTimeObject,
                &year,
                &month,
                &day,
                &hour,
                &minute,
                &second
            );

        pTime->Year              = (USHORT)year;
        pTime->Month             = (USHORT)month;
        pTime->DayOfMonth        = (USHORT)day;
        pTime->Hour              = (USHORT)hour;
        pTime->Minute            = (USHORT)minute;
        pTime->Second            = (USHORT)second;
    }

    return ANSC_STATUS_SUCCESS;

}

ANSC_STATUS
AnscAsn1CertGetNotBeforeTime
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hTime
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_UNIVERSAL_TIME            pTime           = (PANSC_UNIVERSAL_TIME)hTime;
    PANSC_ASN1_TBSCERTIFICATE       pTBSCert;
    PANSC_ASN1_VALIDITY             pValidity;
    PANSC_ASN1_TIME                 pNotAfter;
    PANSC_ASN1_ALTIME               pTimeObject;
    ULONG                           year, month, day, hour, minute, second;

    if( pThisObject == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }


    pTBSCert    = (PANSC_ASN1_TBSCERTIFICATE)pThisObject->GetTbsCertificate(pThisObject);
    pValidity   = (PANSC_ASN1_VALIDITY)pTBSCert->GetChildByIndex(pTBSCert,4);

    /*
     *  Check notbefore;
     */
    pNotAfter   = (PANSC_ASN1_TIME)pValidity->GetChildByIndex(pValidity,0);
    pTimeObject = (PANSC_ASN1_ALTIME)pNotAfter->hSelection;

    if( pTimeObject != NULL)
    {
        pTimeObject->GetTimeValue
            (
                pTimeObject,
                &year,
                &month,
                &day,
                &hour,
                &minute,
                &second
            );

        pTime->Year              = (USHORT)year;
        pTime->Month             = (USHORT)month;
        pTime->DayOfMonth        = (USHORT)day;
        pTime->Hour              = (USHORT)hour;
        pTime->Minute            = (USHORT)minute;
        pTime->Second            = (USHORT)second;
    }

    return ANSC_STATUS_SUCCESS;

}


BOOLEAN
AnscAsn1CertIsTimeValid
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       year,
        ULONG                       month,
        ULONG                       day,
        ULONG                       hour,
        ULONG                       minute,
        ULONG                       second
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_TBSCERTIFICATE       pTBSCert;
    PANSC_ASN1_VALIDITY             pValidity;
    PANSC_ASN1_TIME                 pNotBefore, pNotAfter;
    PANSC_ASN1_ALTIME               pTimeObject;

    if( pThisObject == NULL)
    {
        return FALSE;
    }

    pTBSCert    = (PANSC_ASN1_TBSCERTIFICATE)pThisObject->GetTbsCertificate(pThisObject);
    pValidity   = (PANSC_ASN1_VALIDITY)pTBSCert->GetChildByIndex(pTBSCert,4);

    /*
     *  Check notbefore;
     */
    pNotBefore  = (PANSC_ASN1_TIME)pValidity->GetChildByIndex(pValidity,0);
    pTimeObject = (PANSC_ASN1_ALTIME)pNotBefore->hSelection;

    if( pTimeObject != NULL)
    {
        if(pTimeObject->IsAfter
            (
                pTimeObject,
                year,
                month,
                day,
                hour,
                minute,
                second
            ))
        {
            return FALSE;
        }
    }

    /*
     *  Check notafter;
     */
    pNotAfter   = (PANSC_ASN1_TIME)pValidity->GetChildByIndex(pValidity,1);
    pTimeObject = (PANSC_ASN1_ALTIME)pNotAfter->hSelection;

    if( pTimeObject != NULL)
    {
        if(pTimeObject->IsBefore
            (
                pTimeObject,
                year,
                month,
                day,
                hour,
                minute,
                second
            ))
        {
            return FALSE;
        }
    }

    return TRUE;
}

PKI_KEY_TYPE
AnscAsn1CertGetKeyType
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_SUBJECTPUBLICKEYINFO pPublicKeyInfo;

    if(  pThisObject == NULL)
    {
        return PKI_KEY_RESERVED;
    }

    pPublicKeyInfo = (PANSC_ASN1_SUBJECTPUBLICKEYINFO)
        pThisObject->GetPublicKeyInfo(pThisObject);

    if( pPublicKeyInfo == NULL)
    {
        return PKI_KEY_RESERVED;
    }

    return pPublicKeyInfo->GetPublicKeyType(pPublicKeyInfo);
}

SIGNATURE_TYPE
AnscAsn1CertGetSignatureType
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    CHAR                            pOIDString[128] = { 0 };
    PANSC_ASN1_SIGNATUREALGORITHMIDENTIFIER
                                    pSignature;

    if( pThisObject == NULL)
    {
        return SIGNATURE_RESERVED;
    }

    pSignature = (PANSC_ASN1_SIGNATUREALGORITHMIDENTIFIER)
        pThisObject->GetSignatureAlgorithm(pThisObject);

    if( pSignature == NULL)
    {
        return SIGNATURE_RESERVED;
    }

    pSignature->GetAlgorOIDStringValue(pSignature, pOIDString);

    return PKIOIDStringToSignatureType(pOIDString);
}   

BOOLEAN
AnscAsn1CertSetSignatureType
    (
        ANSC_HANDLE                 hThisObject,
        SIGNATURE_TYPE              signType
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_SIGNATUREALGORITHMIDENTIFIER
                                    pSignature;
    PANSC_ASN1_TBSCERTIFICATE       pTBSCert;
    PANSC_ASN1_ALGORITHMIDENTIFIER  pAlgor;

    /*
     *  There're 2 places need to be set, one is the signature algorithm,
     *  another is the signaturealg in TBSCertificate;
     */
    if( pThisObject == NULL)
    {
        return FALSE;
    }

    pSignature = (PANSC_ASN1_SIGNATUREALGORITHMIDENTIFIER)
        pThisObject->GetSignatureAlgorithm(pThisObject);

    if( pSignature != NULL)
    {
        pSignature->SetAlgorOIDStringValue(pSignature, PKISignTypeToOIDString(signType));
    }

    /* the other one */
    pTBSCert    = (PANSC_ASN1_TBSCERTIFICATE)pThisObject->GetTbsCertificate(pThisObject);
    
    if( pTBSCert == NULL)
    {
        return FALSE;
    }

    pAlgor = (PANSC_ASN1_ALGORITHMIDENTIFIER)
        pTBSCert->GetChildByIndex(pTBSCert,2);

    if( pAlgor != NULL)
    {
        pAlgor->SetAlgorOIDStringValue(pAlgor, PKISignTypeToOIDString(signType));
    }

    return TRUE;
}

BOOLEAN
AnscAsn1CertSetPublicKeyInfo
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hKeyHandle
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_SUBJECTPUBLICKEYINFO pPublicKeyInfo  =NULL;
    PANSC_ASN1_TBSCERTIFICATE       pTBSCert;
    PANSC_ASN1_OBJECT               pKeyObj         = (PANSC_ASN1_OBJECT)hKeyHandle;

    if( hThisObject == NULL || hKeyHandle == NULL)
    {
        return FALSE;
    }

    pTBSCert    = (PANSC_ASN1_TBSCERTIFICATE)pThisObject->GetTbsCertificate(pThisObject);

    if( pTBSCert == NULL)
    {
        return FALSE;
    }

    if( AnscEqualString1(pKeyObj->ClassName, "ANSC_ASN1_SUBJECTPUBLICKEYINFO",FALSE))
    {
        return (ANSC_STATUS_SUCCESS == 
                 pTBSCert->SetChildByIndex
                    (
                        pTBSCert, 
                        hKeyHandle, 
                        6,
                        TRUE
                    )); 
    }
    else if( AnscEqualString1(pKeyObj->ClassName, "ANSC_ASN1_PUBLICKEY",FALSE))
    {
        hKeyHandle = ((PANSC_ASN1_CHOICE)pKeyObj)->hSelection;

        if( hKeyHandle == NULL ||
            AnscEqualString1
            (
                ((PANSC_ASN1_OBJECT)hKeyHandle)->ClassName,
                "ANSC_ASN1_DSAPUBLICKEY",
                FALSE
            )
          )
        {
            return FALSE;
        }
        /* RSA Key */
    }
    else if( !AnscEqualString1(pKeyObj->ClassName, "ANSC_ASN1_RSAPUBLICKEY",FALSE))
    {
        return FALSE;
    }

    /* else set the key  */
    pPublicKeyInfo = (PANSC_ASN1_SUBJECTPUBLICKEYINFO)pTBSCert->GetChildByIndex(pTBSCert,6);

    if( pPublicKeyInfo == NULL)
    {
        return FALSE;
    }

    return 
        pPublicKeyInfo->InitPublicKey
            (
                pPublicKeyInfo,
                PKI_RSA_KEY,
                pKeyObj,
                NULL
            );
}

BOOLEAN
AnscAsn1CertVerify
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hPublicKeyInfo
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_RSAPUBLICKEY         pRSAKey         = NULL;
    PANSC_ASN1_PUBLICKEY            pPublicKey      = NULL;
    PANSC_ASN1_SUBJECTPUBLICKEYINFO pPublicKeyInfo  = NULL;
    PANSC_ASN1_OBJECT               pKeyObject;
    PANSC_ASN1_OBJECT               pSelection;
    PANSC_ASN1_BITSTRING            pBitString;
    PANSC_ASN1_TBSCERTIFICATE       pTBSCert;
    PUCHAR                          pSignature;
    ANSC_STATUS                     status;

    if( pThisObject == NULL)
    {
        return FALSE;
    }

    if( hPublicKeyInfo == NULL)
    {
        if( pThisObject->IsSelfSigned(pThisObject))
        {
            hPublicKeyInfo = pThisObject->GetPublicKeyInfo(pThisObject);
        }
        else
        {
            return FALSE;
        }
    }

    if( hPublicKeyInfo == NULL)
    {
        AnscTrace("The public key information is not provided, failed to verify the certificate.\n");

        return FALSE;
    }

    /* check the public key */
    pKeyObject = (PANSC_ASN1_OBJECT)hPublicKeyInfo;

    if( AnscEqualString1(pKeyObject->ClassName,"ANSC_ASN1_RSAPUBLICKEY",FALSE))
    {
        pRSAKey = (PANSC_ASN1_RSAPUBLICKEY)pKeyObject;
    }
    else if( AnscEqualString1(pKeyObject->ClassName,"ANSC_ASN1_PUBLICKEY",FALSE))
    {
        pPublicKey  = (PANSC_ASN1_PUBLICKEY)pKeyObject;
        pSelection  = (PANSC_ASN1_OBJECT)pPublicKey->hSelection;

        if( pSelection == NULL || 
            !AnscEqualString1(pSelection->ClassName,"ANSC_ASN1_RSAPUBLICKEY", FALSE))
        {
            return FALSE;
        }

        pRSAKey = (PANSC_ASN1_RSAPUBLICKEY)pSelection;
    }
    else
    {
        pPublicKeyInfo  =(PANSC_ASN1_SUBJECTPUBLICKEYINFO)hPublicKeyInfo;
    }

    /* get the data to be verified */
    if( pThisObject->pSignedData == NULL || pThisObject->uSignedLength == 0)
    {
        pTBSCert    = (PANSC_ASN1_TBSCERTIFICATE)pThisObject->GetTbsCertificate(pThisObject);

        pThisObject->pSignedData = 
            pTBSCert->GetEncodedData
                (
                    pTBSCert,
                    &pThisObject->uSignedLength
                );
    }

    if( pThisObject->pSignedData == NULL || pThisObject->uSignedLength == 0)
    {
        return FALSE;
    }

    /* get the signature object */
    pBitString = pThisObject->GetSignatureValue(pThisObject);

    if( pBitString->uLength <= 4)
    {
        AnscTrace("Invalid signature (len = %lu)\n", pBitString->uLength);

        return FALSE;
    }

    if( pBitString->bIsDynamic)
    {
        pSignature = pBitString->pStringBuffer;
    }
    else
    {
        pSignature = pBitString->pString;
    }

    /* verify now */
    if( pRSAKey != NULL)
    {
        status =
            pRSAKey->Verify
                (
                    pRSAKey,
                    NULL,
                    pThisObject->pSignedData,
                    pThisObject->uSignedLength,
                    pThisObject->GetSignatureType(pThisObject),
                    pSignature,
                    pBitString->uLength
                );
    }
    else
    {
        status =
            pPublicKeyInfo->Verify
                (
                    pPublicKeyInfo,
                    pThisObject->pSignedData,
                    pThisObject->uSignedLength,
                    pThisObject->GetSignatureType(pThisObject),
                    pSignature,
                    pBitString->uLength
                );
    }

    return (ANSC_STATUS_SUCCESS == status);
}

BOOLEAN
AnscAsn1CertIsPathValid
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       pathLength
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     = (PANSC_ASN1_CERTIFICATE)hThisObject;
    BOOLEAN                         bIsCA;
    LONG                            MaxiPath        = -1;

    if( pThisObject == NULL)
    {
        return FALSE;
    }

    if( ANSC_STATUS_SUCCESS !=
            pThisObject->GetBasicConstraint
                (
                    pThisObject,
                    &bIsCA,
                    &MaxiPath
                ))
    {
        /* no basic contraint extension */
        return TRUE;
    }

    /* if it's not ca, that's too bad */
    if( !bIsCA)
    {
        return FALSE;
    }

    if( MaxiPath >= 0)
    {
        return (MaxiPath >= (LONG)pathLength);
    }

    return TRUE;
}


ANSC_STATUS
AnscAsn1CertVerifyChildCert
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hChildCert
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_CERTIFICATE          pChildCert      =(PANSC_ASN1_CERTIFICATE)hChildCert;
    PANSC_ASN1_EXTENSION            pExtension;
    ULONG                           ulKeyUsage;

    if( hThisObject == NULL || hChildCert == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    /* verify it's the issuer */
    if(!pChildCert->IsThisTheIssuer(pChildCert, pThisObject))
    {
        AnscTrace("Not the issuer in 'VerifyChildCert'.\n");

        return ANSC_STATUS_FAILURE;
    }

    /* verify the signature first */
    if( !pChildCert->VerifySignature
            (
                pChildCert,
                pThisObject->GetPublicKeyInfo(pThisObject)
            )
      )
    {
        AnscTrace("Failed to verify the cert.\n");

        return ANSC_STATUS_FAILURE;
    }

    /* if the cert is itself, return */
    if(hThisObject == hChildCert)
    {
        return ANSC_STATUS_SUCCESS;
    }

    /******************************************************
     *
     * check the other information
     *****************************************************/
    /*
     * if the current certificate is supposed to be CA's certificate, we should examine the key usage extension if it
     * exists; if this extension is marked as critical, we should make sure the keyCertSign bit and 'digital sign' 
     * are asserted
     */
    pExtension = (PANSC_ASN1_EXTENSION)
        pThisObject->FindExtensionWithType
            (
                pThisObject,
                EXTENSIONVALUE_MASK_KEYUSAGE,
                FALSE
            );

    if( pExtension != NULL)
    {
        /*
         * The key usage extension defines the purpose (e.g., encipherment,
         * signature, certificate signing) of the key contained in the
         * certificate.  The usage restriction might be employed when a key that
         * could be used for more than one operation is to be restricted.  For
         * example, when an RSA key should be used only for signing, the
         * digitalSignature and/or nonRepudiation bits would be asserted.
         * Likewise, when an RSA key should be used only for key management, the
         * keyEncipherment bit would be asserted. When used, this extension
         * SHOULD be marked critical.
         */
        
         /* 
          * From RFC2459, the KeyUsage extension is supposed to be critical, but as
          * a matter of fact, most CAs such as "isakmptest.ssh.fi" are not aware of 
          * this, they just bypassed the value of "bCritical" as optional, whose default 
          * value is FALSE. 
          *
          * To interoperate with those CAs, we have to ignore this check.
          */ 

        /*
        if( !pExtension->IsCritical(pExtension))
        {
            AnscTrace("KeyUsage in the cert is non-critical.\n");

            return ANSC_STATUS_FAILURE;
        }
        else
        */
        {
            pThisObject->GetKeyUsage
                (
                    pThisObject,
                    &ulKeyUsage
                );

            if( (ulKeyUsage & KEY_USAGE_KEYCERTSIGN_MASK)   == 0        ||
                (ulKeyUsage & KEY_USAGE_DIGITALSIGNATURE_MASK) == 0)
            {
                AnscTrace("Failed to check the keyusage.\n");

                return ANSC_STATUS_FAILURE;
            }
        }
    }

    /*
     * The same thing as above extension.
     */
    /*
    pExtension = (PANSC_ASN1_EXTENSION)
        pThisObject->FindExtensionWithType
            (
                pThisObject,
                EXTENSIONVALUE_MASK_BASICCONSTRAINTS,
                FALSE
            );

    if( pExtension != NULL && !pExtension->IsCritical(pExtension))
    {
        AnscTrace("BasicConstraints is non-critical.\n");
        return ANSC_STATUS_FAILURE;
    }
    */

    return ANSC_STATUS_SUCCESS;
}


ANSC_STATUS
AnscAsn1CertBeforeDecodingChild
    (
        ANSC_HANDLE                 hThisObject,
        int                         index,
        PVOID*                      ppEncoding
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject  = (PANSC_ASN1_CERTIFICATE)hThisObject;

    if( pThisObject != NULL && index == 0)
    {
        /* free the signed data part */
        if( pThisObject->pSignedData != NULL && pThisObject->uSignedLength > 0)
        {
            AnscFreeMemory(pThisObject->pSignedData);
        }

        pThisObject->pSignedData    = *ppEncoding;
        pThisObject->uSignedLength  = 0;
    }

    return ANSC_STATUS_SUCCESS;
}

ANSC_STATUS
AnscAsn1CertAfterDecodingChild
    (
        ANSC_HANDLE                 hThisObject,
        int                         index,
        PVOID*                      ppEncoding
    )
{
    UNREFERENCED_PARAMETER(ppEncoding);
    PANSC_ASN1_CERTIFICATE          pThisObject  = (PANSC_ASN1_CERTIFICATE)hThisObject;
    PUCHAR                          pEndBuffer   = *ppEncoding;
    PUCHAR                          pBack;

    if( pThisObject != NULL && index == 0)
    {
        pThisObject->uSignedLength  = pEndBuffer - pThisObject->pSignedData;

        /* make a copy here */
        pBack = pThisObject->pSignedData;

        pThisObject->pSignedData
            = (PUCHAR)AnscAllocateMemory(pThisObject->uSignedLength + 8);

        if( pThisObject->pSignedData != NULL)
        {
            AnscCopyMemory
                (
                    pThisObject->pSignedData,
                    pBack,
                    pThisObject->uSignedLength
                );
        }
        else
        {
            pThisObject->uSignedLength = 0;
        }
    }

    return ANSC_STATUS_SUCCESS;
}

ANSC_STATUS
AnscAsn1CertAfterDecoding
    (
        ANSC_HANDLE                 hThisObject,
        PVOID*                      ppEncoding
    )
{
    UNREFERENCED_PARAMETER(ppEncoding);
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;

    if( pThisObject->IsSelfSigned(pThisObject))
    {
    }

    return ANSC_STATUS_SUCCESS;
}

ANSC_HANDLE
AnscAsn1CertGetSerialNumber
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_TBSCERTIFICATE       pTBSCert;

    if( hThisObject == NULL)
    {
        return NULL;
    }

    pTBSCert = (PANSC_ASN1_TBSCERTIFICATE)pThisObject->GetTbsCertificate(pThisObject);

    if( pTBSCert == NULL)
    {
        return NULL;
    }

    return pTBSCert->GetChildByIndex(pTBSCert,1);
}

ANSC_HANDLE
AnscAsn1CertGetIssuerHandle
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_TBSCERTIFICATE       pTBSCert;

    if( hThisObject == NULL)
    {
        return NULL;
    }

    pTBSCert = (PANSC_ASN1_TBSCERTIFICATE)pThisObject->GetTbsCertificate(pThisObject);

    if( pTBSCert == NULL)
    {
        return NULL;
    }

    return  pTBSCert->GetChildByIndex(pTBSCert,3);

}


ANSC_HANDLE
AnscAsn1CertGetSubjectHandle
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_TBSCERTIFICATE       pTBSCert;

    if( hThisObject == NULL)
    {
        return NULL;
    }

    pTBSCert = (PANSC_ASN1_TBSCERTIFICATE)pThisObject->GetTbsCertificate(pThisObject);

    if( pTBSCert == NULL)
    {
        return NULL;
    }

    return  pTBSCert->GetChildByIndex(pTBSCert,5);
}

ANSC_HANDLE
AnscAsn1CertGetExtensionsHandle
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_TBSCERTIFICATE       pTBSCert;

    if( hThisObject == NULL)
    {
        return NULL;
    }

    pTBSCert = (PANSC_ASN1_TBSCERTIFICATE)pThisObject->GetTbsCertificate(pThisObject);

    if( pTBSCert == NULL)
    {
        return NULL;
    }

    return  pTBSCert->GetChildByIndex(pTBSCert,9);
}

ANSC_HANDLE
AnscAsn1CertGetPublicKeyInfo
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_TBSCERTIFICATE       pTBSCert;

    if( hThisObject == NULL)
    {
        return NULL;
    }

    pTBSCert = (PANSC_ASN1_TBSCERTIFICATE)pThisObject->GetTbsCertificate(pThisObject);

    if( pTBSCert == NULL)
    {
        return NULL;
    }

    return pTBSCert->GetChildByIndex(pTBSCert,6);
}

BOOLEAN
AnscAsn1CertIsThisTheIssuer
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hIssuerCert
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_CERTIFICATE          pIssuerCert     =(PANSC_ASN1_CERTIFICATE)hIssuerCert;
    PANSC_ASN1_STRING               pSubKeyIdenObj;
    PANSC_ASN1_SEQUENCE             pAuthExt;
    PANSC_ASN1_STRING               pAuthIdenObj;
    PANSC_ASN1_NAME                 pIssuerName, pSubjectName;
    PANSC_ASN1_OBJECT               pIssuerExt, pSubjectExt;

    if( hThisObject == NULL || hIssuerCert == NULL)
    {
        return FALSE;
    }

    if( pThisObject->IsSelfSigned(pThisObject))
    {
        /* if it's selfsigned cert, we suppose they are the same handle */
        return (hIssuerCert == hThisObject);
    }

    /* The easiest way to check if it matched or not is checking the key identifier */
    pAuthExt = (PANSC_ASN1_SEQUENCE)
        pThisObject->FindExtensionWithType
            (
                pThisObject,
                EXTENSIONVALUE_MASK_AUTHORITYKEYIDENTIFIER,
                TRUE
            );

    pSubKeyIdenObj = (PANSC_ASN1_STRING)
        pIssuerCert->FindExtensionWithType
            (
                pIssuerCert,
                EXTENSIONVALUE_MASK_SUBJECTKEYIDENTIFIER,
                TRUE
            );

    if( pAuthExt != NULL && pSubKeyIdenObj != NULL)
    {
        pAuthIdenObj = (PANSC_ASN1_STRING)pAuthExt->GetChildByIndex(pAuthExt,0);

        if( pAuthIdenObj != NULL && !pAuthIdenObj->bOptional)
        {
            /* check the key identifier matched or not */
            return pAuthIdenObj->EqualsTo(pAuthIdenObj, pSubKeyIdenObj, TRUE);
        }
    }

    /* check the name matched or not */
    pIssuerName     = (PANSC_ASN1_NAME)pThisObject->GetIssuerHandle(pThisObject);
    pSubjectName    = (PANSC_ASN1_NAME)pIssuerCert->GetSubjectHandle(pIssuerCert);

    if( pIssuerName != NULL && pIssuerName->hSelection != NULL &&
        ((PANSC_ASN1_RDNSEQUENCE)pIssuerName->hSelection)->GetChildCount(pIssuerName->hSelection) > 0)
    {

#ifdef _DEBUG
        {
            CHAR         pBuffer[512] = { 0 };
            ULONG        length       = 512;

            pIssuerName->ExportToString(pIssuerName, pBuffer, &length);
            AnscTrace("The issuerName is '%s'\n", pBuffer);

            AnscZeroMemory(pBuffer, 512);
            length = 512;

            pSubjectName->ExportToString(pSubjectName, pBuffer, &length);
            AnscTrace("The subjectName is '%s'\n", pBuffer);
        }

#endif
        return pIssuerName->EqualsTo(pIssuerName, pSubjectName, TRUE);
    }

    /*
     * issuer's name and subject's name are empty in certificate, 
     * we should examine the alternative names instead
     */
    pIssuerExt = (PANSC_ASN1_OBJECT)
        pThisObject->FindExtensionWithType
            (
                pThisObject, 
                EXTENSIONVALUE_MASK_ISSERALTNAME, 
                TRUE
            );

    pSubjectExt = (PANSC_ASN1_OBJECT)
        pIssuerCert->FindExtensionWithType
            (
                pIssuerCert, 
                EXTENSIONVALUE_MASK_SUBJECTALTNAME, 
                TRUE
            );

    if( pIssuerExt != NULL && pSubjectExt != NULL)
    {
        return pIssuerExt->EqualsTo
                    (
                        pIssuerExt,
                        pSubjectExt,
                        TRUE
                    );
    }
    
    return FALSE;
}

ANSC_HANDLE
AnscAsn1CertFindExtensionWithOID
    (
        ANSC_HANDLE                 hThisObject,
        PCHAR                       pOIDValueString,
        BOOLEAN                     bReturnValueHandle
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_EXTENSIONVALUE       pNewExtValue;
    LONG                            selType;

    if( hThisObject == NULL || pOIDValueString == NULL)
    {
        return NULL;
    }

    /* create a ExtensionValue object to check the input OID value */
    pNewExtValue = (PANSC_ASN1_EXTENSIONVALUE)AnscAsn1CreateExtensionValue(NULL);

    if( pNewExtValue == NULL)
    {
        return NULL;
    }

    selType = pNewExtValue->GetChoiceFromOID(pNewExtValue, pOIDValueString);

    /* don't forget removing this extension */
    pNewExtValue->AsnFree(pNewExtValue);

    if( selType < 0)
    {
       return NULL;
    }

    return pThisObject->FindExtensionWithType(pThisObject, selType, bReturnValueHandle);
}

/*
 *  Get the extension with the type.
 *
 *  The selType was defined in 
 *  "ansc_asn1_extensions_interface.h"
 */

ANSC_HANDLE
AnscAsn1CertFindExtensionWithType
    (
        ANSC_HANDLE                 hThisObject,
        UINT                        selType,
        BOOLEAN                     bReturnValueHandle
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_TBSCERTIFICATE       pTBSCert;
    PANSC_ASN1_EXTENSIONS           pExtensions;
    PANSC_ASN1_EXTENSION            pExtension;
    PANSC_ASN1_EXTENSIONVALUE       pExtValue;
    ULONG                           i;

    if( pThisObject == NULL)
    {
        return NULL;
    }

    pTBSCert    = (PANSC_ASN1_TBSCERTIFICATE)pThisObject->GetTbsCertificate(pThisObject);

    if( pTBSCert == NULL)
    {
        return NULL;
    }

    pExtensions = (PANSC_ASN1_EXTENSIONS)pTBSCert->GetChildByIndex(pTBSCert,9);

    if( pExtensions == NULL || pExtensions->bOptional)
    {
        return NULL;
    }

    for( i = 0; i < pExtensions->GetChildCount(pExtensions); i ++)
    {
        pExtension = (PANSC_ASN1_EXTENSION)pExtensions->GetChildByIndex(pExtensions,i);

        if( pExtension != NULL)
        {
            pExtValue = (PANSC_ASN1_EXTENSIONVALUE)pExtension->GetExtraChild(pExtension);

            if( pExtValue != NULL && pExtValue->lSelect == (LONG)selType)
            {
                if(bReturnValueHandle)
                {
                    return pExtValue->hSelection;
                }
                else
                {
                    return pExtension;
                }
            }
        }        
    }

    return NULL;

}

ANSC_HANDLE
AnscAsn1CertGetSubjectAltName
    (
        ANSC_HANDLE                 hThisObject,
        BOOLEAN                     bReturnValueHandle
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;

    if( hThisObject == NULL)
    {
        return NULL;
    }

    return 
        pThisObject->FindExtensionWithType
            (
                pThisObject, 
                EXTENSIONVALUE_MASK_SUBJECTALTNAME,
                bReturnValueHandle
            );
}

ANSC_STATUS
AnscAsn1CertGetBasicConstraint
    (
        ANSC_HANDLE                 hThisObject,
        PBOOLEAN                    pIsCA,
        PLONG                       pPathLength
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_SEQUENCE             pBasicConObj;
    PANSC_ASN1_BOOL                 pBoolObj;
    PANSC_ASN1_INTEGER              pIntObj;

    if( hThisObject == NULL || pIsCA == NULL || pPathLength == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pBasicConObj = (PANSC_ASN1_SEQUENCE)
        pThisObject->FindExtensionWithType
            (
                pThisObject, 
                EXTENSIONVALUE_MASK_BASICCONSTRAINTS,
                TRUE
            );

    if( pBasicConObj == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    /* check the isCA value */
    pBoolObj = (PANSC_ASN1_BOOL)pBasicConObj->GetChildByIndex(pBasicConObj, 0);

    if( pBoolObj == NULL || pBoolObj->bOptional)
    {
        *pIsCA = FALSE;
    }
    else
    {
        *pIsCA = pBoolObj->GetBooleanValue(pBoolObj);
    }

    /* check the path length value */
    pIntObj = (PANSC_ASN1_INTEGER)pBasicConObj->GetChildByIndex(pBasicConObj,1);

    if( pIntObj == NULL || pIntObj->bOptional)
    {
        *pPathLength = -1;
    }
    else
    {
        *pPathLength = pIntObj->GetIntegerValue(pIntObj);
    }

    return ANSC_STATUS_SUCCESS;
}

ANSC_STATUS
AnscAsn1CertGetSubjectKeyIdentifier
    (
        ANSC_HANDLE                 hThisObject,
        PUCHAR*                     ppBuffer,
        PULONG                      pLength
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_STRING               pStrObj;

    if( hThisObject == NULL || ppBuffer == NULL || pLength == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pStrObj = (PANSC_ASN1_STRING)
        pThisObject->FindExtensionWithType
            (
                pThisObject,
                EXTENSIONVALUE_MASK_SUBJECTKEYIDENTIFIER,
                TRUE
            );

    if( pStrObj == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    return pStrObj->GetStringValue(pStrObj, ppBuffer, pLength);
}

ANSC_STATUS
AnscAsn1CertGetAuthorityIdentifier
    (
        ANSC_HANDLE                 hThisObject,
        PUCHAR*                     ppBuffer,
        PULONG                      pLength
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_SEQUENCE             pAuthObj;
    PANSC_ASN1_STRING               pStrObj;

    if( hThisObject == NULL || ppBuffer == NULL || pLength == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pAuthObj = (PANSC_ASN1_SEQUENCE)
        pThisObject->FindExtensionWithType
            (
                pThisObject,
                EXTENSIONVALUE_MASK_AUTHORITYKEYIDENTIFIER,
                TRUE
            );

    if( pAuthObj == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pStrObj = (PANSC_ASN1_STRING)pAuthObj->GetChildByIndex(pAuthObj, 0);

    if( pStrObj == NULL || pStrObj->bOptional)
    {
        return ANSC_STATUS_FAILURE;
    }

    return pStrObj->GetStringValue(pStrObj, ppBuffer, pLength);
}

ANSC_STATUS
AnscAsn1CertGetKeyUsage
    (
        ANSC_HANDLE                 hThisObject,
        PULONG                      pKeyUsage
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     = (PANSC_ASN1_CERTIFICATE)hThisObject;
    ULONG                           longValue       = 0;
    PUCHAR                          pBuffer;
    PANSC_ASN1_STRING               pStrObj;

    if( hThisObject == NULL || pKeyUsage == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pStrObj = (PANSC_ASN1_STRING)
        pThisObject->FindExtensionWithType
            (
                pThisObject,
                EXTENSIONVALUE_MASK_KEYUSAGE,
                TRUE
            );

    if( pStrObj == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pBuffer = pStrObj->GetValueBuffer(pStrObj);

    if( pBuffer == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    if( pStrObj->uLength == 1)
    {
        longValue += (ULONG)pBuffer[0];       
    }
    else
    {
        longValue += ((ULONG)pBuffer[0]) << 8;
        longValue += pBuffer[1];
    }

    *pKeyUsage = longValue;

    return ANSC_STATUS_SUCCESS;
}

ANSC_STATUS
AnscAsn1CertGetCDPString
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       cdpType,
        PCHAR                       pBuffer,
        PULONG                      pLength
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     = (PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_SEQUENCEOF           pValueObj;
    PANSC_ASN1_DISTRIBUTIONPOINT    pCDPObj;
    ULONG                           i;
    PANSC_ASN1_DISTRIBUTIONPOINTNAME
                                    pCDPNameObj;
    PANSC_ASN1_GENERALNAMES         pGenNames;
    PANSC_ASN1_GENERALNAME          pGenName;
    PANSC_ASN1_STRING               pStrObj;
    PUCHAR                          pValueBuffer;

    if(hThisObject == NULL || pBuffer == NULL || pLength == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }


    pValueObj = (PANSC_ASN1_SEQUENCEOF)
        pThisObject->FindExtensionWithType
            (
                pThisObject, 
                EXTENSIONVALUE_MASK_CRLDISTPOINTSSYNTAX,
                TRUE
            );

    if( pValueObj == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    for( i = 0; i < pValueObj->GetChildCount(pValueObj); i ++)
    {
        pCDPObj = (PANSC_ASN1_DISTRIBUTIONPOINT)
            pValueObj->GetChildByIndex(pValueObj, i);

        if( pCDPObj != NULL)
        {
            pCDPNameObj = (PANSC_ASN1_DISTRIBUTIONPOINTNAME)
                pCDPObj->GetChildByIndex(pCDPObj,0);

            if( pCDPNameObj != NULL && !pCDPNameObj->bOptional &&
                pCDPNameObj->lSelect == DISTRIBUTIONPOINTNAME_MASK_FULLNAME  &&
                pCDPNameObj->hSelection != NULL)
            {
                pGenNames = (PANSC_ASN1_GENERALNAMES)pCDPNameObj->hSelection;

                pGenName  = (PANSC_ASN1_GENERALNAME)pGenNames->GetChildByIndex(pGenNames, 0);

                if( pGenName != NULL && pGenName->lSelect == GENERALNAME_MASK_URI &&
                    pGenName->hSelection != NULL)
                {
                    pStrObj = (PANSC_ASN1_STRING)pGenName->hSelection;

                    pValueBuffer = pStrObj->GetValueBuffer(pStrObj);

                    /* check it's http or url */
                    if(cdpType == EXTENSION_CDP_LDAP)
                    {
                        if( AnscStrStr((const char*)pValueBuffer, "ldap") == (char*)pValueBuffer ||
                            AnscStrStr((const char*)pValueBuffer, "LDAP") == (char*)pValueBuffer )
                        {
                            if( pStrObj->uLength >= *pLength)
                            {
                                AnscTrace("Short buffer size.\n");
                                return ANSC_STATUS_FAILURE;
                            }

                            AnscCopyMemory
                               (
                                  pBuffer,
                                  pValueBuffer,
                                  pStrObj->uLength
                               );

                            *pLength = pStrObj->uLength;

                            return ANSC_STATUS_SUCCESS;
                        }
                    }
                    else /* supposes it's http */
                    {
                        if( AnscStrStr((const char*)pValueBuffer, "http") == (char*)pValueBuffer ||
                            AnscStrStr((const char*)pValueBuffer, "HTTP") == (char*)pValueBuffer )
                        {

                            if( pStrObj->uLength >= *pLength)
                            {
                                AnscTrace("Short buffer size.\n");
                                return ANSC_STATUS_FAILURE;
                            }

                            AnscCopyMemory
                               (
                                  pBuffer,
                                  pValueBuffer,
                                  pStrObj->uLength
                               );

                            *pLength = pStrObj->uLength;

                            return ANSC_STATUS_SUCCESS;
                        }
                    }
                }
            }
        }
    }

    return ANSC_STATUS_FAILURE;
}

BOOLEAN
AnscAsn1CertIsExtKeyusageIncluded
    (
        ANSC_HANDLE                 hThisObject,
        PCHAR                       pOIDString
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     = (PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_SEQUENCEOF           pValueObj;
    PANSC_ASN1_OIDEN                pOIDObject;
    ULONG                           i;

    if( hThisObject == NULL || pOIDString == NULL)
    {
        return FALSE;
    }

    pValueObj = (PANSC_ASN1_SEQUENCEOF)
        pThisObject->FindExtensionWithType
            (
                pThisObject, 
                EXTENSIONVALUE_MASK_EXTKEYUSAGESYNTAX,
                TRUE
            );

    if( pValueObj == NULL)
    {
        return FALSE;
    }

    /* check for the OID */
    for( i = 0; i < pValueObj->GetChildCount(pValueObj); i ++)
    {
        pOIDObject = (PANSC_ASN1_OIDEN)pValueObj->GetChildByIndex(pValueObj, i);

        if( pOIDObject != NULL)
        {
            if( pOIDObject->EqualToOIDString(pOIDObject, pOIDString))
            {
                return TRUE;
            }
        }
    }

    return FALSE;
}


BOOLEAN
AnscAsn1CertIsKeyMatching
    (
        ANSC_HANDLE                 hThisObject,
        PKI_KEY_TYPE                keyType,
        ANSC_HANDLE                 hKeyHandle
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     = (PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_SUBJECTPUBLICKEYINFO pKeyInfo;

    if( hThisObject == NULL || hKeyHandle == NULL)
    {
        return FALSE;
    }

    pKeyInfo = (PANSC_ASN1_SUBJECTPUBLICKEYINFO)
        pThisObject->GetPublicKeyInfo(pThisObject);

    if( pKeyInfo == NULL)
    {
        return FALSE;
    }

    if( keyType != pKeyInfo->GetPublicKeyType(pKeyInfo))
    {
        return FALSE;
    }

    return pKeyInfo->IsKeyMatching(pKeyInfo, keyType, hKeyHandle);
}

ANSC_STATUS
AnscAsn1CertExportPublicKey
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hKeyGenParams
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     = (PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_SUBJECTPUBLICKEYINFO pKeyInfo;

    if( hThisObject == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pKeyInfo = (PANSC_ASN1_SUBJECTPUBLICKEYINFO)
        pThisObject->GetPublicKeyInfo(pThisObject);

    if( pKeyInfo == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    return pKeyInfo->ExportPublicKey(pKeyInfo, hKeyGenParams);
}

BOOLEAN
AnscAsn1CertGetCommonName
    (
        ANSC_HANDLE                 hThisObject,
        PCHAR                       pString,
        PULONG                      pLength
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     = (PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_NAME                 pName;

    if( hThisObject == NULL || pLength == NULL || pString  == NULL)
    {
        return FALSE;
    }

    pName = (PANSC_ASN1_NAME)
        pThisObject->GetSubjectHandle(pThisObject);

    return pName->GetCommonName(pName, pString, pLength);
}

BOOLEAN
AnscAsn1CertGetNameByOID
    (
        ANSC_HANDLE                 hThisObject,
        PCHAR                       pOIDString,
        PCHAR                       pString,
        PULONG                      pLength
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     = (PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_NAME                 pName;

    if( hThisObject == NULL || pLength == NULL || pString  == NULL)
    {
        return FALSE;
    }

    pName = (PANSC_ASN1_NAME)
        pThisObject->GetSubjectHandle(pThisObject);

    return pName->GetNameByOID(pName, pOIDString, pString, pLength);
}

/**********************************************************************
 *
 * This function is to get the encoding of DN name of the certificate,
 * the subjectAltName will be used if the DN name is empty.
 *
 **********************************************************************/
ANSC_STATUS
AnscAsn1CertGetNameEncoding
    (
        ANSC_HANDLE                 hThisObject,
        PVOID                       pNameEncoding,
        PULONG                      pulNameEncodingSize
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     = (PANSC_ASN1_CERTIFICATE)hThisObject;
    PUCHAR                          pBack           = (PUCHAR)pNameEncoding;
    PANSC_ASN1_NAME                 pName;
    PANSC_ASN1_GENERALNAMES         pAltName;
    PANSC_ASN1_OBJECT               pValueObj;
    LONG                            length;

    if( hThisObject == NULL || pNameEncoding == NULL || pulNameEncodingSize == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    /* get the name object, either DN name or check name */
    pName = (PANSC_ASN1_NAME)
        pThisObject->GetSubjectHandle(pThisObject);

    if( pName != NULL && !pName->IsNameEmpty(pName))
    {
        pValueObj = (PANSC_ASN1_OBJECT)pName;
    }
    else
    {
        /* check the subjectAltName */
        pAltName = (PANSC_ASN1_GENERALNAMES)
            pThisObject->FindExtensionWithType
                (
                    pThisObject,
                    EXTENSIONVALUE_MASK_SUBJECTALTNAME,
                    TRUE
                );

        if( pAltName == NULL)
        {
            return ANSC_STATUS_FAILURE;
        }

        pValueObj = (PANSC_ASN1_OBJECT)pAltName;
    }

    /* check the encoding */
    length = pValueObj->GetSizeOfEncoded(pValueObj);

    if( length > (LONG)*pulNameEncodingSize)
    {
        *pulNameEncodingSize = length;

        return ANSC_STATUS_FAILURE;
    }

    if( length < 0)
    {
        /* not ready to encode */
        return ANSC_STATUS_FAILURE;
    }

    *pulNameEncodingSize = length;

    return
        pValueObj->EncodingData
            (
               pValueObj,
               (PVOID*)&pBack
            );
}

BOOLEAN
AnscAsn1CertIsRDNNameEmpty
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     = (PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_NAME                 pName;

    if( hThisObject == NULL)
    {
        return FALSE;
    }

    pName = (PANSC_ASN1_NAME)
        pThisObject->GetSubjectHandle(pThisObject);

    if( pName == NULL)
    {
        return FALSE;
    }

    return pName->IsNameEmpty(pName);
}

ULONG
AnscAsn1CertGetKeyBits
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     = (PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_SUBJECTPUBLICKEYINFO pPublicKeyInfo  = NULL;

    pPublicKeyInfo = (PANSC_ASN1_SUBJECTPUBLICKEYINFO)pThisObject->GetPublicKeyInfo(pThisObject);

    if( pPublicKeyInfo == NULL)
    {
        return 0;
    }

    return pPublicKeyInfo->GetPublicKeyBits(pPublicKeyInfo);
}

BOOLEAN
AnscAsn1CertSignWithKeyParam
    (
        ANSC_HANDLE                 hThisObject,
        PKI_KEY_TYPE                keyType,
        ANSC_HANDLE                 hKeyPairHandle
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_PRIVATEKEYINFO       pKeyInfo;
    BOOLEAN                         bResult;

    if( keyType != pThisObject->GetKeyType(pThisObject))
    {
        return FALSE;
    }

    pKeyInfo = (PANSC_ASN1_PRIVATEKEYINFO)
        AnscAsn1CreatePrivateKeyInfoWithKey( NULL, keyType, hKeyPairHandle);

    if( pKeyInfo == NULL)
    {
        return FALSE;
    }

    bResult = 
        pThisObject->SignWithPrivateKeyInfo
            (
                pThisObject,
                pKeyInfo
            );

    pKeyInfo->AsnFree(pKeyInfo);

    return bResult;
}

BOOLEAN
AnscAsn1CertSignWithPrivateKeyInfo
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hPrivateKeyInfo
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_TBSCERTIFICATE       pTBSCert;
    PANSC_ASN1_PRIVATEKEYINFO       pPrivateKeyInfo = (PANSC_ASN1_PRIVATEKEYINFO)hPrivateKeyInfo;
    ULONG                           uSignLength     = 1024;
    PUCHAR                          pSignature;
    PANSC_ASN1_BITSTRING            pStringObject;

    if( hThisObject == NULL)
    {
        return FALSE;
    }

    pTBSCert = (PANSC_ASN1_TBSCERTIFICATE)pThisObject->GetTbsCertificate(pThisObject);

    if( pTBSCert == NULL)
    {
        return FALSE;
    }

    /* check the signed data */
    if( pThisObject->pSignedData == NULL || pThisObject->uSignedLength == 0)
    {
        pThisObject->pSignedData =
            pTBSCert->GetEncodedData(pTBSCert, &pThisObject->uSignedLength);
    }

    if( pThisObject->pSignedData == NULL)
    {
        return FALSE;
    }

    /* create the buffer to get the signature; */
    pSignature = (PUCHAR)AnscAllocateMemory(uSignLength);

    if( pSignature == NULL)
    {
        return FALSE;
    }

    if( ANSC_STATUS_SUCCESS !=
            pPrivateKeyInfo->SignData            
                (
                    pPrivateKeyInfo,
                    pThisObject->pSignedData,
                    pThisObject->uSignedLength,
                    pThisObject->GetSignatureType(pThisObject),
                    pSignature,
                    &uSignLength
                ))
    {
        AnscFreeMemory(pSignature);

        return FALSE;
    }

    pStringObject = (PANSC_ASN1_BITSTRING)pThisObject->GetSignatureValue(pThisObject);

    pStringObject->SetStringValue(pStringObject, pSignature, uSignLength);

    AnscFreeMemory(pSignature);

    return TRUE;

}

BOOLEAN
AnscAsn1CertSignWithCryptAPI
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hCryptAPI
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     =(PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_TBSCERTIFICATE       pTBSCert;
    PCRYPT_API_STRUCT               pCrypto         = (PCRYPT_API_STRUCT)hCryptAPI;
    ULONG                           uSignLength     = 1024;
    PUCHAR                          pSignature;
    PANSC_ASN1_BITSTRING            pStringObject;

    if( hThisObject == NULL)
    {
        return FALSE;
    }

    pTBSCert = (PANSC_ASN1_TBSCERTIFICATE)pThisObject->GetTbsCertificate(pThisObject);

    if( pTBSCert == NULL)
    {
        return FALSE;
    }

    /* check the signed data */
    if( pThisObject->pSignedData == NULL || pThisObject->uSignedLength == 0)
    {
        pThisObject->pSignedData =
            pTBSCert->GetEncodedData(pTBSCert, &pThisObject->uSignedLength);
    }

    if( pThisObject->pSignedData == NULL)
    {
        return FALSE;
    }

    /* create the buffer to get the signature; */
    pSignature = (PUCHAR)AnscAllocateMemory(uSignLength);

    if( pSignature == NULL)
    {
        return FALSE;
    }

    if(ANSC_STATUS_SUCCESS != 
        pCrypto->pSignData
            (
                pCrypto,
                pThisObject->pSignedData,
                pThisObject->uSignedLength,
                pThisObject->GetSignatureType(pThisObject),
                pSignature,
                &uSignLength
            ))
    {
        AnscFreeMemory(pSignature);

        return FALSE;
    }

    pStringObject = (PANSC_ASN1_BITSTRING)pThisObject->GetSignatureValue(pThisObject);

    pStringObject->SetStringValue(pStringObject, pSignature, uSignLength);

    AnscFreeMemory(pSignature);

    return TRUE;
}

ANSC_STATUS
AnscAsn1CertAddExtension
    (
        ANSC_HANDLE                 hThisObject,
        PCHAR                       pOIDValueString,
        BOOLEAN                     bCritical,
        ANSC_HANDLE                 hExtensionValue
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     = (PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_SEQUENCEOF           pExtensions;
    PANSC_ASN1_EXTENSION            pNewExtension;

    if( hThisObject == NULL || pOIDValueString == NULL || hExtensionValue == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pExtensions = (PANSC_ASN1_SEQUENCEOF)pThisObject->GetExtensionsHandle(pThisObject);

    if( pExtensions == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pNewExtension = (PANSC_ASN1_EXTENSION)
        AnscAsn1ExtensionGenerate
            (
                NULL,
                pOIDValueString,
                bCritical,
                hExtensionValue
            );

    if( pNewExtension == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    return pExtensions->AddChild(pExtensions, pNewExtension);
}

ANSC_STATUS
AnscAsn1CertAddSubjectkeyIdentifier
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     = (PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_EXTENSION            pExtension;
    PANSC_ASN1_STRING               pStrObj, pPublicKey;
    PANSC_ASN1_SEQUENCE             pPublicKeyInfo;
    ANSC_CRYPTO_HASH                hashResult;
    PANSC_CRYPTO_OBJECT             pCrypto         = NULL;
    
    if( hThisObject == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pExtension = (PANSC_ASN1_EXTENSION)
        pThisObject->FindExtensionWithType
            (
                pThisObject,
                EXTENSIONVALUE_MASK_SUBJECTKEYIDENTIFIER,
                FALSE
            );

    if( pExtension != NULL)
    {
        AnscTrace("The subject key identifier is already there.\n");

        return ANSC_STATUS_FAILURE;
    }

    /* create the sha1 hash of the public key and set it here */
    pPublicKeyInfo = (PANSC_ASN1_SEQUENCE)
        pThisObject->GetPublicKeyInfo(pThisObject);

    if( pPublicKeyInfo == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pPublicKey = (PANSC_ASN1_STRING)
        pPublicKeyInfo->GetChildByIndex(pPublicKeyInfo,1);

    if( pPublicKey == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    /* create the crypto API and get the SHA1 hash */
    pCrypto =
        (PANSC_CRYPTO_OBJECT)AnscCreateCrypto(NULL);

    if( pCrypto == NULL)
    {
        return ANSC_STATUS_RESOURCES;
    }

    hashResult.Length = ANSC_SHA1_OUTPUT_SIZE;

    pCrypto->Sha1Digest
        (
            (PVOID)pPublicKey->GetValueBuffer(pPublicKey),
            pPublicKey->uLength,
            &hashResult
        );

    pCrypto->Remove(pCrypto);

    /* create the subjectkey identifier object and set the value */
    pStrObj = AnscAsn1CreateOctetString(NULL);

    if( pStrObj == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pStrObj->SetStringValue(pStrObj, hashResult.Value, hashResult.Length);

    /* add this extension */
    return
        pThisObject->AddExtension
            (
                pThisObject,
                "2.5.29.14",
                FALSE,
                pStrObj
            );
}

ANSC_STATUS
AnscAsn1CertAddAuthorityIdentifier
    (
        ANSC_HANDLE                 hThisObject,
        PUCHAR                      pKeyIden,
        ULONG                       length
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     = (PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_EXTENSION            pExtension;
    PANSC_ASN1_SEQUENCE             pAuthObj;
    PANSC_ASN1_STRING               pStrObj;
    
    if( hThisObject == NULL || pKeyIden == NULL || length == 0)
    {
        return ANSC_STATUS_FAILURE;
    }

    pExtension = (PANSC_ASN1_EXTENSION)
        pThisObject->FindExtensionWithType
            (
                pThisObject,
                EXTENSIONVALUE_MASK_AUTHORITYKEYIDENTIFIER,
                FALSE
            );

    if( pExtension != NULL)
    {
        AnscTrace("The authority key identifier is already there.\n");

        return ANSC_STATUS_FAILURE;
    }

    /* create the authority key identifier object and set the value */
    pAuthObj = AnscAsn1CreateAuthorityKeyIdentifier(NULL);

    if( pAuthObj == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pStrObj  = (PANSC_ASN1_STRING)
        pAuthObj->GetChildByIndex(pAuthObj,0);

    if( pStrObj == NULL)
    {
        pAuthObj->AsnFree(pAuthObj);

        return ANSC_STATUS_FAILURE;
    }
    
    pStrObj->SetStringValue(pStrObj, pKeyIden, length);

    pStrObj->bOptional  = FALSE;

    /* add this extension */
    return
        pThisObject->AddExtension
            (
                pThisObject,
                "2.5.29.35",
                FALSE,
                pAuthObj
            );
}


ANSC_STATUS
AnscAsn1CertAddKeyUsage
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       ulKeyUsage
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     = (PANSC_ASN1_CERTIFICATE)hThisObject;
    UCHAR                           pValue[8]       = { 0 };
    PANSC_ASN1_EXTENSION            pExtension;
    PANSC_ASN1_STRING               pStrObj;
    
    if( hThisObject == NULL )
    {
        return ANSC_STATUS_FAILURE;
    }

    pExtension = (PANSC_ASN1_EXTENSION)
        pThisObject->FindExtensionWithType
            (
                pThisObject,
                EXTENSIONVALUE_MASK_KEYUSAGE,
                FALSE
            );

    if( pExtension != NULL)
    {
        AnscTrace("The keyusage extension is already there.\n");

        return ANSC_STATUS_FAILURE;
    }

    /* create the authority key identifier object and set the value */
    pStrObj = AnscAsn1CreateKeyUsage(NULL);

    if( pStrObj == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }
   
    pValue[0] = (UCHAR)(ulKeyUsage & 0x000000FF);

    if( ulKeyUsage > 0x000000FF)
    {
        pValue[1] = 0x80;
        pStrObj->SetStringValue(pStrObj, pValue, 2);
    }
    else
    {
        pStrObj->SetStringValue(pStrObj, pValue, 1);
    }
 
    /* add this extension */
    return
        pThisObject->AddExtension
            (
                pThisObject,
                "2.5.29.15",
                TRUE,    /* the keyusage must be critical */
                pStrObj
            );
}

ANSC_STATUS
AnscAsn1CertAddBasicConstraint
    (
        ANSC_HANDLE                 hThisObject,
        BOOLEAN                     bIsCA,
        LONG                        pathLen      /* -1 means no limit */
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     = (PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_BASICCONSTRAINTS     pBasicObj;
    PANSC_ASN1_EXTENSION            pExtension;
    PANSC_ASN1_INTEGER              pIntObj;
    PANSC_ASN1_BOOL                 pBoolObj;
    
    if( hThisObject == NULL )
    {
        return ANSC_STATUS_FAILURE;
    }

    pExtension = (PANSC_ASN1_EXTENSION)
        pThisObject->FindExtensionWithType
            (
                pThisObject,
                EXTENSIONVALUE_MASK_BASICCONSTRAINTS,
                FALSE
            );

    if( pExtension != NULL)
    {
        AnscTrace("The keyusage extension is already there.\n");

        return ANSC_STATUS_FAILURE;
    }

    /* create the basic constraints object  and set the value */
    pBasicObj = (PANSC_ASN1_BASICCONSTRAINTS)
        AnscAsn1CreateBasicConstraints(NULL);

    if( pBasicObj == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }
   
    /* set the bool value */
    pBoolObj = (PANSC_ASN1_BOOL)pBasicObj->GetChildByIndex(pBasicObj,0);
    pBoolObj->SetBooleanValue(pBoolObj, bIsCA);
    
    /* set the integer value */
    pIntObj = (PANSC_ASN1_INTEGER)
        pBasicObj->GetChildByIndex(pBasicObj,1);

    if( pathLen >= 0)
    {
        pIntObj->SetUlongValue(pIntObj, pathLen);
    }
    else
    {
        pIntObj->bOptional = TRUE;
    }
 
    /* add this extension */
    return
        pThisObject->AddExtension
            (
                pThisObject,
                "2.5.29.19",
                TRUE,    /* the BasicConstraint must be critical */
                pBasicObj
            );
}

ANSC_STATUS
AnscAsn1CertAddKerberosSubAltName
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hRealnName,
        ANSC_HANDLE                 hPrinName        
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     = (PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_GENERALNAMES         pValueObj;
    
    if( hThisObject == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pValueObj = (PANSC_ASN1_GENERALNAMES)
        pThisObject->FindExtensionWithType
            (
                pThisObject,
                EXTENSIONVALUE_MASK_SUBJECTALTNAME,
                TRUE
            );

    if( pValueObj == NULL)
    {
        /* create the subjectAltName extension and add it */
        pValueObj = (PANSC_ASN1_GENERALNAMES)
            AnscAsn1CreateGeneralNamesWithKerberosName(NULL, hRealnName, hPrinName);

        if( pValueObj == NULL)
        {
            return ANSC_STATUS_FAILURE;
        }
   
 
        /* add this extension */
        return
            pThisObject->AddExtension
                (
                    pThisObject,
                    "2.5.29.17",
                    FALSE,
                    pValueObj
                );
    }

    /* add the kb5 name */
    if( !pValueObj->AddKb5Name(pValueObj, hRealnName, hPrinName))
    {
        return ANSC_STATUS_FAILURE;
    }

    return ANSC_STATUS_SUCCESS;
}

ANSC_STATUS
AnscAsn1CertAddSubjectAltName
    (
        ANSC_HANDLE                 hThisObject,
        PCHAR                       pAltName
    )
{
    PANSC_ASN1_CERTIFICATE          pThisObject     = (PANSC_ASN1_CERTIFICATE)hThisObject;
    PANSC_ASN1_GENERALNAMES         pValueObj;
    
    if( hThisObject == NULL || pAltName == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pValueObj = (PANSC_ASN1_GENERALNAMES)
        pThisObject->FindExtensionWithType
            (
                pThisObject,
                EXTENSIONVALUE_MASK_SUBJECTALTNAME,
                TRUE
            );

    if( pValueObj == NULL)
    {
        /* create the subjectAltName extension and add it */
        pValueObj = (PANSC_ASN1_GENERALNAMES)
            AnscAsn1CreateGeneralNamesWithAltName(NULL, pAltName);

        if( pValueObj == NULL)
        {
            return ANSC_STATUS_FAILURE;
        }

        /* add this extension */
        return
            pThisObject->AddExtension
                (
                    pThisObject,
                    "2.5.29.17",
                    FALSE,
                    pValueObj
                );
    }
 
    if( !pValueObj->AddAltName(pValueObj, pAltName))
    {
        return ANSC_STATUS_FAILURE;
    }

    return ANSC_STATUS_SUCCESS;

}

/**********************************************************************

 OBJECT -- ANSC_ASN1_TBSCERTIFICATE

 TBSCertificate ::= Sequence 
     {
                           version [CON 0] Integer DEF
                      serialNumber CertificateSerialNumber 
                         signature AlgorithmIdentifier 
                            issuer Name 
                          validity Validity 
                           subject Name 
              subjectPublicKeyInfo SubjectPublicKeyInfo 
                    issuerUniqueID [CON 1] IMP UniqueIdentifier OPT
                   subjectUniqueID [CON 2] IMP UniqueIdentifier OPT
                        extensions [CON 3] Extensions OPT
     }

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreateTBSCertificate
    (
        ANSC_HANDLE                 hReserved
    )
{
    UNREFERENCED_PARAMETER(hReserved);
    PANSC_ASN1_TBSCERTIFICATE       pThisObject  = NULL;
    PANSC_ASN1_OBJECT               pChild;

    /*
     * Create the base ASN.1 object.
     */
    pThisObject = (PANSC_ASN1_TBSCERTIFICATE)
        AnscAsn1CreateSequence
            (
                (ANSC_HANDLE)sizeof(ANSC_ASN1_TBSCERTIFICATE)
            );

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject, "ANSC_ASN1_TBSCERTIFICATE");
    pThisObject->SetName(pThisObject, "TBSCertificate");

    pThisObject->Create             = AnscAsn1CreateTBSCertificate;
    pThisObject->CreateChildAttr    = AnscAsn1TBSCertificateCreateChildAttr;
    pThisObject->GetChildName       = AnscAsn1TBSCertificateGetChildName;
    pThisObject->CreateChildObject  = AnscAsn1TBSCertificateCreateChildObject;
    pThisObject->uTotalChild        = 10;

    /*
     * Create all the children
     */
    pThisObject->CreateAllChildren(pThisObject);

    /*
     *  Set some default values; 
     */
    pChild  = pThisObject->GetChildByIndex(pThisObject,8);

    if( pChild != NULL)
    {
        pChild->bOptional = TRUE;
    }

    pChild  = pThisObject->GetChildByIndex(pThisObject, 7);

    if( pChild != NULL)
    {
        pChild->bOptional = TRUE;
    }

    pChild  = pThisObject->GetChildByIndex(pThisObject,0);

    if( pChild != NULL)
    {
        ((PANSC_ASN1_INTEGER)pChild)->SetIntegerValue(pChild, 2);
    }

    return (ANSC_HANDLE)pThisObject;
}

ANSC_HANDLE
AnscAsn1TBSCertificateCreateChildObject
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    PANSC_ASN1_OBJECT               pThisObject      = NULL;
    PANSC_ASN1_SEQUENCE             pParent          = (PANSC_ASN1_SEQUENCE)hThisObject;

    switch( index )
    {

        case 0:

            pThisObject = AnscAsn1CreateInteger(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
                pThisObject->bCanBeOptional = TRUE;
                pThisObject->bOptional = TRUE;

                ((PANSC_ASN1_INTEGER)pThisObject)->SetIntegerValue(pThisObject, 2);
            }


            break;

        case 1:

            pThisObject = AnscAsn1CreateCertificateSerialNumber(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

        case 2:

            pThisObject = AnscAsn1CreateAlgorithmIdentifier(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

        case 3:

            pThisObject = AnscAsn1CreateName(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

        case 4:

            pThisObject = AnscAsn1CreateValidity(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

        case 5:

            pThisObject = AnscAsn1CreateName(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

        case 6:

            pThisObject = AnscAsn1CreateSubjectPublicKeyInfo(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

        case 7:

            pThisObject = AnscAsn1CreateUniqueIdentifier(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
                pThisObject->bCanBeOptional = TRUE;
                pThisObject->bOptional = TRUE;
            }

            break;

        case 8:

            pThisObject = AnscAsn1CreateUniqueIdentifier(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
                pThisObject->bCanBeOptional = TRUE;
                pThisObject->bOptional = TRUE;
            }

            break;

        case 9:

            pThisObject = AnscAsn1CreateExtensions(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
                pThisObject->bCanBeOptional = TRUE;
                pThisObject->bOptional = TRUE;
            }

            break;

    }

    return pThisObject;

}

PANSC_ATTR_OBJECT
AnscAsn1TBSCertificateCreateChildAttr
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    PANSC_ATTR_OBJECT               pAttrObject  = NULL;

    switch ( index )
    {
        case 0:

                pAttrObject = (PANSC_ATTR_OBJECT)
                    AnscAsn1AttrCreate
                        (
                          CONTEXT_FORM,
                          0,
                          EXPLICIT_TYPE
                        );

                break;

        case 1:
        case 2:
        case 3:
        case 4:
        case 5:
        case 6:

                break;

        case 7:

                pAttrObject = (PANSC_ATTR_OBJECT)
                    AnscAsn1AttrCreate
                        (
                          CONTEXT_FORM,
                          1,
                          IMPLICIT_TYPE
                        );

                break;

        case 8:

                pAttrObject = (PANSC_ATTR_OBJECT)
                    AnscAsn1AttrCreate
                        (
                          CONTEXT_FORM,
                          2,
                          IMPLICIT_TYPE
                        );

                break;

        case 9:

                pAttrObject = (PANSC_ATTR_OBJECT)
                    AnscAsn1AttrCreate
                        (
                          CONTEXT_FORM,
                          3,
                          EXPLICIT_TYPE
                        );

                break;

    }

    return pAttrObject;

}

PCHAR
AnscAsn1TBSCertificateGetChildName
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    switch ( index )
    {
        case 0:

            return"version";

        case 1:

            return"serialNumber";

        case 2:

            return"signature";

        case 3:

            return"issuer";

        case 4:

            return"validity";

        case 5:

            return"subject";

        case 6:

            return"subjectPublicKeyInfo";

        case 7:

            return"issuerUniqueID";

        case 8:

            return"subjectUniqueID";

        case 9:

            return"extensions";

    }

    return "";

}


/**********************************************************************

 OBJECT -- ANSC_ASN1_CERTIFICATESERIALNUMBER

 CertificateSerialNumber ::= Integer 

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreateCertificateSerialNumber
    (
        ANSC_HANDLE                 hReserved
    )
{
    PANSC_ASN1_CERTIFICATESERIALNUMBER 
                                    pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    pThisObject = (PANSC_ASN1_CERTIFICATESERIALNUMBER)
        AnscAsn1CreateInteger
            (
                hReserved
            );

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject, "ANSC_ASN1_CERTIFICATESERIALNUMBER");
    pThisObject->SetName(pThisObject, "CertificateSerialNumber");

    pThisObject->Create             = AnscAsn1CreateCertificateSerialNumber;

    return (ANSC_HANDLE)pThisObject;
}

/**********************************************************************

 OBJECT -- ANSC_ASN1_VALIDITY

 Validity ::= Sequence 
     {
                         notBefore Time 
                          notAfter Time 
     }

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreateValidity
    (
        ANSC_HANDLE                 hReserved
    )
{
    UNREFERENCED_PARAMETER(hReserved);
    PANSC_ASN1_VALIDITY             pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    pThisObject = (PANSC_ASN1_VALIDITY)
        AnscAsn1CreateSequence
            (
                (ANSC_HANDLE)sizeof(ANSC_ASN1_VALIDITY)
            );

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject, "ANSC_ASN1_VALIDITY");
    pThisObject->SetName(pThisObject, "Validity");

    pThisObject->Create             = AnscAsn1CreateValidity;
    pThisObject->CreateChildAttr    = AnscAsn1ValidityCreateChildAttr;
    pThisObject->GetChildName       = AnscAsn1ValidityGetChildName;
    pThisObject->CreateChildObject  = AnscAsn1ValidityCreateChildObject;
    pThisObject->uTotalChild        = 2;

    /*
     * Create all the children
     */
    pThisObject->CreateAllChildren(pThisObject);


    return (ANSC_HANDLE)pThisObject;
}

ANSC_HANDLE
AnscAsn1ValidityCreateChildObject
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    PANSC_ASN1_OBJECT               pThisObject      = NULL;
    PANSC_ASN1_SEQUENCE             pParent          = (PANSC_ASN1_SEQUENCE)hThisObject;

    switch( index )
    {

        case 0:

            pThisObject = AnscAsn1CreateTime(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

        case 1:

            pThisObject = AnscAsn1CreateTime(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

    }

    return pThisObject;

}

PANSC_ATTR_OBJECT
AnscAsn1ValidityCreateChildAttr
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    UNREFERENCED_PARAMETER(index);
    PANSC_ATTR_OBJECT               pAttrObject  = NULL;

    return pAttrObject;

}

PCHAR
AnscAsn1ValidityGetChildName
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    switch ( index )
    {
        case 0:

            return"notBefore";

        case 1:

            return"notAfter";

    }

    return "";
}

/**********************************************************************

 OBJECT -- ANSC_ASN1_TIME

 Time ::= Choice 
     {
                           utcTime UniversalTime 
                       generalTime GeneralizedTime 
     }

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreateTime
    (
        ANSC_HANDLE                 hReserved
    )
{
    PANSC_ASN1_TIME                 pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    if( hReserved != NULL)
    {
        pThisObject = (PANSC_ASN1_TIME)
            AnscAsn1CreateChoice
                (
                    hReserved
                );
    }
    else
    {
        pThisObject = (PANSC_ASN1_TIME)
            AnscAsn1CreateChoice
                (
                    (ANSC_HANDLE)sizeof(ANSC_ASN1_TIME)
                );
    }

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject, "ANSC_ASN1_TIME");
    pThisObject->SetName(pThisObject, "Time");

    pThisObject->Create             = AnscAsn1CreateTime;
    pThisObject->CreateSelection    = AnscAsn1TimeCreateSelection;
    pThisObject->GetSelectionName   = AnscAsn1TimeGetSelectionName;
    pThisObject->CreateSelectionAttr= AnscAsn1TimeCreateSelectionAttr;
    pThisObject->GetChoiceTagValue  = AnscAsn1TimeGetChoiceTagValue;
    pThisObject->SetTime            = AnscAsn1TimeSetTime;

    pThisObject->uTotalChoice       = TIME_MAXI_MASK + 1;
    pThisObject->bChoiceByOID       = FALSE;

    return (ANSC_HANDLE)pThisObject;
}

ANSC_HANDLE
AnscAsn1TimeCreateSelection
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    PANSC_ASN1_OBJECT               pThisObject      = NULL;
    PANSC_ASN1_CHOICE               pParent         = (PANSC_ASN1_CHOICE)hThisObject;

    switch( index )
    {

        case TIME_MASK_UTCTIME:

            pThisObject = AnscAsn1CreateUniversalTime(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateSelectionAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetSelectionName(pParent,index));
            }

            break;

        case TIME_MASK_GENERALTIME:

            pThisObject = AnscAsn1CreateGeneralizedTime(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateSelectionAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetSelectionName(pParent,index));
            }

            break;

    }

    return pThisObject;

}

PCHAR
AnscAsn1TimeGetSelectionName
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       selType
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    switch ( selType )
    {
        case TIME_MASK_UTCTIME:

            return"utcTime";

        case TIME_MASK_GENERALTIME:

            return"generalTime";

    }

    return "";

}

PANSC_ATTR_OBJECT
AnscAsn1TimeCreateSelectionAttr
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       selType
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    UNREFERENCED_PARAMETER(selType);
    PANSC_ATTR_OBJECT               pAttrObject  = NULL;

    return pAttrObject;

}

BOOLEAN
AnscAsn1TimeGetChoiceTagValue
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       uIndex,
        PASN_OBJECT_FORM_TYPE       pAttr,
        PULONG                      pTagValue
    )
{
   UNREFERENCED_PARAMETER(hThisObject);
   if( pAttr == NULL || pTagValue == NULL)
    {
        return FALSE;
    }

    switch ( uIndex )
    {
        case TIME_MASK_UTCTIME:

            *pAttr       = UNIVERSAL_FORM;
            *pTagValue   = 0x17;

            return TRUE;

        case TIME_MASK_GENERALTIME:

            *pAttr       = UNIVERSAL_FORM;
            *pTagValue   = 0x18;

            return TRUE;

    }

    return FALSE;

}

ANSC_STATUS
AnscAsn1TimeSetTime
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_UNIVERSAL_TIME         uniTime
    )
{
    PANSC_ASN1_ALTIME               pTime;
    PANSC_ASN1_TIME                 pThisObject     = (PANSC_ASN1_TIME)hThisObject;

    if( hThisObject == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pTime = (PANSC_ASN1_ALTIME)pThisObject->hSelection;

    if( pTime != NULL)
    {
        return pTime->SetUniveralTime(pTime, uniTime);
    }

    pTime = (PANSC_ASN1_ALTIME)pThisObject->CreateSelection(pThisObject, TIME_MASK_UTCTIME);

    if( pTime == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pThisObject->SetSelection(pThisObject, TIME_MASK_UTCTIME, pTime);

    return pTime->SetUniveralTime(pTime, uniTime);
}

/**********************************************************************

 OBJECT -- ANSC_ASN1_UNIQUEIDENTIFIER

 UniqueIdentifier ::= BitString 

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreateUniqueIdentifier
    (
        ANSC_HANDLE                 hReserved
    )
{
    PANSC_ASN1_UNIQUEIDENTIFIER     pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    pThisObject = (PANSC_ASN1_UNIQUEIDENTIFIER)
        AnscAsn1CreateBitString
            (
                hReserved
            );

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject, "ANSC_ASN1_UNIQUEIDENTIFIER");
    pThisObject->SetName(pThisObject, "UniqueIdentifier");

    pThisObject->Create             = AnscAsn1CreateUniqueIdentifier;

    return (ANSC_HANDLE)pThisObject;
}

/**********************************************************************

 OBJECT -- ANSC_ASN1_SUBJECTPUBLICKEYINFO

 SubjectPublicKeyInfo ::= Sequence 
     {
                         algorithm AlgorithmIdentifier 
                  subjectPublicKey BitString 
         EXTRA:
                          publicKey PublicKey 
     }

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreateSubjectPublicKeyInfo
    (
        ANSC_HANDLE                 hReserved
    )
{
    UNREFERENCED_PARAMETER(hReserved);
    PANSC_ASN1_SUBJECTPUBLICKEYINFO pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    pThisObject = (PANSC_ASN1_SUBJECTPUBLICKEYINFO)
        AnscAsn1CreateSequence
            (
                (ANSC_HANDLE)sizeof(ANSC_ASN1_SUBJECTPUBLICKEYINFO)
            );

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject, "ANSC_ASN1_SUBJECTPUBLICKEYINFO");
    pThisObject->SetName(pThisObject, "SubjectPublicKeyInfo");

    pThisObject->Create             = AnscAsn1CreateSubjectPublicKeyInfo;
    pThisObject->GetChildName       = AnscAsn1SubjectPublicKeyInfoGetChildName;
    pThisObject->CreateChildObject  = AnscAsn1SubjectPublicKeyInfoCreateChildObject;
    pThisObject->CreateExtraChild   = AnscAsn1SubjectPublicKeyInfoCreateExtraChild;
    pThisObject->GetExtraChildName  = AnscAsn1SubjectPublicKeyInfoGetExtraChildName;

    pThisObject->InitPublicKey      = AnscAsn1SubjectPublicKeyInfoInitPublicKey;
    pThisObject->GenerateKey        = AnscAsn1SubjectPublicKeyInfoGenerateKey; 
    pThisObject->Verify             = AnscAsn1SubjectPublicKeyInfoVerify;
    pThisObject->GetPublicKeyType   = AnscAsn1SubjectPublicKeyInfoGetKeyType;
    pThisObject->GetPublicKeyBits   = AnscAsn1SubjectPublicKeyInfoGetKeyBits;
    pThisObject->IsKeyMatching      = AnscAsn1SubjectPublicKeyInfoIsKeyMatching;
    pThisObject->ExportPublicKey    = AnscAsn1SubjectPublicKeyInfoExportPublicKey;

    pThisObject->uTotalChild        = 2;

    /*
     * Create all the children
     */
    pThisObject->CreateAllChildren(pThisObject);


    return (ANSC_HANDLE)pThisObject;
}

ANSC_HANDLE
AnscAsn1SubjectPublicKeyInfoCreateChildObject
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    PANSC_ASN1_OBJECT               pThisObject      = NULL;
    PANSC_ASN1_SEQUENCE             pParent          = (PANSC_ASN1_SEQUENCE)hThisObject;

    switch( index )
    {

        case 0:

            pThisObject = AnscAsn1CreateAlgorithmIdentifier(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

        case 1:

            pThisObject = AnscAsn1CreateBitString(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

    }

    return pThisObject;

}


PCHAR
AnscAsn1SubjectPublicKeyInfoGetChildName
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    switch ( index )
    {
        case 0:

            return"algorithm";

        case 1:

            return"subjectPublicKey";

    }
    return "";

}

ANSC_HANDLE
AnscAsn1SubjectPublicKeyInfoCreateExtraChild
    (
        ANSC_HANDLE                 hThisObject
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    return AnscAsn1CreatePublicKey(NULL);

}

PCHAR
AnscAsn1SubjectPublicKeyInfoGetExtraChildName
    (
        ANSC_HANDLE                 hThisObject
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    return "publicKey";
}

/*
 *  Manually added functions;
 */
BOOLEAN
AnscAsn1SubjectPublicKeyInfoInitPublicKey
    (
        ANSC_HANDLE                 hThisObject,
        PKI_KEY_TYPE                keyType,
        ANSC_HANDLE                 hKeyHandle,
        ANSC_HANDLE                 hParamHandle
    )
{
    PANSC_ASN1_SUBJECTPUBLICKEYINFO pThisObject     = (PANSC_ASN1_SUBJECTPUBLICKEYINFO)hThisObject;
    PANSC_ASN1_OBJECT               pKeyObject      = (PANSC_ASN1_OBJECT)hKeyHandle;
    PANSC_ASN1_PUBLICKEY            pPublicKey;
    PANSC_ASN1_ALGORITHMIDENTIFIER  pAlgorithm;
    PANSC_ASN1_PARAMETERS           pParams;
    PANSC_ASN1_BITSTRING            pStringObject;
    PUCHAR                          pKeyData;
    ULONG                           uLength;
    
    if( hThisObject == NULL || hKeyHandle == NULL)
    {
        return FALSE;
    }

    pAlgorithm = (PANSC_ASN1_ALGORITHMIDENTIFIER)
        pThisObject->GetChildByIndex(pThisObject,0);

    if( pAlgorithm == NULL)
    {
        return FALSE;
    }

    /*
     *  Set the OID value;
     */
    pAlgorithm->SetAlgorOIDStringValue(pAlgorithm, PKIKeyTypeToOIDString(keyType));

    /*
     *  Set the parameter handle;
     */
    if( hParamHandle != NULL)
    {
        pParams = (PANSC_ASN1_PARAMETERS)pAlgorithm->GetChildByIndex(pAlgorithm,1);
    
        if( pParams == NULL)
        {
            return FALSE;
        }

        pParams->SetSelection( pParams, pParams->lSelect, hParamHandle);
    }

    /*
     *  Set value to the bitstring;
     */
    pKeyData = pKeyObject->GetEncodedData(pKeyObject, &uLength);

    if( pKeyData != NULL)
    {
        pStringObject = (PANSC_ASN1_BITSTRING)pThisObject->GetChildByIndex(pThisObject,1);

        if( pStringObject != NULL)
        {
            pStringObject->SetStringValue
                (
                    pStringObject,
                    pKeyData,
                    uLength
                );
        }

        AnscFreeMemory(pKeyData);

        return TRUE;
    }

    /*
     *  Set the public key;
     */
    if( pKeyObject->uType == ASN1_CHOICE_TYPE)
    {
        pThisObject->SetExtraChild(pThisObject, hKeyHandle, TRUE);
    }
    else
    {
        pPublicKey = (PANSC_ASN1_PUBLICKEY)AnscAsn1CreatePublicKey(NULL);

        if( pPublicKey != NULL)
        {
            if( keyType == PKI_RSA_KEY)
            {
                pPublicKey->SetSelection
                        (
                            pPublicKey,
                            PUBLICKEY_MASK_RSAPUBLICKEY,
                            hKeyHandle
                        );
            }
            else
            {
                pPublicKey->SetSelection
                        (
                            pPublicKey,
                            PUBLICKEY_MASK_DSAPUBLICKEY,
                            hKeyHandle
                        );
            }

            pThisObject->SetExtraChild(pThisObject, pPublicKey, TRUE);
        }
    }

    return FALSE;
}

BOOLEAN
AnscAsn1SubjectPublicKeyInfoGenerateKey
    (
        ANSC_HANDLE                 hThisObject,
        PKI_KEY_TYPE                keyType,
        ANSC_HANDLE                 hKeyGenHandle
    )
{
    PANSC_ASN1_SUBJECTPUBLICKEYINFO pThisObject     = (PANSC_ASN1_SUBJECTPUBLICKEYINFO)hThisObject;
    PANSC_CRYPTO_PUB_KEY_GEN_PARAMS pGenParams      = (PANSC_CRYPTO_PUB_KEY_GEN_PARAMS)hKeyGenHandle;
    PANSC_CRYPTO_DH_PARAMETERS      pDHKey          = (PANSC_CRYPTO_DH_PARAMETERS)hKeyGenHandle;
    PANSC_ASN1_PUBLICKEY            pPublicKey;
    PANSC_ASN1_ALGORITHMIDENTIFIER  pAlgorithm;
    PANSC_ASN1_PARAMETERS           pParams;
    PANSC_ASN1_BITSTRING            pStringObject;
    PUCHAR                          pKeyData;
    ULONG                           uLength;
    PANSC_ASN1_INTEGER              pInteger;
    PANSC_ASN1_DSS_PARMS            pDSSParams;
    PANSC_ASN1_RSAPUBLICKEY         pRSA;
    PANSC_ASN1_DSAPUBLICKEY         pDSA;
    PANSC_ASN1_DHPUBLICKEY          pDH;
    PANSC_ASN1_SEQUENCE             pDomainParam;
    UCHAR                           pDHQ[512]       = { 0 };
    ULONG                           qLength         = 512;
    
    if( hThisObject == NULL || hKeyGenHandle == NULL)
    {
        return FALSE;
    }

    pAlgorithm = (PANSC_ASN1_ALGORITHMIDENTIFIER)
        pThisObject->GetChildByIndex(pThisObject,0);

    if( pAlgorithm == NULL)
    {
        return FALSE;
    }

    /*
     *  Set the OID value;
     */
    pAlgorithm->SetAlgorOIDStringValue(pAlgorithm, PKIKeyTypeToOIDString(keyType));

    if( PKI_DSA_KEY == keyType)
    {
        pParams = (PANSC_ASN1_PARAMETERS)pAlgorithm->GetChildByIndex(pAlgorithm,1);
    
        if( pParams == NULL)
        {
            return FALSE;
        }

        pDSSParams = (PANSC_ASN1_DSS_PARMS)pParams->GetSelection(pParams);

        if( pDSSParams == NULL ||
            !AnscEqualString1(pDSSParams->ClassName, "ANSC_ASN1_DSS_PARMS", FALSE))
        {
            return FALSE;
        }

        /* init the params value; */
        pInteger = (PANSC_ASN1_INTEGER)pDSSParams->GetChildByIndex(pDSSParams,0);
        pInteger->SetStringValue
            (
                pInteger,
                pGenParams->PublicKey.DSA.ParamP.Data.ucData,
                pGenParams->PublicKey.DSA.ParamP.Length
            );

        pInteger = (PANSC_ASN1_INTEGER)pDSSParams->GetChildByIndex(pDSSParams,1);
        pInteger->SetStringValue
            (
                pInteger,
                pGenParams->PublicKey.DSA.ParamQ.Data.ucData,
                pGenParams->PublicKey.DSA.ParamQ.Length
            );

        pInteger = (PANSC_ASN1_INTEGER)pDSSParams->GetChildByIndex(pDSSParams,2);
        pInteger->SetStringValue
            (
                pInteger,
                pGenParams->PublicKey.DSA.ParamG.Data.ucData,
                pGenParams->PublicKey.DSA.ParamG.Length
            );
    }
    else if( PKI_DH_KEY == keyType)
    {

        pParams = (PANSC_ASN1_PARAMETERS)pAlgorithm->GetChildByIndex(pAlgorithm,1);
    
        if( pParams == NULL)
        {
            return FALSE;
        }

        pDomainParam = (PANSC_ASN1_SEQUENCE)pParams->GetSelection(pParams);

        if( pDomainParam == NULL)
        {
            return FALSE;
        }

        /* init the params value; */
        pInteger = (PANSC_ASN1_INTEGER)pDomainParam->GetChildByIndex(pDomainParam,0);
        pInteger->SetStringValue
            (
                pInteger,
                pDHKey->GroupPrime.Data,
                pDHKey->GroupPrime.Length
            );

        pInteger = (PANSC_ASN1_INTEGER)pDomainParam->GetChildByIndex(pDomainParam,1);
        pInteger->SetStringValue
            (
                pInteger,
                pDHKey->GroupGenerator.Data.ucData,
                pDHKey->GroupGenerator.Length
            );

        /* get the param Q */
        if( PKIInitDHKeyParameterQ
            (
                pDHKey,
                pDHQ,
                &qLength
            ) == ANSC_STATUS_SUCCESS)
        {
            pInteger = (PANSC_ASN1_INTEGER)pDomainParam->GetChildByIndex(pDomainParam,2);
            pInteger->SetUnsignedStringValue
                (
                    pInteger,
                    pDHQ,
                    qLength
                );
        }

    }

    /* set value to the public key */
    pPublicKey = (PANSC_ASN1_PUBLICKEY)AnscAsn1CreatePublicKey(NULL);

    if( pPublicKey == NULL)
    {
        return FALSE;
    }

    pThisObject->SetExtraChild(pThisObject, pPublicKey, TRUE);

    if( PKI_RSA_KEY == keyType)
    {
        pRSA = (PANSC_ASN1_RSAPUBLICKEY)AnscAsn1CreateRSAPublicKey(NULL);

        if( pRSA == NULL)
        {
            return FALSE;
        }

        pRSA->InitKey
            (
                pRSA,
                hKeyGenHandle
            );

        pPublicKey->SetSelection
                (
                    pPublicKey,
                    PUBLICKEY_MASK_RSAPUBLICKEY,
                    pRSA
                );
    }
    else if( PKI_DSA_KEY == keyType)
    {
        pDSA = (PANSC_ASN1_DSAPUBLICKEY)AnscAsn1CreateDSAPublicKey(NULL);

        if( pDSA == NULL)
        {
            return FALSE;
        }

        pDSA->InitKey
            (
                pDSA,
                hKeyGenHandle
            );

        pPublicKey->SetSelection
                (
                    pPublicKey,
                    PUBLICKEY_MASK_DSAPUBLICKEY,
                    pDSA
                );
    }
    else if( PKI_DH_KEY == keyType)
    {
        pDH = (PANSC_ASN1_DHPUBLICKEY)AnscAsn1CreateDHPublicKey(NULL);

        if( pDH == NULL)
        {
            return FALSE;
        }

        pDH->InitKey
            (
                pDH,
                hKeyGenHandle
            );

        pPublicKey->SetSelection
                (
                    pPublicKey,
                    PUBLICKEY_MASK_DHPUBLICKEY,
                    pDH
                );
    }

    /*
     *  Set value to the bitstring;
     */
    pKeyData = pPublicKey->GetEncodedData(pPublicKey, &uLength);

    if( pKeyData != NULL)
    {
        pStringObject = (PANSC_ASN1_BITSTRING)pThisObject->GetChildByIndex(pThisObject,1);

        if( pStringObject != NULL)
        {
            pStringObject->SetStringValue
                (
                    pStringObject,
                    pKeyData,
                    uLength
                );
        }

        AnscFreeMemory(pKeyData);
    }

    return TRUE;
}


ANSC_STATUS
AnscAsn1SubjectPublicKeyInfoVerify
    (
        ANSC_HANDLE                 hThisObject,
        PUCHAR                      pDataSigned,
        ULONG                       lengthOfData,
        SIGNATURE_TYPE              signType,
        PUCHAR                      pSignature,
        ULONG                       uLength
    )
{
    PANSC_ASN1_SUBJECTPUBLICKEYINFO pThisObject     = (PANSC_ASN1_SUBJECTPUBLICKEYINFO)hThisObject;
    PANSC_ASN1_OBJECT               pKeyObject;
    PANSC_ASN1_ALGORITHMIDENTIFIER  pAlgor;
    PANSC_ASN1_CHOICE               pParamObj;
    ANSC_HANDLE                     hParams;
    PANSC_ASN1_BITSTRING            pStringObj;
    PANSC_ASN1_PUBLICKEY            pPublicKey;
    PUCHAR                          pBack;

    if( pThisObject == NULL || pDataSigned == NULL || pSignature == NULL || lengthOfData == 0)
    {
        return ANSC_ASN1_BAD_PARAMETER;
    }

    pAlgor     = (PANSC_ASN1_ALGORITHMIDENTIFIER)pThisObject->GetChildByIndex(pThisObject,0);
    pParamObj  = (PANSC_ASN1_CHOICE)pAlgor->GetChildByIndex(pAlgor, 1);
    hParams    = pParamObj->hSelection;

    pKeyObject = (PANSC_ASN1_OBJECT)pThisObject->pExtraChild;

    if( pKeyObject != NULL)
    {
        if( AnscEqualString1(pKeyObject->ClassName,"ANSC_ASN1_RSAPUBLICKEY",FALSE))
        {
            return ((PANSC_ASN1_RSAPUBLICKEY)pKeyObject)->Verify
                        (
                            pKeyObject,
                            hParams,
                            pDataSigned,
                            lengthOfData,
                            signType,
                            pSignature,
                            uLength
                        );

        }
        else if( AnscEqualString1(pKeyObject->ClassName,"ANSC_ASN1_DSAPUBLICKEY",FALSE))
        {
            return ((PANSC_ASN1_DSAPUBLICKEY)pKeyObject)->Verify
                        (
                            pKeyObject,
                            hParams,
                            pDataSigned,
                            lengthOfData,
                            signType,
                            pSignature,
                            uLength
                        );
        }
        else if( AnscEqualString1(pKeyObject->ClassName,"ANSC_ASN1_PUBLICKEY",FALSE))
        {
            return ((PANSC_ASN1_PUBLICKEY)pKeyObject)->Verify
                        (
                            pKeyObject,
                            hParams,
                            pDataSigned,
                            lengthOfData,
                            signType,
                            pSignature,
                            uLength
                        );
        }
    }
    else
    {
        /* decode the public key */
        pStringObj = (PANSC_ASN1_BITSTRING)pThisObject->GetChildByIndex(pThisObject,1);

        if( pStringObj->uLength <= 10)
        {
            return ANSC_ASN1_INVALID_VALUE;
        }

        /* create a new one */
        if( pStringObj->bIsDynamic)
        {
            pBack = pStringObj->pStringBuffer;
        }
        else
        {
            pBack = pStringObj->pString;
        }

        if( pThisObject->GetPublicKeyType(pThisObject) == PKI_RSA_KEY)
        {
            pKeyObject = (PANSC_ASN1_OBJECT)AnscAsn1CreateRSAPublicKey(NULL);
        }
        else
        {
            pKeyObject = (PANSC_ASN1_OBJECT)AnscAsn1CreateDSAPublicKey(NULL);
        }   

        if( pKeyObject == NULL)
        {
            return ANSC_ASN1_NO_RESOURCES;
        }

        if( pKeyObject->DecodingData(pKeyObject, (PVOID*)&pBack) != ANSC_STATUS_SUCCESS)
        {
            pKeyObject->AsnFree(pKeyObject);

            return ANSC_ASN1_INVALID_VALUE;
        }

        /* create a public key and set as extra child here */
        pPublicKey = (PANSC_ASN1_PUBLICKEY)AnscAsn1CreatePublicKey(NULL);

        if( pPublicKey != NULL)
        {
            if( pThisObject->GetPublicKeyType(pThisObject) == PKI_RSA_KEY)
            {
                pPublicKey->SetSelection
                        (
                            pPublicKey,
                            PUBLICKEY_MASK_RSAPUBLICKEY,
                            pKeyObject
                        );
            }
            else
            {
                pPublicKey->SetSelection
                        (
                            pPublicKey,
                            PUBLICKEY_MASK_DSAPUBLICKEY,
                            pKeyObject
                        );
            }

            pThisObject->SetExtraChild(pThisObject, pPublicKey, TRUE);

            return pPublicKey->Verify
                        (
                            pPublicKey,
                            hParams,
                            pDataSigned,
                            lengthOfData,
                            signType,
                            pSignature,
                            uLength
                        );
        }
        else
        {
            pKeyObject->AsnFree(pKeyObject);
            
            return ANSC_ASN1_NO_RESOURCES;
        }
    }

    return ANSC_ASN1_NOT_SUPPORTED;
}

PKI_KEY_TYPE
AnscAsn1SubjectPublicKeyInfoGetKeyType
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_SUBJECTPUBLICKEYINFO pThisObject     = (PANSC_ASN1_SUBJECTPUBLICKEYINFO)hThisObject;
    PANSC_ASN1_ALGORITHMIDENTIFIER  pAlgor;
    CHAR                            pOIDString[128] = { 0 };

    if(  pThisObject == NULL)
    {
        return PKI_KEY_RESERVED;
    }

    pAlgor = (PANSC_ASN1_ALGORITHMIDENTIFIER)pThisObject->GetChildByIndex(pThisObject,0);

    if( pAlgor == NULL)
    {
        return PKI_KEY_RESERVED;
    }

    pAlgor->GetAlgorOIDStringValue(pAlgor, pOIDString);

    return PKIOIDStringToKeyType(pOIDString);

}

ULONG
AnscAsn1SubjectPublicKeyInfoGetKeyBits
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PANSC_ASN1_SUBJECTPUBLICKEYINFO pThisObject     = (PANSC_ASN1_SUBJECTPUBLICKEYINFO)hThisObject;
    ANSC_CRYPTO_PUB_KEY_GEN_PARAMS  genParams;
    PANSC_ASN1_PUBLICKEY            pPublicKey;
    ANSC_STATUS                     retStatus;
    PKI_KEY_TYPE                    keyType;

    keyType = pThisObject->GetPublicKeyType(pThisObject);

    pPublicKey = (PANSC_ASN1_PUBLICKEY)
        pThisObject->GetExtraChild(pThisObject);

    if( pPublicKey == NULL)
    {
        return 0;
    }

    retStatus = pPublicKey->ExportPublicKey(pPublicKey, &genParams);

    if( retStatus != ANSC_STATUS_SUCCESS)
    {
        return 0;
    }

    if( keyType == PKI_DSA_KEY)
    {
        return genParams.PublicKey.DSA.ParamG.Length /8 * 64;  /* return bits */
    }
    else if( keyType == PKI_RSA_KEY)
    {
        return genParams.PublicKey.RSA.Modulus.Length /8 * 64; /* return bits */
    }

    AnscTrace("Unknown public key type.\n");

    return 0;
}

ANSC_STATUS
AnscAsn1SubjectPublicKeyInfoExportPublicKey
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hKeyGenParams
    )
{
    PANSC_ASN1_SUBJECTPUBLICKEYINFO pThisObject     = (PANSC_ASN1_SUBJECTPUBLICKEYINFO)hThisObject;
    PANSC_CRYPTO_PUB_KEY_GEN_PARAMS pGenParams      = (PANSC_CRYPTO_PUB_KEY_GEN_PARAMS)hKeyGenParams;
    PANSC_ASN1_PUBLICKEY            pPublicKey;
    ANSC_STATUS                     retStatus;
    PKI_KEY_TYPE                    keyType;
    PANSC_ASN1_ALGORITHMIDENTIFIER  pAlgor;
    PANSC_ASN1_CHOICE               pParamObj;
    PANSC_ASN1_DSS_PARMS            pDSSParams;
    PANSC_ASN1_INTEGER              pInteger;

    if( hThisObject == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    keyType = pThisObject->GetPublicKeyType(pThisObject);

    pPublicKey = (PANSC_ASN1_PUBLICKEY)
        pThisObject->GetExtraChild(pThisObject);

    if( pPublicKey == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    retStatus = pPublicKey->ExportPublicKey(pPublicKey, hKeyGenParams);

    if( retStatus != ANSC_STATUS_SUCCESS || keyType != PKI_DSA_KEY)
    {
        return retStatus;
    }

    /* init the paramters */
    pAlgor     = (PANSC_ASN1_ALGORITHMIDENTIFIER)pThisObject->GetChildByIndex(pThisObject, 0);
    pParamObj  = (PANSC_ASN1_CHOICE)pAlgor->GetChildByIndex(pAlgor, 1);
    pDSSParams = (PANSC_ASN1_DSS_PARMS)pParamObj->hSelection;

    if( pDSSParams == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }
    
    pInteger    = (PANSC_ASN1_INTEGER)pDSSParams->GetChildByIndex(pDSSParams,0);
    pGenParams->PublicKey.DSA.ParamP.Length = pInteger->uLength;
    AnscCopyMemory
        (
            pGenParams->PublicKey.DSA.ParamP.Data.ucData, 
            pInteger->pValueBuffer, 
            pInteger->uLength
        );

    pInteger    = (PANSC_ASN1_INTEGER)pDSSParams->GetChildByIndex(pDSSParams,1);
    pGenParams->PublicKey.DSA.ParamQ.Length = pInteger->uLength;
    AnscCopyMemory
        (
            pGenParams->PublicKey.DSA.ParamQ.Data.ucData, 
            pInteger->pValueBuffer, 
            pInteger->uLength
        );

    pInteger    = (PANSC_ASN1_INTEGER)pDSSParams->GetChildByIndex(pDSSParams, 2);
    pGenParams->PublicKey.DSA.ParamG.Length = pInteger->uLength;
    AnscCopyMemory
        (
            pGenParams->PublicKey.DSA.ParamG.Data.ucData, 
            pInteger->pValueBuffer, 
            pInteger->uLength
        );

    return ANSC_STATUS_SUCCESS;
}

BOOLEAN
AnscAsn1SubjectPublicKeyInfoIsKeyMatching
    (
        ANSC_HANDLE                 hThisObject,
        PKI_KEY_TYPE                keyType,
        ANSC_HANDLE                 hKeyHandle
    )
{
    PANSC_ASN1_SUBJECTPUBLICKEYINFO pThisObject     = (PANSC_ASN1_SUBJECTPUBLICKEYINFO)hThisObject;
    PANSC_ASN1_PUBLICKEY            pPublicKey;

    if( hThisObject == NULL)
    {
        return FALSE;
    }

    pPublicKey = (PANSC_ASN1_PUBLICKEY)
        pThisObject->GetExtraChild(pThisObject);

    if( pPublicKey == NULL)
    {
        return FALSE;
    }

    return pPublicKey->IsKeyMatching(pPublicKey, keyType, hKeyHandle);

}

/**********************************************************************

 OBJECT -- ANSC_ASN1_DSASIGNATURE

 DSASignature ::= Sequence 
     {
                                 r Integer 
                                 s Integer 
     }

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreateDSASignature
    (
        ANSC_HANDLE                 hReserved
    )
{
    UNREFERENCED_PARAMETER(hReserved);
    PANSC_ASN1_DSASIGNATURE         pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    pThisObject = (PANSC_ASN1_DSASIGNATURE)
        AnscAsn1CreateSequence
            (
                (ANSC_HANDLE)sizeof(ANSC_ASN1_DSASIGNATURE)
            );

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject, "ANSC_ASN1_DSASIGNATURE");
    pThisObject->SetName(pThisObject, "DSASignature");

    pThisObject->Create             = AnscAsn1CreateDSASignature;
    pThisObject->CreateChildAttr    = AnscAsn1DSASignatureCreateChildAttr;
    pThisObject->GetChildName       = AnscAsn1DSASignatureGetChildName;
    pThisObject->CreateChildObject  = AnscAsn1DSASignatureCreateChildObject;
    pThisObject->uTotalChild        = 2;

    /*
     * Create all the children
     */
    pThisObject->CreateAllChildren(pThisObject);


    return (ANSC_HANDLE)pThisObject;
}

ANSC_HANDLE
AnscAsn1DSASignatureCreateChildObject
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    PANSC_ASN1_OBJECT               pThisObject      = NULL;
    PANSC_ASN1_SEQUENCE             pParent          = (PANSC_ASN1_SEQUENCE)hThisObject;

    switch( index )
    {

        case 0:

            pThisObject = AnscAsn1CreateInteger(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

        case 1:

            pThisObject = AnscAsn1CreateInteger(NULL);

            if( pThisObject != NULL)
            {
                pThisObject->AddAttribute(pThisObject, pParent->CreateChildAttr(pParent,index), FALSE);
                pThisObject->SetName(pThisObject, pParent->GetChildName(pParent,index));
            }

            break;

    }

    return pThisObject;

}

PANSC_ATTR_OBJECT
AnscAsn1DSASignatureCreateChildAttr
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    UNREFERENCED_PARAMETER(index);
    PANSC_ATTR_OBJECT               pAttrObject  = NULL;

    return pAttrObject;

}

PCHAR
AnscAsn1DSASignatureGetChildName
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       index
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    switch ( index )
    {
        case 0:

            return"r";

        case 1:

            return"s";

    }

    return "";

}

/**********************************************************************

 OBJECT -- ANSC_ASN1_ALSTRING

 ALString ::=[UNI 15] IMP OctetString 

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreateALString
    (
        ANSC_HANDLE                 hReserved
    )
{
    PANSC_ATTR_OBJECT               pAttrObject  = NULL;
    PANSC_ASN1_ALSTRING             pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    pThisObject = (PANSC_ASN1_ALSTRING)
        AnscAsn1CreateOctetString
            (
                hReserved
            );

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject, "ANSC_ASN1_ALSTRING");
    pThisObject->SetName(pThisObject, "ALString");

    pThisObject->Create             = AnscAsn1CreateALString;

    /*
     * Add the new attribute object 
     */
    pAttrObject = (PANSC_ATTR_OBJECT)
        AnscAsn1AttrCreate
            (
              UNIVERSAL_FORM,
              15,
              IMPLICIT_TYPE
            );

    pThisObject->AddAttribute( pThisObject, pAttrObject, FALSE);

    return (ANSC_HANDLE)pThisObject;
}

/**********************************************************************

 OBJECT -- ANSC_ASN1_ATTRIBUTES

 Attributes ::= SetOf Attribute  {}

 **********************************************************************/

ANSC_HANDLE 
AnscAsn1CreateAttributes
    (
        ANSC_HANDLE                 hReserved
    )
{
    PANSC_ASN1_ATTRIBUTES           pThisObject  = NULL;

    /*
     * Create the base ASN.1 object.
     */
    pThisObject = (PANSC_ASN1_ATTRIBUTES)
        AnscAsn1CreateSetOf
            (
                hReserved
            );

    if( pThisObject == NULL)
    {
        return (ANSC_HANDLE)NULL;
    }

    /*
     * Initialize the common variables and functions for this ASN.1 object.
     */
    pThisObject->SetClassName(pThisObject, "ANSC_ASN1_ATTRIBUTES");
    pThisObject->SetName(pThisObject, "Attributes");

    pThisObject->Create             = AnscAsn1CreateAttributes;
    pThisObject->CreateChild        = AnscAsn1AttributesCreateChild;
    pThisObject->IsChildValid       = AnscAsn1AttributesIsChildValid;

    return (ANSC_HANDLE)pThisObject;
}

ANSC_HANDLE
AnscAsn1AttributesCreateChild
    (
        ANSC_HANDLE                 hThisObject,
        BOOLEAN                     bAddItIn
    )
{
    PANSC_ASN1_SETOF                pParentObj   = (PANSC_ASN1_SETOF)hThisObject;
    PANSC_ASN1_OBJECT               pThisObject  = NULL;

    pThisObject  = AnscAsn1CreateAttribute(NULL);

    if( pThisObject != NULL && bAddItIn)
    {
        pParentObj->AddChild(pParentObj,pThisObject);
    }

    return pThisObject;
}

ANSC_STATUS
AnscAsn1AttributesIsChildValid
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hChild
    )
{
    UNREFERENCED_PARAMETER(hThisObject);
    PANSC_ASN1_OBJECT               pChild    = (PANSC_ASN1_OBJECT)hChild;

    if( pChild == NULL)
    {
        return ANSC_ASN1_NULL_OBJCET;
    }

    if( !AnscEqualString1(pChild->ClassName, "ANSC_ASN1_ATTRIBUTE", TRUE))
    {
        return ANSC_ASN1_INVALID_TYPE_IN_SEQOF_OR_SETOF;
    }

    return ANSC_STATUS_SUCCESS;
}
