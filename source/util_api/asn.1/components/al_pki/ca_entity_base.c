/*
 * If not stated otherwise in this file or this component's Licenses.txt file the
 * following copyright and licenses apply:
 *
 * Copyright 2015 RDK Management
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/

/**********************************************************************
   Copyright [2014] [Cisco Systems, Inc.]
 
   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at
 
       http://www.apache.org/licenses/LICENSE-2.0
 
   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
**********************************************************************/

/**********************************************************************

    MODULE: ca_entity_base.c

        ASN.1 ANSC Code Generated by Cisco Systems, Inc.

    ---------------------------------------------------------------

    DESCRIPTION:

        This interface is for the CA entity implementation.

        *   AnscCreateCAEntity
        *   AnscCreateCAEntityWithEncoding

        *   CAEntityRemove
        *   CAEntityRemoveCRL
        *   CAEntityGetCertHandle
        *   CAEntityGetCRLHandle
        *   CAEntitySetCRLHandle
        *   CAEntityIsSameCert
        *   CAEntityVerifyChild
        *   CAEntityExportPKCS7Encode
        *   CAEntityGetCRLAddress
        *   CAEntitySetCRLAddress
        *   CAEntityGetCRLPeriod
        *   CAEntitySetCRLPeriod
        *   CAEntitySetName
        *   CAEntityGetName

    ---------------------------------------------------------------

    ENVIRONMENT:

        platform independent

    ---------------------------------------------------------------

    AUTHOR:

        Bin Zhu

    ---------------------------------------------------------------

    REVISION HISTORY:

        *   09/09/2002  initial revision
        *   07/16/2003  add function to export PKCS7 encode
        *   11/25/2003  add fields about CRL info
        *   12/01/2003  add name field support

 **********************************************************************/

#include "ansc_pki_local.h"
#include "safec_lib_common.h"

ANSC_HANDLE 
AnscCreateCAEntity
    (
        ANSC_HANDLE                 hContext,
        ANSC_HANDLE                 hReserved,
        ANSC_HANDLE                 hCertHandle
    )
{
    PCA_ENTITY                      pThisObject = NULL;
    PANSC_ASN1_CERTIFICATE          pCert       = (PANSC_ASN1_CERTIFICATE)hCertHandle;
    
    if( hCertHandle == NULL)
    {
        return NULL;
    }

    /* check the validity  */
    if( pCert->CheckValidity(pCert, TRUE) != ANSC_STATUS_SUCCESS)
    {
        AnscTrace("Unable to check the validity of this cert.\n");

        return NULL;        
    }

    if( pCert->IsSelfSigned(pCert))
    {
        if(!pCert->VerifySignature(pCert, NULL))
        {
            AnscTrace("Unable to verify the selfsigned certificate.\n");

            return NULL;
        }
    }

    /* now create the CA entity */
    if( hReserved != NULL)
    {
        pThisObject = (PCA_ENTITY)
            AnscAllocateMemory((ULONG)hReserved);                   
    }
    else
    {
        pThisObject = (PCA_ENTITY)
            AnscAllocateMemory((ULONG)sizeof(CA_ENTITY));
    }

    if( pThisObject == NULL)
    {
        return NULL;
    }

    /* init the parameters */
    pThisObject->hContainerContext  = hContext;
    pThisObject->hCertHandle        = (ANSC_HANDLE)pCert->Clone(pCert);
    pThisObject->hCRLHandle         = NULL;
    pThisObject->uCRLPeriodInHours  = 0;      
    pThisObject->uLastCRLTime       = 0;

    pThisObject->Remove             = CAEntityRemove;
    pThisObject->RemoveCRL          = CAEntityRemoveCRL;
    pThisObject->GetCertHandle      = CAEntityGetCertHandle;
    pThisObject->GetCRLHandle       = CAEntityGetCRLHandle;
    pThisObject->SetCRLHandle       = CAEntitySetCRLHandle;
    pThisObject->IsSameCert         = CAEntityIsSameCert;
    pThisObject->VerifyChild        = CAEntityVerifyChild;
    pThisObject->ExportPkcs7Encode  = CAEntityExportPKCS7Encode;
    pThisObject->GetCRLAddress      = CAEntityGetCRLAddress;
    pThisObject->SetCRLAddress      = CAEntitySetCRLAddress;
    pThisObject->GetCRLPeriod       = CAEntityGetCRLPeriod;
    pThisObject->SetCRLPeriod       = CAEntitySetCRLPeriod;
    pThisObject->SetName            = CAEntitySetName;
    pThisObject->GetName            = CAEntityGetName;

    AnscZeroMemory(pThisObject->pCRLAddress, MAXI_CRL_URL_LENGTH);
    AnscZeroMemory(pThisObject->pName, MAXI_ENTITY_NAME_BUFFER);

    /* init the cert encoding */
    pThisObject->pCertEncoding = 
        pCert->GetEncodedData
            (
                pCert,
                &pThisObject->uLength
            );


    return pThisObject;
}

ANSC_HANDLE 
AnscCreateCAEntityWithEncoding
    (
        ANSC_HANDLE                 hContext,
        ANSC_HANDLE                 hReserved,
        PUCHAR                      pEncodingCert,
        ULONG                       length
    )
{
    PCA_ENTITY                      pThisObject = NULL;
    PANSC_ASN1_CERTIFICATE          pCert       = NULL;
    PUCHAR                          pBack       = pEncodingCert;
    
    if( pEncodingCert == NULL || length == 0)
    {
        return NULL;
    }

    if(!AnscCheckAsn1Validity(pEncodingCert, length))
    {
        AnscTrace("Invalid ASN1 encoding.\n");

        return NULL;
    }

    /* create the certificate first */
    pCert = (PANSC_ASN1_CERTIFICATE)
        AnscAsn1CreateCertificate(NULL);

    if( pCert == NULL)
    {
        return NULL;
    }

    if( ANSC_STATUS_SUCCESS != pCert->DecodingData(pCert, (PVOID*)&pBack))
    {
        pCert->AsnFree(pCert);
        return NULL;
    }

    /* check the validity  */
    if( pCert->CheckValidity(pCert, FALSE) != ANSC_STATUS_SUCCESS)
    {
        AnscTrace("Unable to check the validity of this cert.\n");

        pCert->AsnFree(pCert);

        return NULL;        
    }

    if( pCert->IsSelfSigned(pCert))
    {
        if(!pCert->VerifySignature(pCert, NULL))
        {
            AnscTrace("Unable to verify the selfsigned certificate.\n");

            pCert->AsnFree(pCert);

            return NULL;
        }
    }


    /* create the object */
    if( hReserved != NULL)
    {
        pThisObject = (PCA_ENTITY)
            AnscAllocateMemory((ULONG)hReserved);                   
    }
    else
    {
        pThisObject = (PCA_ENTITY)
            AnscAllocateMemory((ULONG)sizeof(CA_ENTITY));
    }

    if( pThisObject == NULL)
    {
        pCert->AsnFree(pCert);
        return NULL;
    }

    /* init the parameters */
    pThisObject->hContainerContext  = hContext;
    pThisObject->hCertHandle        = (ANSC_HANDLE)pCert;
    pThisObject->hCRLHandle         = NULL;

    pThisObject->Remove             = CAEntityRemove;
    pThisObject->RemoveCRL          = CAEntityRemoveCRL;
    pThisObject->GetCertHandle      = CAEntityGetCertHandle;
    pThisObject->GetCRLHandle       = CAEntityGetCRLHandle;
    pThisObject->SetCRLHandle       = CAEntitySetCRLHandle;
    pThisObject->IsSameCert         = CAEntityIsSameCert;
    pThisObject->VerifyChild        = CAEntityVerifyChild;
    pThisObject->ExportPkcs7Encode  = CAEntityExportPKCS7Encode;
    pThisObject->GetCRLAddress      = CAEntityGetCRLAddress;
    pThisObject->SetCRLAddress      = CAEntitySetCRLAddress;
    pThisObject->GetCRLPeriod       = CAEntityGetCRLPeriod;
    pThisObject->SetCRLPeriod       = CAEntitySetCRLPeriod;
    pThisObject->SetName            = CAEntitySetName;
    pThisObject->GetName            = CAEntityGetName;

    /* make a copy of the cert encoding */    
    pThisObject->uLength       = length;
    pThisObject->pCertEncoding = (PUCHAR)AnscAllocateMemory(length);

    if( pThisObject->pCertEncoding != NULL)
    {
        AnscCopyMemory
            (
                pThisObject->pCertEncoding,
                pEncodingCert,
                length
            );
    }

    return pThisObject;
}

/********************************************************************
 *
 * Other functions
 *
 ********************************************************************/
ANSC_STATUS
CAEntityRemove
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PCA_ENTITY                      pThisObject = (PCA_ENTITY)hThisObject;
    PANSC_ASN1_CERTIFICATE          pCert;
    PANSC_ASN1_CRL                  pCRL;

    if( hThisObject == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    /* check the cert handle */
    if( pThisObject->hCertHandle != NULL)
    {
        pCert = (PANSC_ASN1_CERTIFICATE)
            pThisObject->hCertHandle;

        pCert->AsnFree(pCert);

    }

    /* check the crl handle */
    if( pThisObject->hCRLHandle != NULL)
    {
        pCRL = (PANSC_ASN1_CRL)
            pThisObject->hCRLHandle;

        pCRL->AsnFree(pCRL);
    }

    /* check the cert encoding */
    if( pThisObject->pCertEncoding != NULL)
    {
        AnscFreeMemory(pThisObject->pCertEncoding);
    }

    AnscFreeMemory(hThisObject);

    return ANSC_STATUS_SUCCESS;
}

ANSC_STATUS
CAEntityRemoveCRL
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PCA_ENTITY                      pThisObject = (PCA_ENTITY)hThisObject;
    PANSC_ASN1_CRL                  pCRL;

    if( hThisObject == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    /* check the crl handle */
    if( pThisObject->hCRLHandle != NULL)
    {
        pCRL = (PANSC_ASN1_CRL)
            pThisObject->hCRLHandle;

        pCRL->AsnFree(pCRL);

        /* reset the pointer, otherwise it will crash when set a new CRL */
        pThisObject->hCRLHandle = NULL;
    }

    return ANSC_STATUS_SUCCESS;
}

/**************************************************************
 * Get certain handle
 **************************************************************/
ANSC_HANDLE
CAEntityGetCertHandle
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PCA_ENTITY                      pThisObject = (PCA_ENTITY)hThisObject;

    return pThisObject->hCertHandle;
}

ANSC_HANDLE
CAEntityGetCRLHandle
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PCA_ENTITY                      pThisObject = (PCA_ENTITY)hThisObject;

    return pThisObject->hCRLHandle;
}

/**************************************************************
 * Set certain handle
 **************************************************************/
ANSC_STATUS
CAEntitySetCRLHandle
    (
        ANSC_HANDLE                 hThisObject,
        PUCHAR                      pEncodingCert,
        ULONG                       length
    )
{
    PCA_ENTITY                      pThisObject = (PCA_ENTITY)hThisObject;
    PANSC_ASN1_CRL                  pCRL;
    PANSC_ASN1_CERTIFICATE          pCert;
    ANSC_STATUS                     retStatus;
    PUCHAR                          pBackEncoding;
    ANSC_UNIVERSAL_TIME             clockTime;

    if( hThisObject == NULL || pEncodingCert == NULL || length == 0)
    {
        return ANSC_STATUS_FAILURE;
    }

    if( pThisObject->hCertHandle == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    pCert = (PANSC_ASN1_CERTIFICATE)pThisObject->hCertHandle;

    if(!AnscCheckAsn1Validity(pEncodingCert, length))
    {
        AnscTrace("Invalid ASN1 encoding.\n");

        return ANSC_ASN1_INVALID_ENCODE_LENGTH;
    }

    /* create the crl */
    pCRL = (PANSC_ASN1_CRL)AnscAsn1CreateCRL(NULL);

    if( pCRL == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    /* decoding the data */
    pBackEncoding = pEncodingCert;

    retStatus = 
        pCRL->DecodingData(pCRL, (PVOID*)&pBackEncoding);

    if( retStatus != ANSC_STATUS_SUCCESS)
    {
        pCRL->AsnFree(pCRL);

        return retStatus;
    }
    
    /* verify it */
    if( !pCRL->Verify
            (
                pCRL,
                pCert->GetPublicKeyInfo(pCert)
            )
      )
    {
        pCRL->AsnFree(pCRL);

        return ANSC_ASN1_FAILED_TO_VERIFY;        
    }

    /* add the crl */
    if( pThisObject->hCRLHandle != NULL)
    {
        /* free the old one if have */
        ((PANSC_ASN1_CRL)pThisObject->hCRLHandle)->
            AsnFree(pThisObject->hCRLHandle);
    }

    pThisObject->hCRLHandle = pCRL;

    /* update the CRL update time */
    AnscGetLocalTime(&clockTime);

    pThisObject->uLastCRLTime = AnscCalendarToSecond(&clockTime);

    return ANSC_STATUS_SUCCESS;
}


/**************************************************************
 * other functions
 **************************************************************/
BOOLEAN
CAEntityIsSameCert
    (
        ANSC_HANDLE                 hThisObject,
        PUCHAR                      pEncodingCert,
        ULONG                       length
    )
{
    PCA_ENTITY                      pThisObject = (PCA_ENTITY)hThisObject;

    if( hThisObject == NULL || pEncodingCert == NULL || length == 0)
    {
        return FALSE;
    }
    
    if( pThisObject->uLength != length)
    {
        return FALSE;
    }

    return
        AnscEqualMemory
            (
                pThisObject->pCertEncoding,
                pEncodingCert,
                length
            );
}

ANSC_STATUS
CAEntityVerifyChild
    (
        ANSC_HANDLE                 hThisObject,
        ANSC_HANDLE                 hChildCert,
        ULONG                       pathIndex,
        BOOLEAN                     bCheckCRLOnly
    )
{
    PCA_ENTITY                      pThisObject = (PCA_ENTITY)hThisObject;
    PANSC_ASN1_CERTIFICATE          pChild      = (PANSC_ASN1_CERTIFICATE)hChildCert;
    PANSC_ASN1_CERTIFICATE          pCert;
    PANSC_ASN1_CRL                  pCRL;

    if( hThisObject == NULL  || hChildCert == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    /* check it revoked or not */
    pCRL = (PANSC_ASN1_CRL)pThisObject->hCRLHandle;

    if( pCRL != NULL)
    {
        if( pCRL->IsCertRevoked
                (
                    pCRL,
                    pChild->GetSerialNumber(pChild)
                )
           )
        {
            AnscTrace("The certificate is revoked.\n");
            return ANSC_ASN1_CERT_REVOKED;
        }
    }

    if( bCheckCRLOnly)
    {
        return ANSC_STATUS_SUCCESS;
    }

    pCert = (PANSC_ASN1_CERTIFICATE)pThisObject->hCertHandle;

    if( pCert == NULL)
    {
        return ANSC_STATUS_FAILURE;
    }

    /* check the path valid or not */
    if( !pCert->IsPathLengthValid(pCert, pathIndex))
    {
        AnscTrace("The cert path '%lu' is invalid.\n", pathIndex);
        return ANSC_STATUS_FAILURE;
    }

    /* verify other information */

    return 
        pCert->VerifyChildCert
            (
                pCert,
                hChildCert
            );
}

PUCHAR
CAEntityExportPKCS7Encode
    (
        ANSC_HANDLE                 hThisObject,
        PULONG                      pLength
    )
{
    PCA_ENTITY                      pThisObject = (PCA_ENTITY)hThisObject;
    PANSC_ASN1_CERTIFICATE          pCert       = (PANSC_ASN1_CERTIFICATE)pThisObject->hCertHandle;
    PUCHAR                          pEncoding   = NULL;
    PANSC_ASN1_CONTENTINFO          pInfo       = NULL;
    PANSC_ASN1_SIGNEDDATA           pSignedData = NULL;

    if( pCert == NULL)
    {
        return pEncoding;
    }

    /* create the signed data */
    pSignedData = (PANSC_ASN1_SIGNEDDATA)AnscAsn1CreateSignedData(NULL);

    if( pSignedData == NULL)
    {
        return pEncoding;
    }

    pSignedData->AddCertificate
        (
            pSignedData, 
            pCert->Clone(pCert),
            NULL,
            NULL,
            HASH_SHA1
        );

    /* create the pkcs7 content info */
    pInfo = (PANSC_ASN1_CONTENTINFO)AnscAsn1CreateContentInfo(NULL);

    if( pInfo == NULL)
    {
        pSignedData->AsnFree(pSignedData);

        return pEncoding;
    }
            
    pInfo->SetTypeAndData
        (
            pInfo,
            CONTENTDATA_MASK_SIGNEDDATA,
            pSignedData
        );

    pEncoding = pInfo->GetEncodedData(pInfo, pLength);

    pInfo->AsnFree(pInfo);

    return pEncoding;
}

PCHAR
CAEntityGetCRLAddress
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PCA_ENTITY                      pThisObject = (PCA_ENTITY)hThisObject;

    return pThisObject->pCRLAddress;
}

ANSC_STATUS
CAEntitySetCRLAddress
    (
        ANSC_HANDLE                 hThisObject,
        PCHAR                       pString
    )
{
    PCA_ENTITY                      pThisObject = (PCA_ENTITY)hThisObject;
    errno_t                         rc          = -1;

    if( pString == NULL)
    {
        AnscZeroMemory(pThisObject->pCRLAddress, MAXI_CRL_URL_LENGTH);
        return ANSC_STATUS_FAILURE;
    }
    /*CID: 68139 Dereference after null check*/
    if( AnscSizeOfString(pString) >= MAXI_CRL_URL_LENGTH)
    {
        return ANSC_STATUS_FAILURE;
    }

    rc = strcpy_s(pThisObject->pCRLAddress, sizeof(pThisObject->pCRLAddress), pString);
    ERR_CHK(rc);

    return ANSC_STATUS_SUCCESS;
}

ULONG
CAEntityGetCRLPeriod
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PCA_ENTITY                      pThisObject = (PCA_ENTITY)hThisObject;

    return pThisObject->uCRLPeriodInHours;
}

void
CAEntitySetCRLPeriod
    (
        ANSC_HANDLE                 hThisObject,
        ULONG                       uValue
    )
{
    PCA_ENTITY                      pThisObject = (PCA_ENTITY)hThisObject;

    pThisObject->uCRLPeriodInHours = uValue;
}

PCHAR
CAEntityGetName
    (
        ANSC_HANDLE                 hThisObject
    )
{
    PCA_ENTITY                      pThisObject = (PCA_ENTITY)hThisObject;

    return pThisObject->pName;
}

ANSC_STATUS
CAEntitySetName
    (
        ANSC_HANDLE                 hThisObject,
        PCHAR                       pString
    )
{
    PCA_ENTITY                      pThisObject = (PCA_ENTITY)hThisObject;
    errno_t                         rc          = -1;

    if( pString == NULL)
    {
        AnscZeroMemory(pThisObject->pName, MAXI_ENTITY_NAME_BUFFER);
	return ANSC_STATUS_FAILURE;
    }

    /*CID: 74530 Dereference after null check*/
    if( AnscSizeOfString(pString) >= MAXI_ENTITY_NAME_BUFFER)
    {
        return ANSC_STATUS_FAILURE;
    }

    rc = strcpy_s(pThisObject->pName, sizeof(pThisObject->pName), pString);
    ERR_CHK(rc);

    return ANSC_STATUS_SUCCESS;
}
